<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å ´éŠ·è²¨</title>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #f4f4f9; }
        .card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .near-expiry { color: red; font-weight: bold; }
        .btn-consume { background: #eb5757; color: white; border: none; padding: 8px 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="locTitle">ğŸ“ æ­£åœ¨å®šä½...</h2>
        <select id="manualLoc" onchange="loadList(this.value)" style="width:100%; padding:8px;">
            <option value="">æˆ–æ‰‹å‹•é¸åœ°é»...</option>
        </select>
    </div>

    <div id="stockList"></div>

    <script>
        async function detect() {
            const { data: locs } = await supabase.from('locations').select('*');
            const select = document.getElementById('manualLoc');
            locs.forEach(l => select.add(new Option(l.name, l.name)));

            // åº§æ¨™å®šä½
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude: lat, longitude: lng } = pos.coords;
                const found = locs.find(l => getDistance(lat, lng, l.lat, l.lng) < (l.radius || 500));
                if(found) {
                    document.getElementById('locTitle').innerText = "ğŸ“ ç›®å‰ä½ç½®ï¼š" + found.name;
                    loadList(found.name);
                } else {
                    document.getElementById('locTitle').innerText = "ğŸ“ ç„¡æ³•åˆ¤å®šåœ°é»ï¼Œè«‹æ‰‹å‹•é¸æ“‡";
                }
            }, () => {
                document.getElementById('locTitle').innerText = "ğŸ“ GPS æœªé–‹å•Ÿ";
            });
        }

        async function loadList(locName) {
            if(!locName) return;
            const { data: items } = await supabase.from('inventory_summary')
                .select('*').eq('location', locName).gt('current_stock', 0)
                .order('expiry_date', { ascending: true });

            document.getElementById('stockList').innerHTML = items.map(i => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <b>${i.item_uuid.substring(0,12)}</b><br>
                        <small class="${isNear(i.expiry_date) ? 'near-expiry' : ''}">
                            æ•ˆæœŸ: ${i.expiry_date}
                        </small> (é¤˜ ${i.current_stock})
                    </div>
                    <button class="btn-consume" onclick="doConsume('${i.item_uuid}', '${locName}')">éŠ·å¸³ -1</button>
                </div>
            `).join('') || "æ­¤åœ°ç›®å‰ç„¡è²¨ç‰©";
        }

        async function doConsume(uuid, loc) {
            if(!confirm('ç¢ºèªéŠ·è²¨ï¼Ÿ')) return;
            await fetch('/api/stock', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ item_uuid: uuid, from_loc: loc, to_loc: 'CONSUMED', operator: 'ç¾å ´éŠ·è²¨' })
            });
            alert('âœ… å·²æˆåŠŸæ‰£é™¤ï¼Œç³»çµ±å·²è‡ªå‹•éŠ·å¸³');
            loadList(loc);
        }

        function isNear(dateStr) {
            const exp = new Date(dateStr);
            const today = new Date();
            return (exp - today) / (1000*60*60*24) < 30; // 30å¤©å…§è®Šç´…
        }

        // Haversine è·é›¢å…¬å¼ (ç•¥ï¼ŒåŒä¹‹å‰ä»£ç¢¼)
        detect();
    </script>
</body>
</html>