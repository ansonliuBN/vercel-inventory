<style>
    .flex-grid { display: flex; gap: 20px; flex-wrap: wrap; }
    .side-panel { background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee; flex: 1; min-width: 350px; }
    .fix-item-card { background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
</style>

<div class="flex-grid">
    <div class="side-panel" style="max-width: 450px;">
        <h3>ğŸ“ åœ°é»å‚™è¨»ç®¡ç†</h3>
        <p>åµæ¸¬ä½ç½®ï¼š<b id="cur-loc" style="color:var(--primary);">è¼‰å…¥ä¸­...</b></p>
        <select id="loc-sel" style="width:100%; padding:10px;" onchange="sync()"></select>
        <textarea id="note-in" style="width:100%; height:100px; margin-top:15px;" placeholder="å¯«ä¸‹è¦æé†’æ¥­å‹™çš„è³‡è¨Š..."></textarea>
        <button onclick="saveNote()" style="width:100%; background:var(--primary); color:white; padding:12px; border:none; border-radius:8px; margin-top:10px;">å„²å­˜æé†’</button>
    </div>

    <div class="side-panel">
        <h3>âš½ é†«é™¢å›ºå®šåº«å­˜ (æ„Ÿå…‰çƒ / Fiducial)</h3>
        <div id="fix-list"></div>
        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <input type="text" id="new-item-name" placeholder="æ–°å¢å“å (å¦‚: Skin Fiducial)" style="width:60%; padding:8px;">
            <button onclick="addFixItem()" style="padding:8px 15px;">+ æ–°å¢</button>
        </div>
    </div>
</div>

<script>
    // åŒæ­¥åœ°é»èˆ‡å›ºå®šåº«å­˜
    async function sync() {
        const loc = document.getElementById('loc-sel').value;
        document.getElementById('cur-loc').innerText = loc;
        
        // è¼‰å…¥å‚™è¨»
        const { data: lData } = await _supabase.from('locations').select('note').eq('name', loc).single();
        document.getElementById('note-in').value = lData?.note || '';

        // è¼‰å…¥å›ºå®šå“
        loadFixItems(loc);
    }

    async function loadFixItems(loc) {
        const { data } = await _supabase.from('hospital_stock').select('*').eq('location_name', loc);
        document.getElementById('fix-list').innerHTML = data.map(d => `
            <div class="fix-item-card">
                <div>
                    <b>${d.item_name}</b><br>
                    <small style="color:#999;">æ›´æ–°: ${new Date(d.updated_at).toLocaleString('zh-TW', {hour12:false})}</small>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="number" value="${d.quantity}" onchange="updateQty('${d.id}', this.value)" style="width:50px; padding:5px;">
                    <button onclick="delFix('${d.id}')" style="color:red; background:none; border:none;">ğŸ—‘ï¸</button>
                </div>
            </div>
        `).join('') || "ç›®å‰ç„¡å›ºå®šåº«å­˜ç´€éŒ„";
    }
</script>