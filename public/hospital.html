<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #f4f7f9; }
        .flex-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .panel { background: white; padding: 20px; border-radius: 12px; flex: 1; min-width: 320px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .loc-box { background: #e7f3ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #b3d7ff; }
        .stock-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .stock-row b { color: #333; }
        input[type="number"] { width: 60px; padding: 5px; text-align: center; }
        input[type="text"] { width: 80px; padding: 5px; }
        button.save { background: #007bff; color: white; border: none; padding: 10px; border-radius: 5px; width: 100%; cursor: pointer; }
    </style>
</head>
<body>
    <div class="flex-container">
        <div class="panel">
            <h3>ğŸ“ ä½ç½®èˆ‡æé†’è¨­å®š</h3>
            <div class="loc-box">
                <label>ç›®å‰åµæ¸¬ï¼š</label> <b id="cur-loc">å®šä½ä¸­...</b>
                <select id="loc-sel" style="width:100%; margin-top:5px;" onchange="sync()"></select>
            </div>
            <label>ğŸ“ æ’¥è£œ/é ˜ç”¨æé†’ï¼š</label>
            <textarea id="note-in" style="width:100%; height:120px; margin-top:10px; padding:10px; box-sizing:border-box;" placeholder="è¼¸å…¥è¦æé†’æ¥­å‹™çš„è©±..."></textarea>
            <button class="save" onclick="saveNote()" style="margin-top:10px;">å„²å­˜å‚™è¨»</button>
        </div>

        <div class="panel">
            <h3>âš½ é†«é™¢å›ºå®šåº«å­˜ (å…§å»ºå“)</h3>
            <div id="fix-list">
                </div>
            <hr>
            <h4>â• æ–°å¢å…¶ä»–è€—æ</h4>
            <div style="display:flex; gap:5px;">
                <input type="text" id="new-name" placeholder="å“å" style="flex:2;">
                <input type="text" id="new-unit" placeholder="å–®ä½(å€‹/åŒ…)" style="flex:1;">
                <button onclick="addFixItem()">æ–°å¢</button>
            </div>
        </div>
    </div>

<script>
    const builtIn = ['æ„Ÿå…‰çƒ (Sensory Balls)', 'Skin Fiducial'];
    
    async function init() {
        const { data: locs } = await _supabase.from('locations').select('*');
        const sel = document.getElementById('loc-sel');
        locs.forEach(l => sel.add(new Option(l.name, l.name)));

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const nearest = await findNearest(pos.coords.latitude, pos.coords.longitude, locs);
            if(nearest) {
                sel.value = nearest.name;
                sync();
            }
        });
    }

    async function sync() {
        const loc = document.getElementById('loc-sel').value;
        document.getElementById('cur-loc').innerText = loc;
        
        // æŠ“å‚™è¨»
        const { data: lData } = await _supabase.from('locations').select('note').eq('name', loc).single();
        document.getElementById('note-in').value = lData?.note || '';

        // æŠ“å›ºå®šåº«å­˜
        loadStock(loc);
    }

    async function loadStock(loc) {
        const { data } = await _supabase.from('hospital_stock').select('*').eq('location_name', loc);
        const container = document.getElementById('fix-list');
        
        // å…§å»ºå“é‚è¼¯ï¼šä¸ç®¡è³‡æ–™åº«æœ‰æ²’æœ‰ï¼Œé€™å…©å€‹éƒ½è¦å‡ºç¾
        let html = builtIn.map(name => {
            const dbItem = data?.find(d => d.item_name === name);
            return renderRow(name, dbItem?.quantity || 0, dbItem?.unit || 'å€‹', dbItem?.id, dbItem?.updated_at);
        }).join('');

        // åŠ ä¸Šå…¶ä»–è‡ªå®šç¾©å“é …
        const otherItems = data?.filter(d => !builtIn.includes(d.item_name));
        html += otherItems.map(d => renderRow(d.item_name, d.quantity, d.unit, d.id, d.updated_at)).join('');
        
        container.innerHTML = html;
    }

    function renderRow(name, qty, unit, id, time) {
        return `
            <div class="stock-row">
                <div>
                    <b>${name}</b><br>
                    <small style="color:#999">${time ? new Date(time).toLocaleString() : 'å°šæœªæ›´æ–°'}</small>
                </div>
                <div>
                    <input type="number" value="${qty}" onchange="updateQty('${name}', this.value, '${unit}')"> ${unit}
                </div>
            </div>
        `;
    }

    async function updateQty(name, qty, unit) {
        const loc = document.getElementById('loc-sel').value;
        // ä½¿ç”¨ upsert: æœ‰å‰‡æ›´æ–°ï¼Œç„¡å‰‡æ–°å¢
        const { error } = await _supabase.from('hospital_stock').upsert({
            location_name: loc,
            item_name: name,
            quantity: qty,
            unit: unit,
            updated_at: new Date()
        }, { onConflict: 'location_name, item_name' });
        
        if(!error) loadStock(loc);
    }

    async function saveNote() {
        const loc = document.getElementById('loc-sel').value;
        await _supabase.from('locations').update({ note: document.getElementById('note-in').value }).eq('name', loc);
        alert("å‚™è¨»å·²å„²å­˜");
    }

    async function findNearest(lat, lng, locs) {
        return locs.map(l => ({ ...l, d: Math.pow(l.lat-lat,2)+Math.pow(l.lng-lng,2) })).sort((a,b)=>a.d-b.d)[0];
    }
    init();
</script>
</body>
</html>