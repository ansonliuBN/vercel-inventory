<!DOCTYPE html>
<html>
<body>
    <h3>ğŸ¥ é†«é™¢ç®¡ç†ä¸­å¿ƒ</h3>
    <div style="background:#f4f4f4; padding:15px; border-radius:10px;">
        <p>ğŸ“ ç›®å‰ä½ç½®ï¼š<b id="loc-display">å®šä½ä¸­...</b></p>
        <select id="loc-select"></select>
        <hr>
        <label>ğŸ“ åœ°é»æé†’è¨­å®šï¼š</label>
        <textarea id="note-input" style="width:100%; height:80px;"></textarea>
        <button onclick="saveNote()" style="background:#27ae60; color:white; width:100%; padding:10px; margin-top:10px;">å„²å­˜æé†’</button>
        <button onclick="deleteNote()" style="background:#666; color:white; width:100%; padding:5px; margin-top:5px;">åˆªé™¤æé†’</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script>
        async function init() {
            // 1. æŠ“åœ°é»é¸å–®
            const { data: locs } = await window._supabase.from('locations').select('*');
            const select = document.getElementById('loc-select');
            locs.forEach(l => select.add(new Option(l.name, l.name)));

            // 2. è‡ªå‹•å®šä½
            navigator.geolocation.getCurrentPosition(async pos => {
                const nearest = await findNearestLocation(pos.coords.latitude, pos.coords.longitude);
                if (nearest) {
                    document.getElementById('loc-display').innerText = nearest.name;
                    select.value = nearest.name;
                    document.getElementById('note-input').value = nearest.note || '';
                }
            });
        }

        async function saveNote() {
            const name = document.getElementById('loc-select').value;
            const note = document.getElementById('note-input').value;
            await window._supabase.from('locations').update({ note }).eq('name', name);
            alert("å„²å­˜æˆåŠŸï¼");
        }

        async function deleteNote() {
            const name = document.getElementById('loc-select').value;
            await window._supabase.from('locations').update({ note: null }).eq('name', name);
            document.getElementById('note-input').value = '';
            alert("å·²æ¸…é™¤ï¼");
        }
        init();
    </script>
</body>
</html>