<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f7f9; }
        .flex-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .side-panel { background: white; padding: 20px; border-radius: 12px; flex: 1; min-width: 320px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .loc-tag { background: #e7f3ff; padding: 12px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #b3d7ff; }
        .item-card { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .item-card:last-child { border-bottom: none; }
        input[type="number"] { width: 50px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
        input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="flex-row">
        <div class="side-panel" style="max-width: 450px;">
            <h3>ğŸ“ ä½ç½®èˆ‡æé†’ç®¡ç†</h3>
            <div class="loc-tag">
                ç›®å‰å®šä½ï¼š<b id="cur-loc" style="color:#007bff;">åµæ¸¬ä¸­...</b>
                <select id="loc-sel" style="width:100%; margin-top:10px; padding:8px;" onchange="sync()"></select>
            </div>
            <label>ğŸ“ æ’¥è£œ/é ˜ç”¨æé†’äº‹é …ï¼š</label>
            <textarea id="note-in" style="width:100%; height:120px; margin-top:10px; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;"></textarea>
            <button onclick="saveNote()" style="width:100%; background:#007bff; color:white; border:none; padding:12px; border-radius:8px; margin-top:10px; font-weight:bold; cursor:pointer;">å„²å­˜å‚™è¨»</button>
        </div>

        <div class="side-panel">
            <h3>âš½ é†«é™¢å›ºå®šåº«å­˜ (æ„Ÿå…‰çƒ / Fiducial)</h3>
            <div id="fix-list"></div>
            <div style="margin-top:20px; padding-top:15px; border-top:2px dashed #eee;">
                <label style="font-size:13px; color:#999;">æ–°å¢å…¶ä»–è€—æï¼š</label>
                <div style="display:flex; gap:8px; margin-top:8px;">
                    <input type="text" id="new-name" placeholder="å“å" style="flex:2;">
                    <input type="text" id="new-unit" placeholder="å–®ä½" value="å€‹" style="flex:1;">
                    <button onclick="addOther()" style="padding:8px 15px;">æ–°å¢</button>
                </div>
            </div>
        </div>
    </div>

<script>
    const builtInNames = ['æ„Ÿå…‰çƒ (Sensory Balls)', 'Skin Fiducial'];

    async function init() {
        const { data: locs } = await _supabase.from('locations').select('*');
        const sel = document.getElementById('loc-sel');
        locs.forEach(l => sel.add(new Option(l.name, l.name)));

        // ä½¿ç”¨èˆ‡é ˜ç”¨é é¢ä¸€è‡´çš„å®šä½é‚è¼¯
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const nearest = await window.findNearestLocation(pos.coords.latitude, pos.coords.longitude);
                if (nearest) {
                    sel.value = nearest.name;
                    sync();
                }
            }, () => { document.getElementById('cur-loc').innerText = "å®šä½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸æ“‡"; });
        }
    }

    async function sync() {
        const locName = document.getElementById('loc-sel').value;
        document.getElementById('cur-loc').innerText = locName;
        
        const { data: lData } = await _supabase.from('locations').select('note').eq('name', locName).single();
        document.getElementById('note-in').value = lData?.note || '';
        
        loadStock(locName);
    }

    async function loadStock(loc) {
        const { data } = await _supabase.from('hospital_stock').select('*').eq('location_name', loc);
        const list = document.getElementById('fix-list');
        
        // æ¸²æŸ“é‚è¼¯ï¼šå…§å»ºå“é …å„ªå…ˆé¡¯ç¤º (è‹¥è³‡æ–™åº«æ²’è³‡æ–™å‰‡é¡¯ç¤º 0)
        let html = builtInNames.map(name => {
            const db = data?.find(d => d.item_name === name);
            return renderRow(name, db?.quantity || 0, db?.unit || 'å€‹', db?.updated_at);
        }).join('');

        // æ¸²æŸ“å…¶ä»–å“é …
        const others = data?.filter(d => !builtInNames.includes(d.item_name)) || [];
        html += others.map(d => renderRow(d.item_name, d.quantity, d.unit, d.updated_at)).join('');
        list.innerHTML = html;
    }

    function renderRow(name, qty, unit, time, note) {
        return `
            <div style="border-bottom: 1px solid #eee; padding: 15px 0;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <b>${name}</b>
                    <div>
                        <input type="number" value="${qty}" onchange="updateQty('${name}', this.value, '${unit}', null)" style="width:50px;"> ${unit}
                    </div>
                </div>
                <input type="text" value="${note || ''}" 
                       placeholder="è¼¸å…¥å“é …å‚™è¨» (å¦‚ï¼šæ”¾åœ¨ç¬¬ä¸‰æŠ½å±œ)" 
                       onchange="updateQty('${name}', null, '${unit}', this.value)"
                       style="width:100%; margin-top:8px; padding:5px; font-size:12px; border:1px solid #eee; border-radius:4px; color:#666;">
                <div style="font-size:10px; color:#bbb; margin-top:5px;">æ›´æ–°æ™‚é–“: ${time ? new Date(time).toLocaleString() : 'ç„¡'}</div>
            </div>`;
    }

    // æ›´æ–°å‡½æ•¸ä¹Ÿè¦æ”¹ï¼Œèƒ½åŒæ™‚è™•ç†æ•¸é‡æˆ–å‚™è¨»
    async function updateQty(name, qty, unit, note) {
        const loc = document.getElementById('loc-sel').value;
        
        // æŠ“å–ç›®å‰çš„è³‡æ–™ï¼Œé¿å…æ›´æ–°å‚™è¨»æ™‚è¦†è“‹äº†æ•¸é‡ï¼Œæˆ–æ›´æ–°æ•¸é‡æ™‚è¦†è“‹äº†å‚™è¨»
        const { data: current } = await _supabase.from('hospital_stock')
            .select('*').eq('location_name', loc).eq('item_name', name).single();

        const updateData = {
            location_name: loc,
            item_name: name,
            quantity: qty !== null ? qty : (current?.quantity || 0),
            unit: unit,
            note: note !== null ? note : (current?.note || ''),
            updated_at: new Date()
        };

        await _supabase.from('hospital_stock').upsert(updateData, { onConflict: 'location_name, item_name' });
        // ä¸ç”¨ reloadï¼Œå·å·æ›´æ–°å°±å¥½ï¼Œæˆ–è€… loadStock(loc)
    }

    async function addOther() {
        const name = document.getElementById('new-name').value;
        const unit = document.getElementById('new-unit').value;
        if (name) await updateQty(name, 0, unit);
    }

    async function saveNote() {
        const loc = document.getElementById('loc-sel').value;
        await _supabase.from('locations').update({ note: document.getElementById('note-in').value }).eq('name', loc);
        alert("å‚™è¨»å­˜å¥½äº†ï¼");
    }
    init();
</script>
</body>
</html>