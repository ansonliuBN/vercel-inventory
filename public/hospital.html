<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #f4f7f9; margin: 0; }
        .flex-grid { display: flex; gap: 20px; flex-wrap: wrap; }
        .panel { background: white; padding: 20px; border-radius: 12px; flex: 1; min-width: 320px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .loc-tag { background: #e7f3ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #b3d7ff; }
        .stock-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        input[type="number"] { width: 50px; text-align: center; }
        input[type="text"] { width: 100px; }
        .btn-blue { background: #007bff; color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; cursor: pointer; }
    </style>
</head>
<body>
    <div class="flex-grid">
        <div class="panel" style="max-width: 400px;">
            <h3>ğŸ“ ä½ç½®èˆ‡æé†’</h3>
            <div class="loc-tag">åµæ¸¬ä½ç½®ï¼š<b id="cur-loc" style="color:#007bff;">å®šä½ä¸­...</b></div>
            <select id="loc-sel" style="width:100%; padding:8px;" onchange="sync()"></select>
            <textarea id="note-in" style="width:100%; height:100px; margin-top:15px; padding:10px; box-sizing:border-box;" placeholder="å¯«ä¸‹è¦æé†’æ¥­å‹™çš„è©±..."></textarea>
            <button class="btn-blue" onclick="saveNote()" style="margin-top:10px;">å„²å­˜å‚™è¨»</button>
        </div>

        <div class="panel">
            <h3>âš½ é†«é™¢å›ºå®šåº«å­˜</h3>
            <div id="fix-list"></div>
            <hr>
            <p style="font-size:13px; color:#999;">æ–°å¢è‡ªå®šç¾©é …ï¼š</p>
            <div style="display:flex; gap:5px;">
                <input type="text" id="new-name" placeholder="å“å">
                <input type="text" id="new-unit" placeholder="å–®ä½" value="å€‹" style="width:50px;">
                <button onclick="addOther()">æ–°å¢</button>
            </div>
        </div>
    </div>

<script>
    const builtInItems = ['æ„Ÿå…‰çƒ (Sensory Balls)', 'Skin Fiducial'];

    async function init() {
        const { data: locs } = await _supabase.from('locations').select('*');
        const sel = document.getElementById('loc-sel');
        locs.forEach(l => sel.add(new Option(l.name, l.name)));

        // ä½¿ç”¨å…±äº«å®šä½åŠŸèƒ½
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const nearest = await window.findNearestLocation(pos.coords.latitude, pos.coords.longitude);
            if (nearest) {
                sel.value = nearest.name;
                sync();
            }
        });
    }

    async function sync() {
        const loc = document.getElementById('loc-sel').value;
        document.getElementById('cur-loc').innerText = loc;
        const { data: lData } = await _supabase.from('locations').select('note').eq('name', loc).single();
        document.getElementById('note-in').value = lData?.note || '';
        loadStock(loc);
    }

    async function loadStock(loc) {
        const { data } = await _supabase.from('hospital_stock').select('*').eq('location_name', loc);
        const container = document.getElementById('fix-list');
        
        let html = builtInItems.map(name => {
            const db = data?.find(d => d.item_name === name);
            return renderRow(name, db?.quantity || 0, db?.unit || 'å€‹', db?.updated_at);
        }).join('');

        const others = data?.filter(d => !builtInItems.includes(d.item_name)) || [];
        html += others.map(d => renderRow(d.item_name, d.quantity, d.unit, d.updated_at)).join('');
        container.innerHTML = html;
    }

    function renderRow(name, qty, unit, time) {
        return `
            <div class="stock-row">
                <div><b>${name}</b><br><small style="color:#bbb">${time ? new Date(time).toLocaleString() : 'æœªæ›´æ–°'}</small></div>
                <div>
                    <input type="number" value="${qty}" onchange="updateQty('${name}', this.value, '${unit}')"> ${unit}
                </div>
            </div>`;
    }

    async function updateQty(name, qty, unit) {
        const loc = document.getElementById('loc-sel').value;
        await _supabase.from('hospital_stock').upsert({
            location_name: loc, item_name: name, quantity: qty, unit: unit, updated_at: new Date()
        }, { onConflict: 'location_name, item_name' });
        loadStock(loc);
    }

    async function addOther() {
        const n = document.getElementById('new-name').value;
        const u = document.getElementById('new-unit').value;
        if(n) await updateQty(n, 0, u);
    }

    async function saveNote() {
        await _supabase.from('locations').update({ note: document.getElementById('note-in').value }).eq('name', document.getElementById('loc-sel').value);
        alert("å„²å­˜æˆåŠŸ");
    }
    init();
</script>
</body>
</html>