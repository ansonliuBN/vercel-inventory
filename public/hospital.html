<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>å›ºå®šåº«å­˜ + æé†’äº‹é …ï¼ˆCurrent + Logï¼‰</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>

  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f7f9; }
    .flex-row { display: flex; gap: 20px; flex-wrap: wrap; }
    .side-panel { background: white; padding: 20px; border-radius: 12px; flex: 1; min-width: 320px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .loc-tag { background: #e7f3ff; padding: 12px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #b3d7ff; }
    .muted { color:#888; font-size:12px; }
    input[type="number"] { width: 70px; padding: 6px; text-align: center; border: 1px solid #ddd; border-radius: 6px; }
    input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 6px; width:100%; box-sizing:border-box; }
    button { cursor:pointer; border-radius: 8px; border: none; padding: 8px 10px; }
    .btn-primary { background:#007bff; color:#fff; font-weight:700; }
    .btn-light { background:#f1f3f5; color:#333; border:1px solid #e9ecef; }
    .btn-danger { background:#ffe3e3; color:#c92a2a; border:1px solid #ffc9c9; }
    .row { border-bottom: 1px solid #eee; padding: 14px 0; }
    .row:last-child { border-bottom:none; }
    .row-top { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .qty-controls { display:flex; align-items:center; gap:8px; }
    .qty-btn { width:34px; height:34px; border-radius:10px; font-weight:900; background:#f1f3f5; border:1px solid #e9ecef; }
    .small { font-size: 12px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f1f3f5; border:1px solid #e9ecef; font-size:12px; color:#666; }

    .reminder-card { border:1px solid #eee; border-radius:10px; padding:12px; margin:10px 0; }
    .reminder-actions { display:flex; gap:8px; margin-top:8px; justify-content:flex-end; }
    textarea { width:100%; min-height:90px; padding:10px; border:1px solid #ddd; border-radius:10px; box-sizing:border-box; }
  </style>
</head>

<body>
  <div class="flex-row">
    <!-- å·¦å´ï¼šä½ç½® + æé†’äº‹é … -->
    <div class="side-panel" style="max-width: 520px;">
      <h3>ğŸ“ ä½ç½®èˆ‡æé†’äº‹é …</h3>

      <div class="loc-tag">
        ç›®å‰å®šä½ï¼š<b id="cur-loc" style="color:#007bff;">åµæ¸¬ä¸­...</b>
        <select id="loc-sel" style="width:100%; margin-top:10px; padding:10px; border-radius:10px; border:1px solid #cfe3ff;" onchange="sync()"></select>
      </div>

      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <h4 style="margin:0;">ğŸ“ æé†’äº‹é …ï¼ˆå¯å¤šç­†ï¼‰</h4>
        <span class="pill">å‰å°åˆªé™¤ï¼éš±è—</span>
      </div>

      <div id="reminder-list" style="margin-top:12px;"></div>

      <div style="margin-top:14px; padding-top:14px; border-top:2px dashed #eee;">
        <label class="muted">æ–°å¢æé†’ï¼š</label>
        <textarea id="reminder-new" placeholder="ä¾‹å¦‚ï¼šä¸‹é€±è¦è£œæ„Ÿå…‰çƒåˆ° 20 é¡†ï¼›æˆ–ï¼šé€™æ‰¹ fiducial æ”¾åœ¨ç¬¬ä¸‰æŠ½å±œ"></textarea>
        <button class="btn-primary" style="width:100%; margin-top:10px;" onclick="addReminder()">æ–°å¢æé†’</button>
      </div>
    </div>

    <!-- å³å´ï¼šå›ºå®šåº«å­˜ -->
    <div class="side-panel">
      <h3>âš½ é†«é™¢å›ºå®šåº«å­˜</h3>
      <div class="muted" style="margin-top:-6px;">æ”¯æ´ï¼šç›´æ¥è¨­å®šæ•¸é‡ + å¿«é€Ÿ +/-ï¼›å‚™è¨»å¯è¼¸å…¥ã€Œæ”¾å“ªè£¡ã€ç­‰ã€‚</div>

      <div id="fix-list" style="margin-top:10px;"></div>

      <button class="btn-primary" style="width:100%; margin: 10px 0;" onclick="commitStockChanges()">
        æ›´æ–°ï¼ˆå„²å­˜æ‰€æœ‰è®Šæ›´ï¼‰
      </button>
      <div class="muted small" id="pending-hint" style="margin-top:6px;">
        ç›®å‰æœªå„²å­˜ï¼š0 ç­†
      </div>

      <div style="margin-top:18px; padding-top:15px; border-top:2px dashed #eee;">
        <label class="muted">æ–°å¢å…¶ä»–è€—æï¼ˆè‡ªç”±è¼¸å…¥ item_nameï¼‰ï¼š</label>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <input type="number"
            data-item="${escAttr(d.item_name)}"
            value="${qty}"
            onchange="setQty('${escAttr(d.item_name)}', this.value)">

          <input type="text" id="new-name" placeholder="å“åï¼ˆä¾‹å¦‚ï¼šé‘½é ­å¥—ä»¶ï¼‰" style="flex:2;">
          <button class="btn-light" onclick="addOther()">æ–°å¢</button>
        </div>
        <div class="muted small" style="margin-top:8px;">
          æ–°å¢å¾Œæœƒåœ¨è©²åœ°é»å»ºç«‹ currentï¼ˆæ•¸é‡=0ï¼‰ï¼Œä¸¦å¯«å…¥ logã€‚
        </div>
      </div>
    </div>
  </div>

<script>
  // ä½ åŸæœ¬çš„å…©å€‹å…§å»ºå“é …
  const builtInNames = ['æ„Ÿå…‰çƒ (Sensory Balls)', 'Skin Fiducial'];
  const pendingStockChanges = new Map(); 

  // ====== å°å·¥å…· ======
  function esc(s) {
    return String(s ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }
  function getOperator() {
    return localStorage.getItem('user_email') || 'unknown';
  }

  function nowIso() { return new Date().toISOString(); }
  function fmtTime(t) { return t ? new Date(time).toLocaleString('zh-TW', {hour12: false}) : 'ç„¡'; }

  async function requireUserId() {
    const { data, error } = await _supabase.auth.getUser();
    if (error) console.warn(error);
    const user = data?.user;
    if (!user?.id) {
      alert("è«‹å…ˆç™»å…¥ï¼ˆSupabase Authï¼‰ï¼Œæ‰å¯ä»¥å¯«å…¥è³‡æ–™ã€‚");
      throw new Error("Not logged in");
    }
    document.getElementById('cur-user').innerText = user.id;
    return user.id;
  }

  // ====== åˆå§‹åŒ– ======
  async function init() {
    // ä½¿ç”¨è€…é¡¯ç¤º
    try { await requireUserId(); }
    catch(_) {}

    // locations ä¸‹æ‹‰
    const { data: locs, error } = await _supabase.from('locations').select('*');
    if (error) {
      console.error(error);
      alert("è®€å– locations å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Supabase é€£ç·š / RLSã€‚");
      return;
    }

    const sel = document.getElementById('loc-sel');
    sel.innerHTML = '';
    (locs || []).forEach(l => sel.add(new Option(l.name, l.name)));

    // å…ˆé è¨­ç¬¬ä¸€å€‹
    if (locs?.length) {
      sel.value = locs[0].name;
      document.getElementById('cur-loc').innerText = sel.value;
    }

    // ç”¨ä½ åŸæœ¬é‚£å¥—å®šä½ï¼ˆè‹¥æœ‰æä¾› findNearestLocationï¼‰
    if (navigator.geolocation && window.findNearestLocation) {
      navigator.geolocation.getCurrentPosition(async (pos) => {
        try {
          const nearest = await window.findNearestLocation(pos.coords.latitude, pos.coords.longitude);
          if (nearest?.name) sel.value = nearest.name;
        } catch(e) {}
        sync();
      }, () => {
        document.getElementById('cur-loc').innerText = "å®šä½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸æ“‡";
        sync();
      });
    } else {
      sync();
    }
  }

  async function sync() {
    const locName = document.getElementById('loc-sel').value;
    document.getElementById('cur-loc').innerText = locName;

    await Promise.all([
      loadStock(locName),
      loadReminders(locName)
    ]);
  }

  // ====== å›ºå®šåº«å­˜ï¼šè®€å– ======
  async function loadStock(loc) {
    const { data, error } = await _supabase
      .from('hospital_stock_current')
      .select('*')
      .eq('location_name', loc);

    if (error) {
      console.error(error);
      alert("è®€å– hospital_stock_current å¤±æ•—ï¼Œè«‹æª¢æŸ¥ RLS / table åç¨±ã€‚");
      return;
    }

    const list = document.getElementById('fix-list');

    // å…§å»ºå„ªå…ˆé¡¯ç¤ºï¼ˆæ²’æœ‰å°±é¡¯ç¤º 0ï¼‰
    let html = builtInNames.map(name => {
      const db = (data || []).find(d => d.item_name === name);
      return renderStockRow({
        item_name: name,
        quantity: db?.quantity ?? 0,
        note: db?.note ?? '',
        updated_at: db?.updated_at ?? null,
        operator_user_id: db?.operator_user_id ?? null
      });
    }).join('');

    // å…¶ä»–å“é …
    const others = (data || []).filter(d => !builtInNames.includes(d.item_name));
    html += others.map(d => renderStockRow(d)).join('');

    list.innerHTML = html;
  }

  function renderStockRow(d) {
    const name = esc(d.item_name);
    const qty = Number(d.quantity ?? 0);
    const note = esc(d.note ?? '');
    const time = fmtTime(d.updated_at);
    const op = d.operator_user_id ? esc(d.operator_user_id) : '-';

    return `
      <div class="row" data-row="${escAttr(d.item_name)}">
        <div class="row-top">
          <b>${name}</b>
          <div class="qty-controls">
            <button class="qty-btn" title="-1" onclick="adjustQty('${escAttr(d.item_name)}', -1)">âˆ’</button>
            <input type="number" value="${qty}" onchange="setQty('${escAttr(d.item_name)}', this.value)">
            <button class="qty-btn" title="+1" onclick="adjustQty('${escAttr(d.item_name)}', 1)">+</button>
          </div>
        </div>

        <div style="margin-top:8px;">
          <input type="text"
            value="${note}"
            style="width:50%;"
            placeholder="è¼¸å…¥å“é …å‚™è¨»ï¼ˆå¦‚ï¼šæ”¾åœ¨ç¬¬ä¸‰æŠ½å±œï¼‰"
            onchange="setItemNote('${escAttr(d.item_name)}', this.value)"
          />
        </div>

        <div class="muted small" style="margin-top:6px;">
          æ›´æ–°æ™‚é–“ï¼š${time}ã€€ï½œã€€æ›´æ–°è€…ï¼š${op}
        </div>
      </div>
    `;
  }

  // ç”¨åœ¨ onclick / attribute çš„é€ƒé€¸ï¼ˆé¿å…å¼•è™Ÿç‚¸æ‰ï¼‰
  function escAttr(s) {
    return String(s ?? '').replaceAll('\\', '\\\\').replaceAll("'", "\\'");
  }

  // ====== å›ºå®šåº«å­˜ï¼šå¯«å…¥ï¼ˆCurrent + Logï¼‰ ======
  async function getCurrentStockRow(loc, itemName) {
    const { data, error } = await _supabase
      .from('hospital_stock_current')
      .select('*')
      .eq('location_name', loc)
      .eq('item_name', itemName)
      .maybeSingle();

    if (error) console.warn(error);
    return data || null;
  }

  async function upsertCurrentStock(loc, itemName, quantity, note, operatorUserId) {
    const payload = {
      location_name: loc,
      item_name: itemName,
      quantity: quantity,
      note: note ?? null,
      updated_at: nowIso(),
      operator: operator
    };

    const { error } = await _supabase
      .from('hospital_stock_current')
      .upsert(payload, { onConflict: 'location_name,item_name' });

    if (error) throw error;
  }

  async function insertStockLog(loc, itemName, action, beforeQty, afterQty, beforeNote, afterNote, operatorUserId) {
    const payload = {
      location_name: loc,
      item_name: itemName,
      action: action,
      qty_before: beforeQty ?? null,
      qty_after: afterQty ?? null,
      note_before: beforeNote ?? null,
      note_after: afterNote ?? null,
      operator: operator,
      created_at: nowIso()
    };

    const { error } = await _supabase.from('hospital_stock_log').insert(payload);
    if (error) throw error;
  }

  function setQty(itemName, newQtyRaw) {
    let newQty = Number(newQtyRaw);
    if (!Number.isFinite(newQty)) newQty = 0;
    if (newQty < 0) newQty = 0;

    const cur = pendingStockChanges.get(itemName) || {};
    pendingStockChanges.set(itemName, { ...cur, qty: newQty });

    // å¯é¸ï¼šæŠŠé€™åˆ—æ¨™ç¤ºæˆã€Œæœªå„²å­˜ã€
    markRowDirty(itemName, true);
  }


  function adjustQty(itemName, delta) {
    const input = document.querySelector(`input[data-item="${cssEscape(itemName)}"]`);
    const before = Number(input?.value || 0);
    let after = before + Number(delta || 0);
    if (after < 0) after = 0;
    if (input) input.value = after;

    const cur = pendingStockChanges.get(itemName) || {};
    pendingStockChanges.set(itemName, { ...cur, qty: after });

    markRowDirty(itemName, true);
  }


  function setItemNote(itemName, newNoteRaw) {
    const newNote = String(newNoteRaw ?? '').trim();
    const cur = pendingStockChanges.get(itemName) || {};
    pendingStockChanges.set(itemName, { ...cur, note: newNote });

    markRowDirty(itemName, true);
  }

  async function commitStockChanges() {
    const loc = document.getElementById('loc-sel').value;
    const operator = getOperator(); // ä½ ä¹‹å‰æ”¹æˆ localStorage email é‚£å¥—
    if (pendingStockChanges.size === 0) {
      alert('æ²’æœ‰éœ€è¦æ›´æ–°çš„è®Šæ›´ã€‚');
      return;
    }

    // 1) å…ˆæŠ“ currentï¼ˆä¸€æ¬¡æŠ“æ•´å€‹åœ°é»ï¼Œé¿å…ä¸€ç­†ä¸€ç­† selectï¼‰
    const { data: currentRows, error: curErr } = await _supabase
      .from('hospital_stock_current')
      .select('*')
      .eq('location_name', loc);

    if (curErr) { console.error(curErr); alert('è®€å– current å¤±æ•—'); return; }

    const curMap = new Map((currentRows || []).map(r => [r.item_name, r]));

    // 2) çµ„ upsert payloadï¼ˆcurrentï¼‰
    const upserts = [];
    const logs = [];

    for (const [itemName, chg] of pendingStockChanges.entries()) {
      const cur = curMap.get(itemName);
      const beforeQty = cur?.quantity ?? 0;
      const beforeNote = cur?.note ?? '';

      const afterQty = (chg.qty !== undefined) ? chg.qty : beforeQty;
      const afterNote = (chg.note !== undefined) ? chg.note : beforeNote;

      upserts.push({
        location_name: loc,
        item_name: itemName,
        quantity: afterQty,
        note: afterNote,
        updated_at: new Date().toISOString(),
        operator: operator
      });

      // logï¼šåªè¦æœ‰è®Šå°±å¯«ï¼ˆä½ è¦æ›´åš´è¬¹å¯ä»¥æ¯”å° before/afterï¼‰
      const action =
        (chg.qty !== undefined && chg.note !== undefined) ? 'set' :
        (chg.qty !== undefined) ? 'set' :
        'note';

      logs.push({
        location_name: loc,
        item_name: itemName,
        action,
        qty_before: (chg.qty !== undefined) ? beforeQty : null,
        qty_after: (chg.qty !== undefined) ? afterQty : null,
        note_before: (chg.note !== undefined) ? beforeNote : null,
        note_after: (chg.note !== undefined) ? afterNote : null,
        operator: operator,
        created_at: new Date().toISOString()
      });
    }

    // 3) ä¸€æ¬¡ upsert current
    const { error: upErr } = await _supabase
      .from('hospital_stock_current')
      .upsert(upserts, { onConflict: 'location_name,item_name' });

    if (upErr) { console.error(upErr); alert('æ›´æ–° current å¤±æ•—'); return; }

    // 4) ä¸€æ¬¡ insert log
    const { error: logErr } = await _supabase
      .from('hospital_stock_log')
      .insert(logs);

    if (logErr) { console.error(logErr); alert('å¯«å…¥ log å¤±æ•—'); return; }

    // 5) æ¸…ç©ºæš«å­˜ + é‡åˆ·
    pendingStockChanges.clear();
    updatePendingHint();

    await loadStock(loc); // é‡æ–°è®€ current åˆ·æ–° UIï¼ˆæ™‚é–“/æ›´æ–°è€…ï¼‰
    alert('æ›´æ–°å®Œæˆï¼');
  }

  function updatePendingHint() {
    const el = document.getElementById('pending-hint');
    if (!el) return;
    el.innerText = `ç›®å‰æœªå„²å­˜ï¼š${pendingStockChanges.size} ç­†`;
  }

  function markRowDirty(itemName, isDirty) {
    const row = document.querySelector(`[data-row="${cssEscape(itemName)}"]`);
    if (row) row.style.opacity = isDirty ? '0.85' : '1';
    updatePendingHint();
  }

  // é¿å… itemName æœ‰ç‰¹æ®Šå­—å…ƒé€ æˆ querySelector çˆ†
  function cssEscape(s) {
    return String(s).replaceAll('\\', '\\\\').replaceAll('"', '\\"');
  }



  // æ–°å¢å…¶ä»–è€—æï¼ˆå»ºç«‹ current + logï¼‰
  async function addOther() {
    const name = document.getElementById('new-name').value?.trim();
    if (!name) return;

    const loc = document.getElementById('loc-sel').value;
    const operator = getOperator();

    const cur = await getCurrentStockRow(loc, name);
    if (cur) {
      alert("æ­¤å“é …å·²å­˜åœ¨æ–¼è©²åœ°é»ã€‚");
      return;
    }

    const qty = Number(document.getElementById('new-qty').value || 0);
    await upsertCurrentStock(loc, name, qty, '', operator);
    await insertStockLog(loc, name, 'set', null, qty, null, null, operator);

    document.getElementById('new-name').value = '';
    document.getElementById('new-qty').value = '';

    await loadStock(loc);
  }

  // ====== æé†’äº‹é …ï¼šè®€å– ======
  async function loadReminders(loc) {
    const { data, error } = await _supabase
      .from('location_reminder_current')
      .select('*')
      .eq('location_name', loc)
      .eq('is_visible', true)
      .order('updated_at', { ascending: false });

    if (error) {
      console.error(error);
      alert("è®€å– location_reminder_current å¤±æ•—ï¼Œè«‹æª¢æŸ¥ RLS / table åç¨±ã€‚");
      return;
    }

    const container = document.getElementById('reminder-list');
    if (!data?.length) {
      container.innerHTML = `<div class="muted">ç›®å‰æ²’æœ‰æé†’äº‹é …ã€‚</div>`;
      return;
    }

    container.innerHTML = data.map(r => renderReminderCard(r)).join('');
  }

  function renderReminderCard(r) {
    const id = escAttr(r.id);
    const content = esc(r.content ?? '');
    const time = fmtTime(r.updated_at);
    const op = r.operator_user_id ? esc(r.operator_user_id) : '-';

    return `
      <div class="reminder-card">
        <div class="muted small">æ›´æ–°ï¼š${time}ã€€ï½œã€€æ›´æ–°è€…ï¼š${op}</div>
        <div style="margin-top:8px;">
          <input type="text" id="reminder-${id}" value="${content}">
        </div>
        <div class="reminder-actions">
          <button class="btn-light" onclick="updateReminder('${id}')">æ›´æ–°</button>
          <button class="btn-danger" onclick="hideReminder('${id}')">åˆªé™¤ï¼ˆéš±è—ï¼‰</button>
        </div>
      </div>
    `;
  }

  // ====== æé†’äº‹é …ï¼šå¯«å…¥ï¼ˆCurrent + Logï¼‰ ======
  async function getReminderRowById(id) {
    const { data, error } = await _supabase
      .from('location_reminder_current')
      .select('*')
      .eq('id', id)
      .maybeSingle();
    if (error) console.warn(error);
    return data || null;
  }

  async function insertReminderLog(loc, action, beforeContent, afterContent, operatorUserId) {
    const payload = {
      location_name: loc,
      action: action,
      content_before: beforeContent ?? null,
      content_after: afterContent ?? null,
      operator: operator,
      created_at: nowIso()
    };
    const { error } = await _supabase.from('location_reminder_log').insert(payload);
    if (error) throw error;
  }

  async function addReminder() {
    const loc = document.getElementById('loc-sel').value;
    const operator = getOperator();
    const content = document.getElementById('reminder-new').value?.trim();
    if (!content) return;

    // current insertï¼ˆå¤šç­†ï¼‰
    const payload = {
      location_name: loc,
      content: content,
      is_visible: true,
      updated_at: nowIso(),
      operator: operator
    };

    const { error } = await _supabase.from('location_reminder_current').insert(payload);
    if (error) {
      console.error(error);
      alert("æ–°å¢æé†’å¤±æ•—ï¼Œè«‹æª¢æŸ¥ RLSã€‚");
      return;
    }

    // log
    await insertReminderLog(loc, 'create', null, content, operatorUserId);

    document.getElementById('reminder-new').value = '';
    await loadReminders(loc);
  }

  async function updateReminder(id) {
    const loc = document.getElementById('loc-sel').value;
    const operator = getOperator();

    const input = document.getElementById(`reminder-${id}`);
    const newContent = input?.value?.trim() ?? '';
    if (!newContent) {
      alert("å…§å®¹ä¸å¯ç‚ºç©ºï¼›è‹¥è¦ç§»é™¤è«‹æŒ‰ã€Œåˆªé™¤ï¼ˆéš±è—ï¼‰ã€");
      return;
    }

    const cur = await getReminderRowById(id);
    const before = cur?.content ?? '';

    // current update
    const { error } = await _supabase
      .from('location_reminder_current')
      .update({
        content: newContent,
        updated_at: nowIso(),
        operator: operator
      })
      .eq('id', id);

    if (error) {
      console.error(error);
      alert("æ›´æ–°æé†’å¤±æ•—ï¼Œè«‹æª¢æŸ¥ RLSã€‚");
      return;
    }

    // log
    await insertReminderLog(loc, 'update', before, newContent, operatorUserId);

    await loadReminders(loc);
  }

  async function hideReminder(id) {
    const loc = document.getElementById('loc-sel').value;
    const operator = getOperator();

    const cur = await getReminderRowById(id);
    const before = cur?.content ?? '';

    // current hideï¼ˆsoft deleteï¼‰
    const { error } = await _supabase
      .from('location_reminder_current')
      .update({
        is_visible: false,
        updated_at: nowIso(),
        operator: operator
      })
      .eq('id', id);

    if (error) {
      console.error(error);
      alert("åˆªé™¤ï¼ˆéš±è—ï¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ RLSã€‚");
      return;
    }

    // log
    await insertReminderLog(loc, 'hide', before, null, operatorUserId);

    await loadReminders(loc);
  }

  // ====== å•Ÿå‹• ======
  init();
</script>
</body>
</html>
