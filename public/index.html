<div class="card">
    <h1>ğŸ¢ ç¸½å…¬å¸å€‰åº«</h1>
    <div id="main-stock-display">è¼‰å…¥ä¸­...</div>
    <button onclick="location.href='scan.html'" style="background:#50c878;">ğŸ“· æƒææ–°é€²è²¨ç‰©</button>
</div>

<div class="card">
    <h2>ğŸ“ éŠ·å”®æ“šé»ç®¡ç†</h2>
    <div class="tabs">
        <button onclick="switchLocation('LOC_A')">åœ°é» A</button>
        <button onclick="switchLocation('LOC_B')">åœ°é» B</button>
    </div>
    <div id="location-inventory-list">
        <p>è«‹é¸æ“‡ä¸Šæ–¹åœ°é»æŸ¥çœ‹æ¸…å–®</p>
    </div>
</div>

<script>
    // 1. æŠ“å–ç¸½è¡¨æ•¸æ“š
    async function fetchSummary() {
        const res = await fetch('/api/stock');
        const data = await res.json();
        
        // æ¸²æŸ“å…¬å¸å€‰ (MAIN)
        const main = data.filter(i => i.location === 'MAIN');
        document.getElementById('main-stock-display').innerHTML = main.map(i => 
            `<p>${i.item_uuid.substring(0,12)}... : <b>${i.current_stock}</b> ä»¶</p>`
        ).join('') || "ç›®å‰ç„¡åº«å­˜";
        
        window.allData = data; // æš«å­˜èµ·ä¾†çµ¦åˆ‡æ›åœ°é»ç”¨
    }

    // 2. åˆ‡æ›åœ°é»é¡¯ç¤ºæ¸…å–®
    function switchLocation(loc) {
        const list = window.allData.filter(i => i.location === loc && i.current_stock > 0);
        const container = document.getElementById('location-inventory-list');
        
        container.innerHTML = `<h3>${loc} åœ¨åº«æ¸…å–®</h3>` + list.map(i => `
            <div class="stock-row">
                <span>${i.item_uuid.substring(0,12)}</span>
                <button onclick="doConsume('${i.item_uuid}', '${loc}')">éŠ·å¸³ -1</button>
            </div>
        `).join('');
    }

    // 3. éŠ·å¸³å‹•ä½œ
    async function doConsume(uuid, loc) {
        if(!confirm('ç¢ºèªæ¶ˆè€—æ­¤ç‰©æ–™ï¼Ÿ')) return;
        await fetch('/api/stock', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ item_uuid: uuid, from_loc: loc, to_loc: 'CONSUMED', operator: 'ç¾å ´æ¥­å‹™' })
        });
        alert('éŠ·å¸³æˆåŠŸï¼');
        location.reload(); // é‡æ–°æ•´ç†
    }

    fetchSummary();
</script>