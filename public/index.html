<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 15px; background: white; margin: 0; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; } /* é–å®šè¡¨æ ¼å¸ƒå±€ */
        
        th { background: #f8f9fa; padding: 12px 8px; text-align: left; border-bottom: 2px solid #eee; color: #666; font-size: 14px; }
        td { padding: 12px 8px; border-bottom: 1px solid #eee; font-size: 14px; word-break: break-all; vertical-align: top; }

        /* --- æ ¸å¿ƒæ¯”ä¾‹è¨­å®š --- */
        .col-loc { width: 12%; }   /* ä½ç½®ï¼šç¸®å° */
        .col-name { width: 25%; }  /* ç”¢å“ï¼šé©ä¸­ */
        .col-exp { width: 13%; }   /* æ•ˆæœŸï¼šç¸®å° */
        .col-qty { width: 8%; text-align: center; } /* æ•¸é‡ï¼šæœ€å°ä¸”ç½®ä¸­ */
        .col-note { width: 42%; }  /* å‚™è¨»ï¼šæœ€å¤§ */

        .urgent { color: #d9534f; font-weight: bold; } /* ä¸‰å€‹æœˆå…§ç´…å­— */
        .row-biz { background: #f0f7ff; } /* æ¥­å‹™å€‰åº«é«˜äº® */
    </style>
</head>
<body>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 style="margin:0;">ğŸ“¦ åº«å­˜å¯¦æ™‚ç¸½è¡¨</h2>
        <button onclick="load()" style="padding: 6px 12px; cursor: pointer; border-radius: 4px; border: 1px solid #ddd;">ğŸ”„ åˆ·æ–°æ•¸æ“š</button>
    </div>

    <table>
        <thead>
            <tr>
                <th class="col-loc">ä½ç½®</th>
                <th class="col-name">ç”¢å“ / åºè™Ÿ</th>
                <th class="col-exp">æ•ˆæœŸ</th>
                <th class="col-qty">æ•¸é‡</th>
                <th class="col-note">å‚™è¨»</th>
            </tr>
        </thead>
        <tbody id="list">
            <tr><td colspan="5" style="text-align:center; padding:40px; color:#999;">æ­£åœ¨é€£ç·šè³‡æ–™åº«...</td></tr>
        </tbody>
    </table>

    <script>
        const productMapping = {
            'FPSD0101': 'Surgical Equipment Drape Packs',
            'FPIR0211': 'Instrument Registration Platform Cover',
            'FPEN1774': 'Lens 2D'
        };

        async function load() {
            const { data, error } = await _supabase.from('inventory_summary').select('*');
            if (error) return console.error(error);

            // æ’åºï¼šæ¥­å‹™å€‰åº«ç½®é ‚ > è¿‘æœŸæ´»èº (last_active) > æ•ˆæœŸ (expiry_date)
            data.sort((a, b) => {
                if (a.location === 'æ¥­å‹™å€‰åº«') return -1;
                if (b.location === 'æ¥­å‹™å€‰åº«') return 1;
                if (a.last_active !== b.last_active) return new Date(b.last_active || 0) - new Date(a.last_active || 0);
                return new Date(a.expiry_date || '9999-12-31') - new Date(b.expiry_date || '9999-12-31');
            });

            const limitDate = new Date();
            limitDate.setMonth(limitDate.getMonth() + 3);

            document.getElementById('list').innerHTML = data.map(i => {
                // è™•ç†ç”¢å“åç¨±è½‰æ› (æŠ“å– - ä¹‹å‰çš„ä»£ç¢¼)
                const prefix = i.product_code ? i.product_code.split('-')[0] : '';
                const friendlyName = productMapping[prefix] || i.product_code || 'æœªçŸ¥ç”¢å“';
                
                // æ•ˆæœŸé¡è‰²åˆ¤æ–·
                const isUrgent = i.expiry_date && new Date(i.expiry_date) < limitDate;

                return `
                    <tr class="${i.location === 'æ¥­å‹™å€‰åº«' ? 'row-biz' : ''}">
                        <td><b>${i.location}</b></td>
                        <td>
                            <div style="font-weight:bold; color:#333;">${friendlyName}</div>
                            <div style="font-size:11px; color:#999; margin-top:2px;">${i.item_uuid}</div>
                        </td>
                        <td class="${isUrgent ? 'urgent' : ''}">${i.expiry_date || '-'}</td>
                        <td style="text-align:center;"><b>${i.current_stock}</b></td>
                        <td style="color:#666; font-size:13px; line-height:1.4;">
                            ${i.location_note ? `<span onclick="alert('ğŸ“¢ æé†’ï¼š${i.location_note}')" style="cursor:help;">â• ${i.location_note}</span>` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        load();
    </script>
</body>
</html>