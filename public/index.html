<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Navi è€—æç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        :root { --primary: #007bff; --bg: #f0f2f5; --nav-h: 70px; }
        body { 
            font-family: -apple-system, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            overflow-x: hidden;
            }


        /* é ‚éƒ¨ BARï¼šè‡³ä¸­å°é½Š */
        .navbar { 
            background: white; height: var(--nav-h); padding: 0 40px; 
            display: none; align-items: center; justify-content: space-between; 
            border-bottom: 1px solid #ddd; position: fixed; top: 0; width: 100%; box-sizing: border-box; z-index: 1000; 
        }
        .logo { font-size: 20px; font-weight: bold; color: #333; flex: 1; } /* å·¦é‚Š */
        
        .nav-links { display: flex; gap: 12px; justify-content: center; flex: 2; } /* ä¸­é–“è‡³ä¸­ */
        .nav-btn { 
            background: #fff; border: 1px solid #ddd; padding: 10px 20px; 
            border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 500; transition: 0.2s; 
        }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,123,255,0.2); }
        .nav-btn:hover:not(.active) { background: #f8f9fa; }

        .user-area { flex: 1; display: flex; justify-content: flex-end; align-items: center; gap: 15px; } /* å³é‚Š */

        /* æ‰‹æ©Ÿç‰ˆä¸‰æ¢ç·š */
        .burger { display: none; font-size: 30px; cursor: pointer; }

        @media (max-width: 950px) {
            .navbar { padding: 0 20px; }
            .burger { display: block; }
            .nav-links { 
                display: none; position: absolute; top: var(--nav-h); left: 0; width: 100%; 
                background: white; flex-direction: column; padding: 15px; border-bottom: 1px solid #ddd; 
            }
            .nav-links.active { display: flex; }
            .nav-btn { width: 100%; text-align: left; border: none; padding: 15px; }
            .logo, .user-area { flex: none; }
        }

        /* å…§å®¹å€ï¼šåš´æ ¼è‡³ä¸­èˆ‡å·¦å³ç•™ç™½ */
        .main-wrapper { 
            margin-top: var(--nav-h);
            height: calc(100vh - var(--nav-h));

            /* âœ… ç”¨ max-width æ§åˆ¶ä¸Šé™ï¼Œç”¨ width æ§åˆ¶æµé«” */
            max-width: 1200px;
            width: calc(100vw - 48px);

            margin: var(--nav-h) auto 0;  /* ä¸Šé¢ç•™ nav çš„é«˜åº¦ï¼Œå·¦å³ç½®ä¸­ */
            padding: clamp(12px, 2vw, 28px);

            box-sizing: border-box;
            display: none;
            }

        .frame-box { 
            width: 100%; height: 100%; background: white; 
            border-radius: 15px; overflow: hidden; 
            box-shadow: 0 12px 35px rgba(0,0,0,0.10); /* å¢åŠ é«˜ç´šæ„Ÿé™°å½± */
            border: 1px solid #e0e0e0;
        }
        iframe { width: 100%; height: 100%; border: none; }
        
        /* ç™»å…¥ç•«é¢ */
        #login-screen { position: fixed; inset: 0; background: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .google-btn { background: white; border: 1px solid #ddd; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <div id="login-screen">
        <h1 style="margin-bottom:30px; color:#333;">ğŸ“¦ æ¥­å‹™è€—æç®¡ç†ç³»çµ±</h1>
        <button class="google-btn" onclick="login()">
            <img src="https://www.google.com/favicon.ico" width="20"> ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
        </button>
    </div>

    <nav class="navbar" id="app-bar">
        <div class="logo">Brain Navi</div>
        
        <div class="burger" onclick="toggleMenu()">â˜°</div>

        <div class="nav-links" id="menu">
            <button id="btn-scan" class="nav-btn" onclick="go('scan.html', this)">âœ¨ æ–°è²¨å…¥åº«</button>
            <button id="btn-list" class="nav-btn" onclick="go('list.html', this)">ğŸ“¦ åº«å­˜ç¸½è¡¨</button>
            <button id="btn-transfer" class="nav-btn" onclick="go('transfer.html', this)">ğŸšš æ’¥è£œç™¼è²¨</button>
            <button id="btn-consume" class="nav-btn" onclick="go('consume.html', this)">ğŸ¥ è€—æä½¿ç”¨</button>
            <button id="btn-hospital" class="nav-btn" onclick="go('hospital.html', this)">ğŸ› ï¸ é†«é™¢ç®¡ç†</button>
        </div>

        <div class="user-area">
            <span id="u-email" style="font-size:12px; color:#666;"></span>
            <button onclick="logout()" style="color:#ff4d4f; background:none; border:none; cursor:pointer; font-weight:bold;">ç™»å‡º</button>
        </div>
    </nav>

    <main class="main-wrapper" id="app-content">
        <div class="frame-box">
            <iframe id="sub-page" src="about:blank"></iframe>
        </div>
    </main>

    <script>
        let isAppInitialized = false; // é˜²é–ƒçˆé–

        function toggleMenu() { document.getElementById('menu').classList.toggle('active'); }

        function go(url, btn) {
            const iframe = document.getElementById('sub-page');
            // å­˜èµ·ä¾†ï¼šä¸‹æ¬¡åˆ·æ–°ä¹Ÿå›åˆ°ä½¿ç”¨è€…æœ€å¾Œä¸€é 
            sessionStorage.setItem('lastPage', url);

            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            iframe.src = url;

            if (window.innerWidth <= 950) document.getElementById('menu').classList.remove('active');

        }
        window.go = go; // âœ… é€™è¡ŒåŠ ä¸Šæ›´ä¿éšª

        function showLoggedIn(session) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-bar').style.display = 'flex';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('u-email').innerText = session.user.email;

            // âœ… åªåœ¨ã€Œç¬¬ä¸€æ¬¡ã€ä¸” iframe é‚„æ²’è¼‰ä»»ä½•é é¢æ™‚ï¼Œæ‰å°å»é è¨­é 
            if (!isAppInitialized) {
            const lastPage = sessionStorage.getItem('lastPage') || 'list.html';
            const btnMap = {
                'list.html': 'btn-list',
                'scan.html': 'btn-scan',
                'transfer.html': 'btn-transfer',
                'consume.html': 'btn-consume',
                'hospital.html': 'btn-hospital',
            };
            go(lastPage, document.getElementById(btnMap[lastPage] || 'btn-list'));
            isAppInitialized = true;
            }
        }

        function showLoggedOut() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-bar').style.display = 'none';
            document.getElementById('app-content').style.display = 'none';
            isAppInitialized = false;
        }

        async function login() {
            await _supabase.auth.signInWithOAuth({
            provider: 'google',
            options: { redirectTo: window.location.origin }
            });
        }

        async function logout() {
            await _supabase.auth.signOut();
            sessionStorage.clear(); // å»ºè­°ç”¨ sessionStorageï¼Œä¸è¦æ¸…æ•´å€‹ localStorage
            location.reload();
        }

        // âœ… é¦–æ¬¡è¼‰å…¥ï¼šç”¨ getSession æ±ºå®šé¡¯ç¤ºå“ªå€‹ç•«é¢ï¼ˆé¿å… login ç•«é¢å…ˆé–ƒä¸€ä¸‹ï¼‰
        (async () => {
            const { data } = await _supabase.auth.getSession();
            if (data.session) showLoggedIn(data.session);
            else showLoggedOut();

            // âœ… å¾ŒçºŒç‹€æ…‹è®ŠåŒ–ï¼šåªæ›´æ–° UIï¼Œä¸è¦åœ¨é€™è£¡ç¡¬ go('list.html')
            _supabase.auth.onAuthStateChange((event, session) => {
            if (session) showLoggedIn(session);
            else showLoggedOut();
            });
        })();

        /*_supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-bar').style.display = 'flex';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('u-email').innerText = session.user.email;

                // æ ¸å¿ƒé˜²é–ƒçˆï¼šåªåœ¨ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚è·³è½‰åˆ°ç¸½è¡¨
                if (!isAppInitialized) {
                    go('list.html', document.getElementById('btn-list'));
                    isAppInitialized = true;
                }
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-bar').style.display = 'none';
                document.getElementById('app-content').style.display = 'none';
            }
        });*/
    </script>
</body>
</html>