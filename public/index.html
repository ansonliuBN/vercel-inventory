<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¥­å‹™ç«¯å€‰å„²ç³»çµ±-OCRæš´åŠ›ç‰ˆ</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        button { background: #7360f2; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 18px; font-weight: bold; }
        #ocrStatus { margin-top: 15px; font-size: 14px; color: #666; line-height: 1.6; word-break: break-all; }
        .preview-canvas { width: 100%; border: 1px solid #ddd; margin-top: 10px; border-radius: 8px; display: none; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ¢ å…¬å¸ç¸½å€‰ç¾æ³</h2>
        <div id="summary">é€£ç·šä¸­...</div>
    </div>

    <div class="card">
        <h2>ğŸ“¸ æ‹ç…§è¾¨è­˜å…¥åº«</h2>
        <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none">
        <button onclick="document.getElementById('photoInput').click()">ğŸ“· é»æ“Šæ‹ç…§ (è«‹å°æº–æ•¸å­—)</button>
        <canvas id="debugCanvas" class="preview-canvas"></canvas>
        <div id="ocrStatus">ç­‰å¾…æŒ‡ä»¤...</div>
    </div>

    <script src='https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js'></script>
    <script>
        const API_URL = '/api/stock';
        const photoInput = document.getElementById('photoInput');
        const ocrStatus = document.getElementById('ocrStatus');

        photoInput.onchange = async function() {
            const file = photoInput.files[0];
            if (!file) return;

            ocrStatus.innerHTML = "ğŸŒ€ æ­£åœ¨é€²è¡Œå½±åƒå„ªåŒ–èˆ‡æš´åŠ›è¾¨è­˜...";
            
            try {
                // 1. å½±åƒé è™•ç† (é»‘ç™½ + éŠ³åŒ–)
                const processedImageData = await preprocessImage(file);
                
                // 2. åŸ·è¡Œè¾¨è­˜
                const result = await Tesseract.recognize(processedImageData, 'eng', {
                    logger: m => {
                        if(m.status === 'recognizing text') ocrStatus.innerText = `è¾¨è­˜é€²åº¦: ${Math.round(m.progress * 100)}%`;
                    }
                });

                let text = result.data.text;
                console.log("åŸå§‹è¾¨è­˜çµæœ:", text);

                // 3. æš´åŠ›æ¸…ç†å­—ä¸²
                let cleanText = text
                    .replace(/\s+/g, '')       // åˆªé™¤ç©ºç™½
                    .replace(/[\[\{]/g, '(')   // ä¿®æ­£æ‹¬è™Ÿèª¤è®€
                    .replace(/[\]\}]/g, ')')
                    .replace(/O/g, '0')        // ä¿®æ­£æ•¸å­—èª¤è®€
                    .replace(/[Il|]/g, '1')
                    .replace(/S/g, '5')
                    .replace(/B/g, '8');

                // 4. è§£æ GS1-128 æ ¼å¼
                // ç”¢å“ç¢¼(01), æ•ˆæœŸ(17), åºè™Ÿ(21)
                const pCode = cleanText.match(/\(01\)(\d{13,14})/)?.[1];
                const eDate = cleanText.match(/\(17\)(\d{6})/)?.[1];
                const uuidMatch = cleanText.match(/\(21\)([A-Za-z0-9-]+)/)?.[1];
                
                // åªè¦ UUID å‰ 12 ç¢¼
                const shortUuid = uuidMatch ? uuidMatch.substring(0, 12) : null;

                if (shortUuid) {
                    const info = `âœ… è¾¨è­˜æˆåŠŸï¼\nåºè™Ÿ: ${shortUuid}\næ•ˆæœŸ: ${eDate || 'æœªæŠ“åˆ°'}\nç”¢å“ç¢¼: ${pCode || 'æœªæŠ“åˆ°'}`;
                    ocrStatus.innerText = info;
                    
                    // é€å¾€ API
                    await sendToDatabase(shortUuid, pCode, eDate);
                } else {
                    ocrStatus.innerHTML = `âŒ ç„¡æ³•ç²¾æº–è§£æã€‚<br>æŠ“åˆ°å­—ä¸²ç‚º: ${cleanText}<br>è«‹é‡æ–°æ‹æ”ï¼Œç¢ºä¿æ•¸å­—æ¸…æ™°ä¸”ç„¡åå…‰ã€‚`;
                }
            } catch (err) {
                ocrStatus.innerText = "å‡ºéŒ¯äº†: " + err.message;
            }
        };

        async function sendToDatabase(uuid, pcode, edate) {
            await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    item_uuid: uuid,
                    product_code: pcode,
                    expiry_date: edate,
                    from_loc: 'FACTORY',
                    to_loc: 'MAIN',
                    operator: 'OCR_Mobile'
                })
            });
            alert("è³‡æ–™å·²åŒæ­¥è‡³ Supabaseï¼");
        }

        async function preprocessImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.getElementById('debugCanvas');
                        const ctx = canvas.getContext('2d');
                        
                        // åªå–åœ–ç‰‡ä¸­é–“ 40% çš„å€åŸŸï¼Œæ¸›å°‘å¹²æ“¾ (Crop)
                        const cropHeight = img.height * 0.4;
                        canvas.width = img.width;
                        canvas.height = cropHeight;
                        
                        // å¥—ç”¨æ¿¾é¡ï¼šé»‘ç™½ + å¼·çƒˆå°æ¯”
                        ctx.filter = 'grayscale(100%) contrast(300%) brightness(110%)';
                        ctx.drawImage(img, 0, img.height * 0.3, img.width, cropHeight, 0, 0, img.width, cropHeight);
                        
                        canvas.style.display = 'block'; // é¡¯ç¤ºé è¦½åœ–æ–¹ä¾¿é™¤éŒ¯
                        resolve(canvas.toDataURL('image/jpeg', 0.9));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>