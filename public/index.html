<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¥­å‹™ç«¯å€‰å„²ç³»çµ±</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f4f4f9; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; }
        button { background: #7360f2; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        .stock-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .status-tag { background: #e0e0e0; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ¢ å…¬å¸ç¸½å€‰ç¾æ³</h2>
        <div id="summary">è®€å–ä¸­...</div>
    </div>

    <div class="card">
    <h2>ğŸ“¸ æ‹ç…§è¾¨è­˜å…¥åº« (OCR)</h2>
    <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none">
    <button onclick="document.getElementById('photoInput').click()">ğŸ“· æ‹æ”æ¢ç¢¼æ•¸å­—</button>
    <div id="ocrStatus"></div>
    </div>

    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script>
        // å¼•å…¥ Tesseract.js (å»ºè­°ç”¨ v4 ä»¥ä¸Šç‰ˆæœ¬ï¼Œè¾¨è­˜åŠ›æ›´å¼·)
        // <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>

        const photoInput = document.getElementById('photoInput');

        photoInput.onchange = async function() {
            const file = photoInput.files[0];
            if (!file) return;

            document.getElementById('ocrStatus').innerText = "ğŸ”¥ æ­£åœ¨é€²è¡Œæš´åŠ›è¾¨è­˜èˆ‡åœ–åƒé è™•ç†...";

            // 1. åœ–åƒé è™•ç†ï¼šè½‰æˆé»‘ç™½ã€å¢å¼·å°æ¯” (é€™å°è®€å–ç´°å°æ•¸å­—è‡³é—œé‡è¦)
            const processedImage = await preprocessImage(file);

            // 2. æš´åŠ›è¾¨è­˜æ¨¡å¼ï¼šé–‹å•Ÿè‡ªå‹•è½‰å‘ + é™åˆ¶å­—å…ƒé›† (åªèªæ•¸å­—ã€æ‹¬è™Ÿã€æ©«æ§“)
            Tesseract.recognize(processedImage, 'eng', {
                logger: m => console.log(m.status, Math.round(m.progress * 100) + "%"),
                // æ ¸å¿ƒè¨­å®šï¼šå˜—è©¦æ—‹è½‰ 0, 90, 180, 270 åº¦
                rotateAuto: true,
            }).then(async ({ data: { text } }) => {
                console.log("åŸå§‹è¾¨è­˜å…§å®¹:", text);

                // 3. æš´åŠ›ä¿®æ­£é‚è¼¯ï¼šè™•ç†å¸¸è¦‹èª¤è®€ (ä¾‹å¦‚ 0 è®Š O, 1 è®Š I, ( è®Š [ )
                let cleanText = text
                    .replace(/\s+/g, '')       // åˆªé™¤æ‰€æœ‰ç©ºç™½
                    .replace(/[\[\{]/g, '(')   // [ { è½‰æˆ (
                    .replace(/[\]\}]/g, ')')   // ] } è½‰æˆ )
                    .replace(/O/g, '0')        // O è½‰æˆ 0
                    .replace(/[Il|]/g, '1')    // I l | è½‰æˆ 1
                    .replace(/S/g, '5');       // S è½‰æˆ 5

                document.getElementById('ocrStatus').innerText = "è¾¨è­˜å®Œæˆï¼Œæ­£åœ¨æ‹†è§£...";

                // 4. æ­£å‰‡æŠ“å– (01), (17), (21)
                const pCode = cleanText.match(/\(01\)(\d{14})/)?.[1]; // ç”¢å“ç¢¼é€šå¸¸14ä½
                const eDate = cleanText.match(/\(17\)(\d{6})/)?.[1];  // æœ‰æ•ˆæ—¥æœŸé€šå¸¸6ä½
                const uuidMatch = cleanText.match(/\(21\)([\w-]+)/)?.[1];
                
                // æŠ“å– UUID å‰ 12 ç¢¼
                const shortUuid = uuidMatch ? uuidMatch.substring(0, 12) : null;

                if (shortUuid) {
                    alert(`âœ… æŠ“åˆ°åºè™Ÿï¼\nUUID: ${shortUuid}\næ•ˆæœŸ: ${eDate}\nç”¢å“ç¢¼: ${pCode}`);
                    // é€å¾€ API å­˜å…¥ Supabase... (ä»£ç¢¼åŒå‰)
                } else {
                    alert("âŒ è¾¨è­˜çµæœä¸å¤ æ¸…æ™°ï¼Œè«‹é è¿‘ä¸€é»æ‹æ•¸å­—ï¼\nè¾¨è­˜åˆ°çš„æ˜¯ï¼š" + cleanText);
                }
            });
        };

        // åœ–åƒé è™•ç†ï¼šæŠŠç…§ç‰‡è®Šæˆé©åˆ OCR çš„ã€Œé»‘ç™½é«˜å°æ¯”ã€
        async function preprocessImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        // è½‰æˆé»‘ç™½ä¸¦å¢åŠ å°æ¯”
                        ctx.filter = 'grayscale(100%) contrast(200%) brightness(120%)';
                        ctx.drawImage(img, 0, 0);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
    
    </script>
</body>
</html>