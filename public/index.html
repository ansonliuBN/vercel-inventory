<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¥­å‹™ç«¯å€‰å„²ç³»çµ±</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f4f4f9; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; }
        button { background: #7360f2; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        .stock-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .status-tag { background: #e0e0e0; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ¢ å…¬å¸ç¸½å€‰ç¾æ³</h2>
        <div id="summary">è®€å–ä¸­...</div>
    </div>

    <div class="card">
        <h2>ğŸ“· æ¢ç¢¼æƒæ (UUID)</h2>
        <div id="reader"></div>
        <div id="result" style="margin-top: 10px; color: green; font-weight: bold;"></div>
        <button onclick="startScan()">é–‹å•Ÿç›¸æ©Ÿæƒæ</button>
    </div>

    <script>
        const API_URL = '/api/stock';

        // 1. åˆ·æ–°ç¸½è¡¨æ•¸æ“š
        async function refreshSummary() {
            const res = await fetch(API_URL);
            const data = await res.json();
            const container = document.getElementById('summary');
            if (data.length === 0) { container.innerHTML = "ç›®å‰ç„¡åº«å­˜"; return; }
            
            container.innerHTML = data.map(item => `
                <div class="stock-item">
                    <span>ID: ${item.item_uuid.substring(0, 8)}...</span>
                    <span class="status-tag">${item.location}: ${item.current_stock}ä»¶</span>
                </div>
            `).join('');
        }

        // 2. åˆå§‹åŒ–æƒæå™¨é‚è¼¯
        function startScan() {
            const html5QrCode = new Html5Qrcode("reader");
            
            const config = { 
                fps: 20, // æé«˜åµæ¸¬é »ç‡
                qrbox: { width: 320, height: 100 }, // é‡å°é•·æ¢ç¢¼ï¼ŒæŠŠæ¡†æ¡†è¨­å¾—æ›´é•·æ›´æ‰
                aspectRatio: 1.0,
                // å¼·åˆ¶æŒ‡å®šåªæƒææ¢ç¢¼æ ¼å¼ (Code 128)ï¼Œæ¸›å°‘è¨ˆç®—è² æ“”æé«˜æº–ç¢ºç‡
                formatsToSupport: [ Html5QrcodeSupportedFormats.CODE_128 ]
            };

            html5QrCode.start(
                { facingMode: "environment" }, 
                config,
                async (decodedText) => {
                    // é€™è£¡æœƒæŠ“åˆ°é‚£ä¸€é•·ä¸²åŒ…å«æ‹¬è™Ÿçš„ UUID
                    document.getElementById('result').innerText = "è®€å–æˆåŠŸ: " + decodedText;
                    html5QrCode.pause();
                    
                    // é€™è£¡å¯ä»¥å¹«ä½ æ‹†è§£æ¢ç¢¼ (ä¾‹å¦‚ï¼š(21)å¾Œé¢æ‰æ˜¯çœŸæ­£çš„åºè™Ÿ)
                    // å¦‚æœä½ åªéœ€è¦æ•´ä¸²å­˜å…¥ï¼Œå°±ç…§èˆŠ
                    await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            item_uuid: decodedText,
                            from_loc: 'FACTORY',
                            to_loc: 'MAIN',
                            operator: 'æ¥­å‹™æƒæ'
                        })
                    });
                    alert("å…¥åº«æˆåŠŸï¼");
                    refreshSummary();
                    html5QrCode.resume();
                },
                (err) => { /* æƒæä¸­ */ }
            ).catch(err => alert("å•Ÿå‹•å¤±æ•—: " + err));
        }

        // ç¶²é é–‹å•Ÿè‡ªå‹•æ•´ç†
        refreshSummary();
    </script>
</body>
</html>