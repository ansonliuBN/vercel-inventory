<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¥­å‹™ç«¯å€‰å„²ç³»çµ±</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f4f4f9; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; }
        button { background: #7360f2; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        .stock-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .status-tag { background: #e0e0e0; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ¢ å…¬å¸ç¸½å€‰ç¾æ³</h2>
        <div id="summary">è®€å–ä¸­...</div>
    </div>

    <div class="card">
        <h2>ğŸ“· æ¢ç¢¼æƒæ (UUID)</h2>
        <div id="reader"></div>
        <div id="result" style="margin-top: 10px; color: green; font-weight: bold;"></div>
        <button onclick="startScan()">é–‹å•Ÿç›¸æ©Ÿæƒæ</button>
    </div>

    <script>
        const API_URL = '/api/stock';

        // 1. åˆ·æ–°ç¸½è¡¨æ•¸æ“š
        async function refreshSummary() {
            const res = await fetch(API_URL);
            const data = await res.json();
            const container = document.getElementById('summary');
            if (data.length === 0) { container.innerHTML = "ç›®å‰ç„¡åº«å­˜"; return; }
            
            container.innerHTML = data.map(item => `
                <div class="stock-item">
                    <span>ID: ${item.item_uuid.substring(0, 8)}...</span>
                    <span class="status-tag">${item.location}: ${item.current_stock}ä»¶</span>
                </div>
            `).join('');
        }

        // 2. åˆå§‹åŒ–æƒæå™¨é‚è¼¯
        function startScan() {
            const html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 150 } }; // æ¢ç¢¼è¼ƒé•·ï¼Œé«˜åº¦è¨­çª„ä¸€é»å¥½å°æº–

            html5QrCode.start(
                { facingMode: "environment" }, // å¼·åˆ¶ä½¿ç”¨å¾Œé¡é ­
                config,
                async (decodedText) => {
                    // æƒææˆåŠŸå¾Œçš„å‹•ä½œ
                    document.getElementById('result').innerText = "æƒææˆåŠŸ: " + decodedText;
                    
                    // æš«åœæƒæé¿å…é‡è¤‡é€å‡º
                    html5QrCode.pause();
                    
                    // é€å‡ºåˆ° API (é è¨­é€²è²¨åˆ°ç¸½å€‰)
                    await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            item_uuid: decodedText,
                            from_loc: 'FACTORY',
                            to_loc: 'MAIN',
                            operator: 'æ¥­å‹™ç¾å ´æƒæ'
                        })
                    });

                    alert("UUID " + decodedText + " å·²å…¥åº«ï¼");
                    refreshSummary();
                    html5QrCode.resume(); // æ¢å¾©æƒæ
                },
                (errorMessage) => { /* æƒæä¸­...ä¸å ±éŒ¯ */ }
            );
        }

        // ç¶²é é–‹å•Ÿè‡ªå‹•æ•´ç†
        refreshSummary();
    </script>
</body>
</html>