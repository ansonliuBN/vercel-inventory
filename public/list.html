<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: white; margin: 0; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #eee; color: #666; font-size: 14px; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: top; }

        /* æ¯”ä¾‹é–å®š */
        .col-loc { width: 15%; }
        .col-name { width: 30%; }
        .col-exp { width: 15%; }
        .col-qty { width: 10%; text-align: center; }
        .col-note {
            width: 30%;
            white-space: normal;    /* âœ… ä¸ä¿ç•™ \n */
            overflow-wrap: anywhere;  /* âœ… æœ€é‡è¦ï¼šå¼·åˆ¶ä»»ä½•åœ°æ–¹éƒ½èƒ½æ›è¡Œ */
            word-break: break-word;
            color: #666;
            line-height: 1.5;
            }

        .urgent { color: #d9534f; font-weight: bold; }
        .plus-btn { display:inline; color: #007bff; font-weight: bold; cursor: pointer; margin-left: 5px; font-size: 16px; }

        /* å½ˆå‡ºè¦–çª—æ¨£å¼ */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; }
        .modal h3 { margin-top: 0; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 20px; cursor: pointer; color: #999; }
        .stock-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }

        /* ç¾¤çµ„åˆ—ï¼ˆä½ç½®ï¼‰ */
        .group-row td{
        background:#f8f9fa;
        font-weight:700;
        border-bottom: 1px solid #eee;
        }

        .group-title{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        }

        .caret{
        display:inline-block;
        width:18px;
        text-align:center;
        margin-right:6px;
        color:#666;
        }

        .badge{
        background:#eef2ff;
        border-radius:999px;
        padding:2px 10px;
        font-size:12px;
        color:#374151;
        }

        /* å­åˆ—ç¸®æ’ï¼Œåšå‡ºæ¨¹ç‹€æ„Ÿ */
        .child-row td:first-child{
        padding-left: 36px;        /* âœ… ç¸®æ’ */
        position: relative;
        }
        .child-row td:first-child::before{
        content:"";
        position:absolute;
        left:18px;
        top:0;
        bottom:0;
        width:1px;
        background:#eee;           /* âœ… ç›´ç·š */
        }
        .child-row td:first-child::after{
        content:"";
        position:absolute;
        left:18px;
        top:22px;
        width:12px;
        height:1px;
        background:#eee;           /* âœ… æ©«ç·š */
        }

        .hidden{ display:none; }

        /* å‚™è¨»ä¸è¦æŠŠé«˜åº¦æ’çˆ† */
        .col-note{
        white-space: normal;
        overflow-wrap:anywhere;
        word-break:break-word;
        line-height:1.4;
        }
        .plus-btn{ display:inline; }
    

        /* ä½ çš„æ¬„å¯¬è¦å‰‡ç…§ç”¨ */
        .col-loc { width: 15%; }
        .col-name { width: 30%; }
        .col-exp { width: 15%; }
        .col-qty { width: 10%; text-align: center; }
        .col-note {
        width: 30%;
        white-space: pre-wrap;
        overflow-wrap: anywhere;
        word-break: break-word;
        color: #666;
        line-height: 1.5;
        }


        /* ç¾¤çµ„å…§å®¹å€å¡Šï¼šç”¨ class æ§åˆ¶é¡¯ç¤º/éš±è— */
        .hidden-rows { display:none; }

    </style>
</head>
<body>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <h2 style="margin:0;">ğŸ“¦ åº«å­˜å¯¦æ™‚ç¸½è¡¨ (æ•´åˆç‰ˆ)</h2>
    <button onclick="load()" style="padding: 8px 15px; cursor: pointer; border-radius: 6px; border: 1px solid #ddd;">ğŸ”„ åˆ·æ–°</button>
</div>
<div id="list"></div>
<table>
    <thead>
        <tr>
            <th class="col-loc">ä½ç½®</th>
            <th class="col-name">ç”¢å“åç¨±</th>
            <th class="col-exp">æ•ˆæœŸ</th>
            <th class="col-qty">æ•¸é‡</th>
            <th class="col-note">å‚™è¨»</th>
        </tr>
    </thead>
</table>

<div id="modal-overlay" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeModal()">Ã—</span>
        <h3 id="modal-title">é†«é™¢å›ºå®šåº«å­˜</h3>
        <div id="modal-body">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<script>
    async function load() {
    const { data: summary, error } = await _supabase.from('inventory_summary').select('*');
    if (error) return;

    // å›ºå®šåº«å­˜åœ°é»é›†åˆï¼ˆæ±ºå®šæ˜¯å¦é¡¯ç¤º [+]ï¼‰
    const { data: hsLocs } = await _supabase.from('hospital_stock').select('location_name');
    const hasFixedStockSet = new Set((hsLocs || []).map(x => x.location_name).filter(Boolean));

    // æ’åºï¼šæ¥­å‹™å€‰åº«ç½®é ‚ï¼Œå…¶å®ƒä¾ location
    summary.sort((a, b) => {
        const aBiz = a.location === 'æ¥­å‹™å€‰åº«';
        const bBiz = b.location === 'æ¥­å‹™å€‰åº«';
        if (aBiz && !bBiz) return -1;
        if (!aBiz && bBiz) return 1;
        return String(a.location||'').localeCompare(String(b.location||''), 'zh-Hant');
    });

    // åˆ†çµ„
    const groups = new Map();
    for (const item of summary) {
        const loc = item.location || 'æœªåˆ†é¡';
        if (!groups.has(loc)) groups.set(loc, []);
        groups.get(loc).push(item);
    }

    const limitDate = new Date();
    limitDate.setMonth(limitDate.getMonth() + 3);

    let html = '';
    let idx = 0;

    for (const [loc, items] of groups.entries()) {
        const gid = `g${idx++}`;
        const count = items.length;

        // ç¾¤çµ„åˆ—ï¼ˆä½ç½®ï¼‰
        html += `
        <tr class="group-row" onclick="toggleGroup('${gid}', event)">
            <td colspan="5">
            <div class="group-title">
                <div><span class="caret" id="${gid}_caret">â–¼</span>ğŸ“ ${loc}</div>
                <div style="display:flex; gap:10px; align-items:center;">
                <span class="badge">${count} ç­†</span>
                <span style="font-size:12px; color:#666;">é»æ“Šå±•é–‹/æ”¶åˆ</span>
                </div>
            </div>
            </td>
        </tr>
        `;

        // å­åˆ—ï¼ˆå“é …ï¼‰
        for (const i of items) {
        const isUrgent = i.expiry_date && new Date(i.expiry_date) < limitDate;
        const displayName = i.friendly_name || i.product_code || 'æœªçŸ¥ç”¢å“';

        // å‚™è¨»æ¸…ç†ï¼šé¿å…å¤šé¤˜ç©ºè¡ŒæŠŠé«˜åº¦æ’çˆ†
        const note = (i.location_note || '-')
            .replace(/\r/g,'')
            .replace(/\n{2,}/g,'\n')
            .trim();

        const showPlus = hasFixedStockSet.has(loc) && loc !== 'CONSUMED';

        html += `
            <tr class="child-row ${gid}">
            <td class="col-loc"><b>${loc}</b></td>
            <td class="col-name">
                <div style="font-weight:bold;">${displayName}</div>
                <div style="font-size:11px; color:#999;">${i.product_code || ''}</div>
            </td>
            <td class="col-exp ${isUrgent ? 'urgent' : ''}">${i.expiry_date || '-'}</td>
            <td class="col-qty"><b>${i.total_stock ?? 0}</b></td>
            <td class="col-note">
                ${note || '-'}
                ${showPlus ? `<span class="plus-btn" onclick="openModal('${loc}'); event.stopPropagation();" title="æŸ¥çœ‹å›ºå®šåº«å­˜">[+]</span>` : ``}
            </td>
            </tr>
        `;
        }
    }

    document.getElementById('list').innerHTML = html;
    }


    function toggleGroup(gid, evt){
    // é˜²æ­¢é»åˆ° [+] çš„æ™‚å€™ä¹Ÿè§¸ç™¼ç¾¤çµ„
    if (evt && evt.target && String(evt.target.className).includes('plus-btn')) return;

    const rows = document.querySelectorAll(`.${gid}`);
    const caret = document.getElementById(`${gid}_caret`);
    const isHidden = rows.length > 0 && rows[0].classList.contains('hidden');

    rows.forEach(r => r.classList.toggle('hidden', !isHidden));
    caret.textContent = isHidden ? 'â–¼' : 'â–¶';
    }

    // ä½ åŸæœ¬çš„ openModal/closeModal å¯ä¿ç•™
    // openModal è¨˜å¾— event.stopPropagation() æˆ‘å·²ç¶“åŠ åœ¨ [+] ä¸Šäº†ï¼Œé¿å…é» [+] ä¹ŸæŠŠç¾¤çµ„æ”¶åˆ

    async function openModal(locName) {
    if (!locName || locName === 'CONSUMED') return;

    const overlay = document.getElementById('modal-overlay');
    const title = document.getElementById('modal-title');
    const body = document.getElementById('modal-body');

    overlay.style.display = 'flex';
    title.innerText = `ğŸ¥ ${locName} å›ºå®šåº«å­˜`;
    body.innerHTML = 'è®€å–ä¸­...';

    const { data, error } = await _supabase
        .from('hospital_stock')
        .select('item_name, quantity, unit, note, updated_at')
        .eq('location_name', locName)
        .order('item_name', { ascending: true });

    if (error) {
        body.innerHTML = `<p style="color:#d9534f;">è®€å–å¤±æ•—ï¼š${error.message}</p>`;
        return;
    }

    if (data && data.length > 0) {
        body.innerHTML = data.map(d => `
        <div style="padding:10px 0; border-bottom:1px solid #f0f0f0;">
            <div style="display:flex; justify-content:space-between; gap:12px;">
            <b style="flex:1; overflow-wrap:anywhere;">${d.item_name}</b>
            <span style="white-space:nowrap;">${d.quantity ?? 0} ${d.unit || ''}</span>
            </div>
            <div style="font-size:12px; color:#888; margin-top:4px; white-space:pre-wrap; overflow-wrap:anywhere;">
            ${d.note ? d.note : '<ç„¡å‚™è¨»>'}
            </div>
        </div>
        `).join('');
    } else {
        body.innerHTML = '<p style="color:#999; text-align:center;">ç„¡å›ºå®šåº«å­˜ç´€éŒ„</p>';
    }
    }


    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
    }

    load();
</script>
</body>
</html>