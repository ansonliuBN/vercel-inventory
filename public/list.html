<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: white; margin: 0; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #eee; color: #666; font-size: 14px; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: top; }

        /* æ¯”ä¾‹é–å®š */
        .col-loc { width: 15%; }
        .col-name { width: 30%; }
        .col-exp { width: 15%; }
        .col-qty { width: 10%; text-align: center; }
        .col-note {
            width: 30%;
            white-space: pre-wrap;
            overflow-wrap: anywhere;  /* âœ… æœ€é‡è¦ï¼šå¼·åˆ¶ä»»ä½•åœ°æ–¹éƒ½èƒ½æ›è¡Œ */
            word-break: break-word;
            color: #666;
            line-height: 1.5;
            }

        .urgent { color: #d9534f; font-weight: bold; }
        .plus-btn { color: #007bff; font-weight: bold; cursor: pointer; margin-left: 5px; font-size: 16px; }

        /* å½ˆå‡ºè¦–çª—æ¨£å¼ */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; }
        .modal h3 { margin-top: 0; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 20px; cursor: pointer; color: #999; }
        .stock-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }

        /* ç¾¤çµ„åˆ— */
        .group {
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 0;
        margin: 12px 0;
        overflow: hidden;
        background: white;
        }

        .group summary{
        list-style: none;
        cursor: pointer;
        padding: 12px 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
        font-weight: 700;
        }

        .group summary::-webkit-details-marker { display:none; }

        .group .meta{
        display:flex; gap:10px; align-items:center;
        font-weight: 600;
        color:#666;
        font-size: 12px;
        }

        .group .badge{
        background:#eef2ff;
        color:#374151;
        padding:2px 10px;
        border-radius:999px;
        font-size:12px;
        font-weight:700;
        }

        .group .inner{
        padding: 0;
        }

        .group table{
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        }

        .group th, .group td{
        padding: 12px;
        border-bottom: 1px solid #eee;
        vertical-align: top;
        }

        .group thead th{
        background:#fff;
        color:#666;
        font-size: 13px;
        border-bottom: 2px solid #eee;
        }

        /* ä½ çš„æ¬„å¯¬è¦å‰‡ç…§ç”¨ */
        .col-loc { width: 15%; }
        .col-name { width: 30%; }
        .col-exp { width: 15%; }
        .col-qty { width: 10%; text-align: center; }
        .col-note {
        width: 30%;
        white-space: pre-wrap;
        overflow-wrap: anywhere;
        word-break: break-word;
        color: #666;
        line-height: 1.5;
        }


        /* ç¾¤çµ„å…§å®¹å€å¡Šï¼šç”¨ class æ§åˆ¶é¡¯ç¤º/éš±è— */
        .hidden-rows { display:none; }

    </style>
</head>
<body>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <h2 style="margin:0;">ğŸ“¦ åº«å­˜å¯¦æ™‚ç¸½è¡¨ (æ•´åˆç‰ˆ)</h2>
    <button onclick="load()" style="padding: 8px 15px; cursor: pointer; border-radius: 6px; border: 1px solid #ddd;">ğŸ”„ åˆ·æ–°</button>
</div>
<div id="list"></div>
<table>
    <thead>
        <tr>
            <th class="col-loc">ä½ç½®</th>
            <th class="col-name">ç”¢å“åç¨±</th>
            <th class="col-exp">æ•ˆæœŸ</th>
            <th class="col-qty">æ•¸é‡</th>
            <th class="col-note">å‚™è¨»</th>
        </tr>
    </thead>
</table>

<div id="modal-overlay" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeModal()">Ã—</span>
        <h3 id="modal-title">é†«é™¢å›ºå®šåº«å­˜</h3>
        <div id="modal-body">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<script>
    async function load() {
    const { data: summary, error } = await _supabase.from('inventory_summary').select('*');
    if (error) return;

    // ä¸€æ¬¡æŠ“å‡ºå“ªäº›åœ°é»æœ‰å›ºå®šåº«å­˜ï¼ˆæ±ºå®šè¦ä¸è¦é¡¯ç¤º [+]ï¼‰
    const { data: hsLocs } = await _supabase.from('hospital_stock').select('location_name');
    const hasFixedStockSet = new Set((hsLocs || []).map(x => x.location_name).filter(Boolean));

    // æ¥­å‹™å€‰åº«ç½®é ‚ + å…¶é¤˜ç…§ location æ’
    summary.sort((a, b) => {
        const aBiz = a.location === 'æ¥­å‹™å€‰åº«';
        const bBiz = b.location === 'æ¥­å‹™å€‰åº«';
        if (aBiz && !bBiz) return -1;
        if (!aBiz && bBiz) return 1;
        return String(a.location || '').localeCompare(String(b.location || ''), 'zh-Hant');
    });

    // åˆ†çµ„
    const groups = new Map();
    for (const item of summary) {
        const loc = item.location || 'æœªåˆ†é¡';
        if (!groups.has(loc)) groups.set(loc, []);
        groups.get(loc).push(item);
    }

    const limitDate = new Date();
    limitDate.setMonth(limitDate.getMonth() + 3);

    // æ¸²æŸ“æˆã€Œå¡ç‰‡ç¾¤çµ„ã€
    let html = '';
    for (const [loc, items] of groups.entries()) {
        // é è¨­ï¼šæ¥­å‹™å€‰åº«å±•é–‹ï¼Œå…¶å®ƒæ”¶åˆï¼ˆä½ ä¹Ÿå¯ä»¥å…¨éƒ¨å±•é–‹ï¼šæŠŠ open æ‹¿æ‰ï¼‰
        const openAttr = (loc === 'æ¥­å‹™å€‰åº«') ? 'open' : '';

        const rowsHtml = items.map(i => {
        const isUrgent = i.expiry_date && new Date(i.expiry_date) < limitDate;
        const displayName = i.friendly_name || i.product_code || 'æœªçŸ¥ç”¢å“';

        const showPlus =
            hasFixedStockSet.has(loc) &&
            loc !== 'æ¥­å‹™å€‰åº«' &&
            loc !== 'CONSUMED';

        return `
            <tr>
            <td class="col-loc"><b>${loc}</b></td>
            <td class="col-name">
                <div style="font-weight:bold;">${displayName}</div>
                <div style="font-size:11px; color:#999;">${i.product_code || ''}</div>
            </td>
            <td class="col-exp ${isUrgent ? 'urgent' : ''}">${i.expiry_date || '-'}</td>
            <td class="col-qty"><b>${i.total_stock ?? '-'}</b></td>
            <td class="col-note">
                ${i.location_note || '-'}
                ${showPlus ? `<span class="plus-btn" onclick="openModal('${loc}'); event.stopPropagation();" title="æŸ¥çœ‹å›ºå®šåº«å­˜">[+]</span>` : ``}
            </td>
            </tr>
        `;
        }).join('');

        html += `
        <details class="group" ${openAttr}>
            <summary>
            <div>ğŸ“ ${loc}</div>
            <div class="meta">
                <span class="badge">${items.length} ç­†</span>
                <span>é»æ“Šå±•é–‹/æ”¶åˆ</span>
            </div>
            </summary>

            <div class="inner">
            <table>
                <thead>
                <tr>
                    <th class="col-loc">ä½ç½®</th>
                    <th class="col-name">ç”¢å“åç¨±</th>
                    <th class="col-exp">æ•ˆæœŸ</th>
                    <th class="col-qty">æ•¸é‡</th>
                    <th class="col-note">å‚™è¨»</th>
                </tr>
                </thead>
                <tbody>
                ${rowsHtml}
                </tbody>
            </table>
            </div>
        </details>
        `;
    }

    // ç”¨ div å®¹å™¨å–ä»£åŸæœ¬ table çš„ tbody
    document.getElementById('list').innerHTML = html;
    }


    function toggleGroup(groupId){
        const rows = document.querySelectorAll(`.${groupId}`);
        const icon = document.getElementById(`${groupId}_icon`);
        const isHidden = rows.length > 0 && rows[0].classList.contains('hidden-rows');

        rows.forEach(r => r.classList.toggle('hidden-rows', !isHidden));
        icon.innerText = isHidden ? 'é»æ“Šæ”¶åˆ â–²' : 'é»æ“Šå±•é–‹ â–¼';
    }

    // ä½ åŸæœ¬çš„ openModal/closeModal å¯ä¿ç•™
    // openModal è¨˜å¾— event.stopPropagation() æˆ‘å·²ç¶“åŠ åœ¨ [+] ä¸Šäº†ï¼Œé¿å…é» [+] ä¹ŸæŠŠç¾¤çµ„æ”¶åˆ


    async function openModal(locName) {
        if (locName === 'æ¥­å‹™å€‰åº«' || locName === 'CONSUMED') {
            alert("æ­¤åœ°é»ç„¡å›ºå®šåº«å­˜è³‡æ–™");
            return;
        }
        
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('modal-title').innerText = `ğŸ¥ ${locName} å›ºå®šåº«å­˜`;
        document.getElementById('modal-body').innerHTML = 'è®€å–ä¸­...';

        const { data, error } = await _supabase.from('hospital_stock')
            .select('*')
            .eq('location_name', locName);

        if (!data || data.length === 0) {
            document.getElementById('modal-body').innerHTML = '<p style="color:#999; text-align:center;">ç›®å‰ç„¡å›ºå®šåº«å­˜ç´€éŒ„</p>';
            return;
        }

        document.getElementById('modal-body').innerHTML = data.map(d => `
            <div class="stock-item">
                <span><b>${d.item_name}</b></span>
                <span>${d.quantity} ${d.unit}</span>
            </div>
        `).join('');
    }

    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
    }

    load();
</script>
</body>
</html>