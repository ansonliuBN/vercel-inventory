<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: white; margin: 0; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #eee; color: #666; font-size: 14px; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .urgent { color: red; font-weight: bold; }
        .col-note { 
            width: 42%; 
            white-space: pre-wrap; /* ğŸ’¡ é—œéµï¼šé€™è¡Œèƒ½è®“å‚™è¨»è£¡çš„æ›è¡Œç”Ÿæ•ˆ */
            word-wrap: break-word;
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2>ğŸ“¦ åº«å­˜å¯¦æ™‚ç¸½è¡¨</h2>
        <button onclick="load()">ğŸ”„ åˆ·æ–°</button>
    </div>

    <table>
        <thead>
            <tr><th>ä½ç½®</th><th>ç”¢å“/åºè™Ÿ</th><th>æ•ˆæœŸ</th><th>æ•¸é‡</th><th>å‚™è¨»</th></tr>
        </thead>
        <tbody id="list">
            <tr><td colspan="5" style="text-align:center;">è¼‰å…¥ä¸­...</td></tr>
        </tbody>
    </table>

    <script>

        async function load() {
            const { data, error } = await _supabase.from('inventory_summary').select('*');
            if (error) return console.error(error);

            // æ’åºï¼šæ¥­å‹™å€‰åº«ç¬¬ä¸€ > è¿‘æœŸæ´»èº > æ•ˆæœŸ
            data.sort((a, b) => {
                if (a.location === 'æ¥­å‹™å€‰åº«') return -1;
                if (b.location === 'æ¥­å‹™å€‰åº«') return 1;
                if (a.last_active !== b.last_active) return new Date(b.last_active) - new Date(a.last_active);
                return new Date(a.expiry_date) - new Date(b.expiry_date);
            });

            const limitDate = new Date();
            limitDate.setMonth(limitDate.getMonth() + 3);

            document.getElementById('list').innerHTML = data.map(i => {
                const prefix = i.product_code ? i.product_code.split('-')[0] : '';
                const friendlyName = productNames[prefix] || i.product_code || 'æœªçŸ¥ç”¢å“';
                const isUrgent = i.expiry_date && new Date(i.expiry_date) < limitDate;

                // ğŸ’¡ é€™è£¡è®Šç°¡å–®äº†ï¼Œç›´æ¥æ‹¿è³‡æ–™åº«å‚³å›ä¾†çš„åç¨±ï¼Œæ²’æœ‰çš„è©±é¡¯ç¤ºç”¢å“ä»£ç¢¼
                const displayName = i.friendly_name || i.product_code || 'æœªçŸ¥ç”¢å“';

                return `
                    <tr>
                        <td><b>${i.location}</b></td>
                        <td>
                            <div style="font-weight:bold;">${friendlyName}</div>
                            <div style="font-size:11px; color:#999;">${i.item_uuid}</div>
                        </td>
                        <td class="${isUrgent ? 'urgent' : ''}">${i.expiry_date || '-'}</td>
                        <td style="text-align:center;">${i.current_stock}</td>
                        <td style="font-size:12px; color:#666;">${i.location_note || '-'}</td>
                    </tr>
                `;
            }).join('');
        }
        load(); // é é¢è¼‰å…¥è‡ªå‹•åŸ·è¡Œ
    </script>
</body>
</html>