<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: white; margin: 0; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; } /* é–å®šæ¯”ä¾‹ä½ˆå±€ */
        
        th { background: #f8f9fa; padding: 12px 8px; text-align: left; border-bottom: 2px solid #eee; color: #666; font-size: 14px; }
        td { padding: 12px 8px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: top; word-break: break-all; }

        /* --- æ¯”ä¾‹é–å®š --- */
        .col-loc { width: 12%; }   /* ä½ç½®ï¼šå° */
        .col-name { width: 25%; }  /* ç”¢å“ï¼šä¸­ */
        .col-exp { width: 13%; }   /* æ•ˆæœŸï¼šå° */
        .col-qty { width: 8%; text-align: center; } /* æ•¸é‡ï¼šæœ€å° */
        .col-note { 
            width: 42%;            /* å‚™è¨»ï¼šæœ€å¤§ */
            white-space: pre-wrap; /* ğŸ’¡ æ”¯æ´ Enter æ–·è¡Œ */
            color: #555;
            line-height: 1.5;
        }

        .urgent { color: red; font-weight: bold; }
        .row-biz { background: #f0f7ff; } /* æ¥­å‹™å€‰åº«é«˜äº® */
    </style>
</head>
<body>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 style="margin:0;">ğŸ“¦ åº«å­˜å¯¦æ™‚ç¸½è¡¨</h2>
        <button onclick="load()" style="padding: 8px 15px; cursor: pointer; border-radius: 5px; border: 1px solid #ddd;">ğŸ”„ åˆ·æ–°æ•¸æ“š</button>
    </div>

    <table>
        <thead>
            <tr>
                <th class="col-loc">ä½ç½®</th>
                <th class="col-name">ç”¢å“ / åºè™Ÿ</th>
                <th class="col-exp">æ•ˆæœŸ</th>
                <th class="col-qty">æ•¸é‡</th>
                <th class="col-note">å‚™è¨»</th>
            </tr>
        </thead>
        <tbody id="list">
            <tr><td colspan="5" style="text-align:center; padding:30px;">è¼‰å…¥ä¸­...</td></tr>
        </tbody>
    </table>

    <script>
        async function load() {
            const { data, error } = await _supabase.from('inventory_summary').select('*');
            if (error) return console.error(error);

            // æ’åºé‚è¼¯
            data.sort((a, b) => {
                if (a.location === 'æ¥­å‹™å€‰åº«') return -1;
                if (b.location === 'æ¥­å‹™å€‰åº«') return 1;
                if (a.last_active !== b.last_active) return new Date(b.last_active) - new Date(a.last_active);
                return new Date(a.expiry_date) - new Date(b.expiry_date);
            });

            const limitDate = new Date();
            limitDate.setMonth(limitDate.getMonth() + 3);

            document.getElementById('list').innerHTML = data.map(i => {
                const isUrgent = i.expiry_date && new Date(i.expiry_date) < limitDate;
                // ğŸ’¡ ç›´æ¥ä½¿ç”¨è³‡æ–™åº«æŠ“å›ä¾†çš„ friendly_name
                const displayName = i.friendly_name || i.product_code || 'æœªçŸ¥ç”¢å“';

                return `
                    <tr class="${i.location === 'æ¥­å‹™å€‰åº«' ? 'row-biz' : ''}">
                        <td><b>${i.location}</b></td>
                        <td>
                            <div style="font-weight:bold; color:#333;">${displayName}</div>
                            <div style="font-size:11px; color:#999; margin-top:2px;">${i.item_uuid}</div>
                        </td>
                        <td class="${isUrgent ? 'urgent' : ''}">${i.expiry_date || '-'}</td>
                        <td style="text-align:center;"><b>${i.current_stock}</b></td>
                        <td class="col-note">${i.location_note || '-'}</td>
                    </tr>
                `;
            }).join('');
        }
        load();
    </script>
</body>
</html>