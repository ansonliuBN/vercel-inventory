<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€—æç®¡ç†ç³»çµ± v2.7</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        :root { --primary: #007bff; --bg: #f4f7f9; --nav-h: 65px; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; overflow: hidden; }

        .navbar { 
            background: white; height: var(--nav-h); padding: 0 20px; 
            display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 1px solid #ddd; position: fixed; top: 0; width: 100%; box-sizing: border-box; z-index: 1000; 
        }
        .logo { font-size: 18px; font-weight: bold; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        /* é›»è…¦ç‰ˆé¸å–® */
        .nav-links { display: flex; gap: 8px; }
        .nav-btn { background: #fff; border: 1px solid #ddd; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* æ‰‹æ©Ÿæ¼¢å ¡é¸å–® */
        .burger { display: none; font-size: 28px; cursor: pointer; }

        @media (max-width: 850px) {
            .burger { display: block; }
            .nav-links { 
                display: none; position: absolute; top: var(--nav-h); left: 0; width: 100%; 
                background: white; flex-direction: column; padding: 10px; border-bottom: 1px solid #ddd; 
                box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            }
            .nav-links.active { display: flex; } /* ä¸‹æ»‘é¡¯ç¤º */
            .nav-btn { width: 100%; text-align: left; border: none; padding: 15px; }
        }

        /* å…§å®¹å®¹å™¨ï¼šå·¦å³ç•™ç™½ */
        .main-wrapper { 
            margin-top: var(--nav-h); height: calc(100vh - var(--nav-h)); padding: 20px; 
            max-width: 1400px; margin-left: auto; margin-right: auto; box-sizing: border-box; 
        }
        .frame-box { width: 100%; height: 100%; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>
    <nav class="navbar" id="app-bar" style="display:none;">
        <div class="logo">è€—æç®¡ç†ç³»çµ±</div>
        <div class="burger" onclick="toggleMenu()">â˜°</div>
        <div class="nav-links" id="menu">
            <button class="nav-btn active" onclick="go('list.html', this)">ğŸ“¦ åº«å­˜ç¸½è¡¨</button>
            <button class="nav-btn" onclick="go('scan.html', this)">âœ¨ æ–°è²¨å…¥åº«</button>
            <button class="nav-btn" onclick="go('transfer.html', this)">ğŸšš æ’¥è£œç™¼è²¨</button>
            <button class="nav-btn" onclick="go('consume.html', this)">ğŸ¥ é†«é™¢é ˜ç”¨</button>
            <button class="nav-btn" onclick="go('hospital.html', this)">ğŸ› ï¸ é†«é™¢ç®¡ç†</button>
            <button onclick="logout()" style="color:red; background:none; border:none; padding:15px;">ç™»å‡º</button>
        </div>
    </nav>
    <main class="main-wrapper" id="app-content" style="display:none;">
        <div class="frame-box"><iframe id="sub-page" src="list.html"></iframe></div>
    </main>
    <script>
        // æ ¹æ“š image_0550db.png å»ºç«‹çš„æ¯”å°è¡¨
        const productNames = {
            'FPSD0101': 'Surgical Equipment Drape Packs',
            'FPIR0211': 'Instrument Registration Platform Cover',
            'FPEN1774': 'Lens 2D'
        };

        async function load() {
            const { data } = await _supabase.from('inventory_summary').select('*');
            
            // æ™ºæ…§æ’åºï¼šæ¥­å‹™å€‰åº«ç½®é ‚ > è¿‘æœŸæ´»èº > æ•ˆæœŸ
            data.sort((a, b) => {
                if (a.location === 'æ¥­å‹™å€‰åº«') return -1;
                if (b.location === 'æ¥­å‹™å€‰åº«') return 1;
                if (a.last_active !== b.last_active) return new Date(b.last_active) - new Date(a.last_active);
                return new Date(a.expiry_date) - new Date(b.expiry_date);
            });

            const today = new Date();
            const limitDate = new Date();
            limitDate.setMonth(today.getMonth() + 3);

            document.getElementById('list').innerHTML = data.map(i => {
                // è§£æç”¢å“åç¨±ï¼šæŠ“å– - å‰é¢çš„ä»£ç¢¼ (ä¾‹å¦‚ FPSD0101-G02 -> FPSD0101)
                const prefix = i.product_code ? i.product_code.split('-')[0] : '';
                const friendlyName = productNames[prefix] || i.product_code || 'æœªçŸ¥ç”¢å“';
                
                // æ•ˆæœŸåˆ¤å®š
                const expDate = new Date(i.expiry_date);
                const isUrgent = i.expiry_date && expDate < limitDate;

                return `
                    <tr>
                        <td><b>${i.location}</b></td>
                        <td>
                            <div style="font-weight:bold; color:#333;">${friendlyName}</div>
                            <div style="font-size:11px; color:#999;">${i.item_uuid}</div>
                        </td>
                        <td style="color:${isUrgent ? 'red' : '#333'}; font-weight:${isUrgent ? 'bold' : 'normal'}">
                            ${i.expiry_date || '-'}
                        </td>
                        <td style="text-align:center;">${i.current_stock}</td>
                        <td style="min-width:250px; font-size:13px; color:#666;">${i.location_note || '-'}</td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>