<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: white; margin: 0; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #eee; color: #666; font-size: 14px; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: top; }

        /* æ¯”ä¾‹é–å®š */
        .col-loc { width: 15%; }
        .col-name { width: 30%; }
        .col-exp { width: 15%; }
        .col-qty { width: 10%; text-align: center; }
        .col-note { width: 30%; white-space: pre-wrap; word-wrap: break-word; color: #666; line-height: 1.5; }

        .urgent { color: #d9534f; font-weight: bold; }
        .plus-btn { color: #007bff; font-weight: bold; cursor: pointer; margin-left: 5px; font-size: 16px; }

        /* å½ˆå‡ºè¦–çª—æ¨£å¼ */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; }
        .modal h3 { margin-top: 0; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 20px; cursor: pointer; color: #999; }
        .stock-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
    </style>
</head>
<body>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <h2 style="margin:0;">ğŸ“¦ åº«å­˜å¯¦æ™‚ç¸½è¡¨ (æ•´åˆç‰ˆ)</h2>
    <button onclick="load()" style="padding: 8px 15px; cursor: pointer; border-radius: 6px; border: 1px solid #ddd;">ğŸ”„ åˆ·æ–°</button>
</div>

<table>
    <thead>
        <tr>
            <th class="col-loc">ä½ç½®</th>
            <th class="col-name">ç”¢å“åç¨±</th>
            <th class="col-exp">æ•ˆæœŸ</th>
            <th class="col-qty">æ•¸é‡</th>
            <th class="col-note">å‚™è¨»</th>
        </tr>
    </thead>
    <tbody id="list"></tbody>
</table>

<div id="modal-overlay" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeModal()">Ã—</span>
        <h3 id="modal-title">é†«é™¢å›ºå®šåº«å­˜</h3>
        <div id="modal-body">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<script>
    async function load() {
        const { data, error } = await _supabase.from('inventory_summary').select('*');
        if (error) return;

        // æ’åºï¼šæ¥­å‹™å€‰åº«ç½®é ‚
        data.sort((a,b) => (a.location === 'æ¥­å‹™å€‰åº«' ? -1 : 1));

        const limitDate = new Date();
        limitDate.setMonth(limitDate.getMonth() + 3);

        document.getElementById('list').innerHTML = data.map(i => {
            const isUrgent = i.expiry_date && new Date(i.expiry_date) < limitDate;
            const displayName = i.friendly_name || i.product_code || 'æœªçŸ¥ç”¢å“';

            return `
                <tr>
                    <td><b>${i.location}</b></td>
                    <td>
                        <div style="font-weight:bold;">${displayName}</div>
                        <div style="font-size:11px; color:#999;">${i.product_code}</div>
                    </td>
                    <td class="${isUrgent ? 'urgent' : ''}">${i.expiry_date || '-'}</td>
                    <td style="text-align:center;"><b>${i.total_stock}</b></td>
                    <td class="col-note">
                        ${i.location_note || '-'}
                        <span class="plus-btn" onclick="openModal('${i.location}')" title="æŸ¥çœ‹å›ºå®šåº«å­˜">[+]</span>
                    </td>
                </tr>
            `;
        }).join('');
    }

    async function openModal(locName) {
        if (locName === 'æ¥­å‹™å€‰åº«' || locName === 'CONSUMED') {
            alert("æ­¤åœ°é»ç„¡å›ºå®šåº«å­˜è³‡æ–™");
            return;
        }
        
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('modal-title').innerText = `ğŸ¥ ${locName} å›ºå®šåº«å­˜`;
        document.getElementById('modal-body').innerHTML = 'è®€å–ä¸­...';

        const { data, error } = await _supabase.from('hospital_stock')
            .select('*')
            .eq('location_name', locName);

        if (!data || data.length === 0) {
            document.getElementById('modal-body').innerHTML = '<p style="color:#999; text-align:center;">ç›®å‰ç„¡å›ºå®šåº«å­˜ç´€éŒ„</p>';
            return;
        }

        document.getElementById('modal-body').innerHTML = data.map(d => `
            <div class="stock-item">
                <span><b>${d.item_name}</b></span>
                <span>${d.quantity} ${d.unit}</span>
            </div>
        `).join('');
    }

    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
    }

    load();
</script>
</body>
</html>