<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>

  <style>
    :root{
      --bg: #ffffff;
      --head: #f8f9fa;
      --line: #eeeeee;
      --muted: #777;
      --text: #111;
      --blue: #2f6fed;
      --danger:#d9534f;
      --shadow: 0 10px 25px rgba(0,0,0,.15);
      --radius: 14px;
    }

    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 14px;
    }

    h2{ margin:0; font-size: 20px; }

    .btn{
      padding: 8px 14px;
      cursor: pointer;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #fff;
      transition: transform .06s ease, background .2s ease;
    }
    .btn:active{ transform: scale(.98); }
    .btn:hover{ background:#fafafa; }

    .table-wrap{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      overflow: hidden;
      background:#fff;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    thead th{
      background: var(--head);
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--line);
      color: #666;
      font-size: 13px;
      font-weight: 700;
    }

    tbody td{
      padding: 12px;
      border-bottom: 1px solid var(--line);
      font-size: 14px;
      vertical-align: top;
    }

    tbody tr:hover{
      background:#fbfbfc;
    }

    /* æ¬„å¯¬ */
    .col-loc { width: 15%; }
    .col-name { width: 30%; }
    .col-exp { width: 15%; }
    .col-qty { width: 10%; text-align: center; }
    .col-note {
      width: 30%;
      white-space: normal;          /* âœ… ä¸ä¿ç•™ \nï¼Œé¿å…é«˜åº¦çˆ†ç‚¸ */
      overflow-wrap: anywhere;
      word-break: break-word;
      color: #666;
      line-height: 1.4;
    }

    .loc{
      font-weight: 700;
    }

    .name{
      font-weight: 800;
      letter-spacing: .2px;
    }
    .code{
      font-size: 11px;
      color: #999;
      margin-top: 2px;
    }

    .urgent{
      color: var(--danger);
      font-weight: 800;
    }

    .qty{
      font-weight: 800;
      display:inline-block;
      min-width: 24px;
      text-align:center;
    }

    .plus-btn{
      display:inline-block;
      margin-left: 8px;
      color: var(--blue);
      font-weight: 900;
      cursor: pointer;
      user-select: none;
      font-size: 14px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(47,111,237,.25);
      background: rgba(47,111,237,.06);
    }
    .plus-btn:hover{
      background: rgba(47,111,237,.12);
    }

    /* Modal */
    #modal-overlay{
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 18px;
    }

    .modal{
      background: #fff;
      width: 92%;
      max-width: 520px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .modal-head{
      padding: 16px 18px;
      border-bottom: 1px solid var(--line);
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      background: #fff;
    }

    .modal-title{
      margin:0;
      font-size: 16px;
      font-weight: 900;
    }

    .close-btn{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid #eee;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:#666;
      background:#fff;
    }
    .close-btn:hover{ background:#fafafa; }

    .modal-body{
      padding: 12px 18px 18px 18px;
      max-height: 60vh;
      overflow:auto;
    }

    .stock-item{
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .stock-row{
      display:flex;
      justify-content:space-between;
      gap: 12px;
      align-items: flex-start;
    }
    .stock-name{
      font-weight: 800;
      flex: 1;
      overflow-wrap:anywhere;
    }
    .stock-qty{
      white-space: nowrap;
      font-weight: 800;
      color:#111;
    }
    .stock-note{
      margin-top: 6px;
      font-size: 12px;
      color:#888;
      white-space: pre-wrap;
      overflow-wrap:anywhere;
    }

    .empty{
      color:#999;
      text-align:center;
      padding: 20px 0;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <h2>ğŸ“¦ åº«å­˜å¯¦æ™‚ç¸½è¡¨ (æ•´åˆç‰ˆ)</h2>
    <button class="btn" onclick="load()">ğŸ”„ åˆ·æ–°</button>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th class="col-loc">ä½ç½®</th>
          <th class="col-name">ç”¢å“åç¨±</th>
          <th class="col-exp">æ•ˆæœŸ</th>
          <th class="col-qty">æ•¸é‡</th>
          <th class="col-note">å‚™è¨»</th>
        </tr>
      </thead>
      <tbody id="list"></tbody>
    </table>
  </div>

  <div id="modal-overlay" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <h3 class="modal-title" id="modal-title">é†«é™¢å›ºå®šåº«å­˜</h3>
        <div class="close-btn" onclick="closeModal()">âœ•</div>
      </div>
      <div class="modal-body" id="modal-body">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <script>
    async function load() {
      const { data: summary, error } = await _supabase
        .from('inventory_summary')
        .select('*');

      if (error) return;

      // å“ªäº› location æœ‰å›ºå®šåº«å­˜ï¼ˆæ±ºå®šæ˜¯å¦é¡¯ç¤º [+]ï¼‰
      const { data: hsLocs } = await _supabase
        .from('hospital_stock')
        .select('location_name');

      const hasFixedStockSet = new Set((hsLocs || []).map(x => x.location_name).filter(Boolean));

      // æ’åºï¼šæ¥­å‹™å€‰åº«ç½®é ‚ï¼Œå…¶å®ƒç…§ locationï¼Œå†ç…§ç”¢å“å
      summary.sort((a,b) => {
        const aBiz = a.location === 'æ¥­å‹™å€‰åº«';
        const bBiz = b.location === 'æ¥­å‹™å€‰åº«';
        if (aBiz && !bBiz) return -1;
        if (!aBiz && bBiz) return 1;

        const locCmp = String(a.location||'').localeCompare(String(b.location||''), 'zh-Hant');
        if (locCmp !== 0) return locCmp;

        const nameA = (a.friendly_name || a.product_code || '');
        const nameB = (b.friendly_name || b.product_code || '');
        return String(nameA).localeCompare(String(nameB), 'zh-Hant');
      });

      const limitDate = new Date();
      limitDate.setMonth(limitDate.getMonth() + 3);

      const html = (summary || []).map(i => {
        const loc = i.location || '-';
        const displayName = i.friendly_name || i.product_code || 'æœªçŸ¥ç”¢å“';
        const isUrgent = i.expiry_date && new Date(i.expiry_date) < limitDate;

        // å‚™è¨»ï¼šä¸è¦æ’é«˜ï¼ˆæŠŠå¤šé¤˜ç©ºè¡Œå£“æ‰ï¼‰
        const note = (i.location_note || '-')
          .replace(/\r/g,'')
          .replace(/\n{2,}/g,'\n')
          .trim();

        // âœ… æœ‰å›ºå®šåº«å­˜æ‰é¡¯ç¤º [+]ï¼ˆåªæ’é™¤ CONSUMEDï¼‰
        const showPlus = hasFixedStockSet.has(loc) && loc !== 'CONSUMED';

        return `
          <tr>
            <td class="col-loc"><span class="loc">${loc}</span></td>
            <td class="col-name">
              <div class="name">${displayName}</div>
              <div class="code">${i.product_code || ''}</div>
            </td>
            <td class="col-exp ${isUrgent ? 'urgent' : ''}">${i.expiry_date || '-'}</td>
            <td class="col-qty"><span class="qty">${i.total_stock ?? 0}</span></td>
            <td class="col-note">
              ${note || '-'}
              ${showPlus ? `<span class="plus-btn" onclick="openModal('${loc}'); event.stopPropagation();" title="æŸ¥çœ‹å›ºå®šåº«å­˜">+ å›ºå®šåº«å­˜</span>` : ``}
            </td>
          </tr>
        `;
      }).join('');

      document.getElementById('list').innerHTML = html || `<tr><td colspan="5" class="empty">ç„¡è³‡æ–™</td></tr>`;
    }

    async function openModal(locName) {
      if (!locName || locName === 'CONSUMED') return;

      const overlay = document.getElementById('modal-overlay');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');

      overlay.style.display = 'flex';
      title.innerText = `ğŸ¥ ${locName} å›ºå®šåº«å­˜`;
      body.innerHTML = 'è®€å–ä¸­...';

      const { data, error } = await _supabase
        .from('hospital_stock')
        .select('item_name, quantity, unit, note, updated_at')
        .eq('location_name', locName)
        .order('item_name', { ascending: true });

      if (error) {
        body.innerHTML = `<div class="empty" style="color: var(--danger);">è®€å–å¤±æ•—ï¼š${error.message}</div>`;
        return;
      }

      if (data && data.length > 0) {
        body.innerHTML = data.map(d => `
          <div class="stock-item">
            <div class="stock-row">
              <div class="stock-name">${d.item_name}</div>
              <div class="stock-qty">${d.quantity ?? 0} ${d.unit || ''}</div>
            </div>
            <div class="stock-note">${d.note ? d.note : '<ç„¡å‚™è¨»>'}</div>
          </div>
        `).join('');
      } else {
        body.innerHTML = `<div class="empty">ç„¡å›ºå®šåº«å­˜ç´€éŒ„</div>`;
      }
    }

    function closeModal() {
      document.getElementById('modal-overlay').style.display = 'none';
    }

    load();
  </script>
</body>
</html>
