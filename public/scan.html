<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>æ¥­å‹™ç«¯ - æ‹ç…§è¾¨è­˜ç³»çµ±</title>
  <style>
    body { font-family:sans-serif; padding:20px; background:#f4f4f9; text-align:center; }
    .card { background:white; padding:20px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
    video, canvas { width:100%; border-radius:12px; display:none; background:#000; }
    button { background:#7360f2; color:white; border:none; padding:16px; border-radius:10px; width:100%; font-size:18px; font-weight:bold; margin-top:10px; cursor:pointer; }
    .btn-capture { background:#27ae60; } /* æ‹ç…§æŒ‰éˆ•ç¶ è‰² */
    #status { margin-top:15px; text-align:left; font-size:14px; line-height:1.6; }
    .loading-spin { display:none; margin:10px auto; width:30px; height:30px; border:3px solid #f3f3f3; border-top:3px solid #7360f2; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  </style>
</head>
<body>

  <div class="card">
    <h2>ğŸ“· æ‹ç…§è¾¨è­˜å…¥åº«</h2>
    
    <video id="video" autoplay playsinline></video>
    <canvas id="photoCanvas"></canvas>

    <button id="btnOpen" onclick="openCam()">1. é–‹å•Ÿç›¸æ©Ÿ</button>
    <button id="btnSnap" class="btn-capture" onclick="takeSnap()" style="display:none;">2. é»æˆ‘æ‹ç…§è¾¨è­˜</button>
    <button id="btnRetry" onclick="location.reload()" style="display:none; background:#666;">é‡æ‹</button>

    <div class="loading-spin" id="loader"></div>
    <div id="status">è«‹å…ˆé–‹å•Ÿç›¸æ©Ÿ</div>
  </div>

  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('photoCanvas');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('status');
    const loader = document.getElementById('loader');

    let stream = null;

    // 1. é–‹å•Ÿç›¸æ©Ÿ
    async function openCam() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: 1280 } });
        video.srcObject = stream;
        video.style.display = 'block';
        document.getElementById('btnOpen').style.display = 'none';
        document.getElementById('btnSnap').style.display = 'block';
        statusEl.innerText = "è«‹å°æº–æ¢ç¢¼å¾ŒæŒ‰æ‹ç…§";
      } catch (e) {
        alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: " + e.message);
      }
    }

    // 2. æ‹ç…§ä¸¦åˆ†æ
    async function takeSnap() {
      // æ‹ç…§å®šæ ¼
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // ä»‹é¢åˆ‡æ›
      video.style.display = 'none';
      canvas.style.display = 'block';
      document.getElementById('btnSnap').style.display = 'none';
      document.getElementById('btnRetry').style.display = 'block';
      
      loader.style.display = 'block';
      statusEl.innerHTML = "âŒ› æ­£åœ¨åˆ†æç…§ç‰‡ï¼Œè«‹ç¨å€™...";

      const imageData = canvas.toDataURL('image/jpeg', 0.9);

      // --- é–‹å§‹è¾¨è­˜ ---
      try {
        // A. å…ˆè©¦æ¢ç¢¼ (ZXing)
        let code = null;
        const reader = new ZXing.BrowserMultiFormatReader();
        try {
          const result = await reader.decodeFromCanvas(canvas);
          code = result.getText();
        } catch(err) { console.log("æ¢ç¢¼æƒæå¤±æ•—ï¼Œå˜—è©¦æ–‡å­—è¾¨è­˜"); }

        // B. å†è©¦æ–‡å­— (OCR)
        let ocrText = "";
        const ocrRes = await Tesseract.recognize(imageData, 'eng');
        ocrText = ocrRes.data.text.replace(/\s+/g, '');

        // --- é¡¯ç¤ºçµæœ ---
        processResult(code, ocrText);

      } catch (e) {
        statusEl.innerHTML = "âŒ è¾¨è­˜å‡ºéŒ¯: " + e.message;
      } finally {
        loader.style.display = 'none';
      }
    }

    async function processResult(barcode, ocr) {
      // å„ªå…ˆç”¨æ¢ç¢¼ï¼Œæ²’æœ‰å°±ç”¨ OCR
      let finalRaw = barcode || ocr;
      
      // è§£ææ ¼å¼
      const gs1 = parseGS1(finalRaw);

      statusEl.innerHTML = `
        <div style="background:#eef; padding:10px; border-radius:8px;">
          <b>è¾¨è­˜çµæœï¼š</b><br>
          æ¢ç¢¼æŠ“å–ï¼š${barcode || 'æœªåµæ¸¬'}<br>
          æ–‡å­—æŠ“å–ï¼š${ocr.substring(0, 20)}...<br><br>
          <b>é è¨ˆå…¥åº« UUIDï¼š</b><br>
          <span style="font-size:20px; color:blue;">${gs1.uuid}</span><br>
          æœ‰æ•ˆæ—¥æœŸï¼š${gs1.exp || 'ç„¡'}
        </div>
      `;

      if (confirm(`ç¢ºèªå…¥åº«åºè™Ÿ: ${gs1.uuid} ?`)) {
        statusEl.innerHTML = "ğŸš€ å¯«å…¥è³‡æ–™åº«ä¸­...";
        const res = await fetch('/api/stock', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                item_uuid: gs1.uuid,
                expiry_date: gs1.exp,
                from_loc: 'FACTORY',
                to_loc: 'MAIN',
                operator: 'MANUAL_SNAP'
            })
        });
        if(res.ok) {
            alert("æˆåŠŸï¼");
            location.href = 'index.html';
        } else {
            alert("å…¥åº«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è³‡æ–™åº«");
        }
      }
    }

    function parseGS1(s) {
      const out = { uuid: s.substring(0, 12), exp: null };
      const expMatch = s.match(/\(17\)(\d{6})/);
      if (expMatch) out.exp = expMatch[1];
      return out;
    }
  </script>
</body>
</html>