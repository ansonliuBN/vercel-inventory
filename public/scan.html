<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ™ºèƒ½è¾¨è­˜ç³»çµ± - çµ‚æ¥µå…¨èƒ½ç‰ˆ</title>
<style>
  body { font-family:-apple-system, sans-serif; padding:15px; background:#f4f4f9; text-align:center; margin:0; }
  .card { background:white; padding:15px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
  .btn-group { display: flex; gap: 10px; margin-top: 15px; }
  button { flex: 1; padding: 15px; border-radius: 10px; border: none; cursor: pointer; font-size: 16px; font-weight: bold; color: white; }
  .btn-cam { background: #7360f2; }
  .btn-file { background: #2d9cdb; }
  .btn-snap { background: #27ae60; width: 100%; margin-top: 10px; }
  .btn-back { background: transparent; color: #666; width: auto; font-size: 14px; float: left; }
  .camera-wrap { position: relative; width: 100%; aspect-ratio: 4/3; border-radius: 12px; overflow: hidden; border: 2px solid #ddd; background:#000; margin-top: 15px; display: none; }
  video, #photoPreview { width:100%; height:100%; object-fit: cover; }
  #photoPreview { display: none; background: #eee; }
  /* å°å¼•æ¡†ç·š */
  .overlay { position:absolute; inset:0; pointer-events:none; }
  .scan-box { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:85%; height:40%; border:1px solid rgba(255,255,255,0.3); border-radius:12px; box-shadow:0 0 0 9999px rgba(0,0,0,0.5); }
  .corner { position:absolute; width:20px; height:20px; border:4px solid #00ffb3; }
  .c1 { left:-2px; top:-2px; border-right:none; border-bottom:none; border-top-left-radius:12px; }
  .c2 { right:-2px; top:-2px; border-left:none; border-bottom:none; border-top-right-radius:12px; }
  .c3 { left:-2px; bottom:-2px; border-right:none; border-top:none; border-bottom-left-radius:12px; }
  .c4 { right:-2px; bottom:-2px; border-left:none; border-top:none; border-bottom-right-radius:12px; }
  #status { margin-top:12px; font-size:14px; min-height:100px; line-height:1.5; text-align: left; }
  .loader { display:none; margin:10px auto; width:30px; height:30px; border:3px solid #f3f3f3; border-top:3px solid #7360f2; border-radius:50%; animation:spin 1s linear infinite; }
  @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  canvas#workCanvas { display:none; }
</style>
</head>
<body>

<div class="card">
  <button class="btn-back" onclick="location.href='index.html'">â¬…ï¸ è¿”å›ç¸½è¡¨</button>
  <div style="clear: both;"></div>
  <h2>æ™ºèƒ½è¾¨è­˜å…¥åº«</h2>
  
  <div class="btn-group" id="modeSelect">
    <button class="btn-cam" onclick="startCamera()">ğŸ“¸ ç›¸æ©Ÿæƒæ</button>
    <button class="btn-file" onclick="document.getElementById('fileInput').click()">ğŸ“ ä¸Šå‚³æª”æ¡ˆ</button>
  </div>
  <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">

  <div class="camera-wrap" id="displayArea">
    <video id="video" autoplay muted playsinline></video>
    <img id="photoPreview" alt="Preview">
    <div class="overlay" id="guidelines">
      <div class="scan-box"><div class="corner c1"></div><div class="corner c2"></div><div class="corner c3"></div><div class="corner c4"></div></div>
    </div>
  </div>

  <div class="loader" id="loader"></div>
  <div id="status">è«‹é¸æ“‡æ¨¡å¼é–‹å§‹</div>

  <button id="btnSnap" class="btn-snap" onclick="takeSnapshot()" style="display:none;">ç«‹å³æ‹ç…§è¾¨è­˜</button>
  <button id="btnRetry" onclick="location.reload()" style="display:none; width:100%; margin-top:10px;">é‡æ–°é–‹å§‹</button>

  <canvas id="workCanvas"></canvas>
</div>

<script src="https://unpkg.com/@zxing/library@0.19.1"></script>
<script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>

<script>
  const video = document.getElementById('video');
  const preview = document.getElementById('photoPreview');
  const statusEl = document.getElementById('status');
  const loader = document.getElementById('loader');
  const workCanvas = document.getElementById('workCanvas');
  const ctx = workCanvas.getContext('2d');

  let stream = null;

  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1920 } } });
      video.srcObject = stream;
      document.getElementById('displayArea').style.display = 'block';
      document.getElementById('modeSelect').style.display = 'none';
      document.getElementById('btnSnap').style.display = 'block';
      statusEl.innerText = "è«‹å°æº–æ¢ç¢¼èˆ‡æ–‡å­—å¾Œæ‹ç…§";
    } catch (e) { alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ"); }
  }

  function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            workCanvas.width = img.width; workCanvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            preview.src = e.target.result;
            video.style.display = 'none'; preview.style.display = 'block';
            document.getElementById('displayArea').style.display = 'block';
            document.getElementById('modeSelect').style.display = 'none';
            document.getElementById('guidelines').style.display = 'none';
            document.getElementById('btnRetry').style.display = 'block';
            triggerAnalysis(e.target.result);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function takeSnapshot() {
    workCanvas.width = video.videoWidth; workCanvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, workCanvas.width, workCanvas.height);
    const dataUrl = workCanvas.toDataURL('image/jpeg', 0.9);
    preview.src = dataUrl;
    video.style.display = 'none'; preview.style.display = 'block';
    document.getElementById('btnSnap').style.display = 'none';
    document.getElementById('guidelines').style.display = 'none';
    document.getElementById('btnRetry').style.display = 'block';
    triggerAnalysis(dataUrl);
  }

  async function triggerAnalysis(imgData) {
    loader.style.display = 'block';
    statusEl.innerHTML = "âŒ› æ­£åœ¨é€²è¡Œå¤šé‡è¾¨è­˜ (ZXing + OCR)...";

    try {
      const reader = new ZXing.BrowserMultiFormatReader();
      let foundText = "";

      // A. æ¢ç¢¼ + æ—‹è½‰å®¹éŒ¯ (0, 90, 270)
      for (let rot of [0, 90, 270]) {
        if (rot !== 0) {
            const tempCanvas = document.createElement('canvas');
            const tCtx = tempCanvas.getContext('2d');
            tempCanvas.width = workCanvas.height; tempCanvas.height = workCanvas.width;
            tCtx.translate(tempCanvas.width/2, tempCanvas.height/2);
            tCtx.rotate(rot * Math.PI / 180);
            tCtx.drawImage(preview, -workCanvas.width/2, -workCanvas.height/2);
            ctx.drawImage(tempCanvas, 0, 0);
        }
        try {
          const res = await reader.decodeFromCanvas(workCanvas);
          if (res) { foundText = res.getText(); break; }
        } catch(e) {}
      }

      // B. OCR Fallback
      if (!foundText) {
        statusEl.innerHTML = "ğŸ§­ æ¢ç¢¼æ¨¡ç³Šï¼Œæ­£åœ¨å˜—è©¦æ–‡å­—æƒæ...";
        const ocrRes = await Tesseract.recognize(imgData, 'eng');
        foundText = ocrRes.data.text;
      }

      if (foundText && foundText.length > 5) {
        processAndSave(foundText);
      } else {
        statusEl.innerHTML = "<b style='color:red'>âŒ ç„¡æ³•è¾¨è­˜å…§å®¹</b><br>è«‹ä¸Šå‚³æ›´æ¸…æ™°ã€ä¸åå…‰çš„ç…§ç‰‡ã€‚";
        loader.style.display = 'none';
      }
    } catch (err) { alert("è¾¨è­˜å‡ºéŒ¯: " + err.message); loader.style.display = 'none'; }
  }

  function parseGS1(raw) {
    let s = String(raw || '').replace(/\s+/g, '').replace(/[Il|]/g, '1').replace(/O/g, '0');
    const out = { gtin:'', mfg:'', exp:'', lot:'' };
    const matches = s.matchAll(/\((\d{2})\)([^()]+)/g);
    let found = false;
    for (const m of matches) {
      found = true;
      if (m[1] === '01') out.gtin = m[2];
      if (m[1] === '11') out.mfg = m[2];
      if (m[1] === '17') out.exp = m[2];
      if (m[1] === '10' || m[1] === '21') out.lot = m[2];
    }
    // å‚™æ´ï¼šæ­£è¦æŠ“å–
    if (!found) {
      const expM = s.match(/17(\d{6})/); if (expM) out.exp = expM[1];
      const mfgM = s.match(/11(\d{6})/); if (mfgM) out.mfg = mfgM[1];
      const lotM = s.match(/10([A-Z0-9-]{6,})/); if (lotM) out.lot = lotM[1];
    }
    // æ ¼å¼ï¼šè£½é€ _æ•ˆæœŸ_åºè™Ÿ8ç¢¼
    const sn8 = (out.lot || s).replace(/[^A-Z0-9]/g,'').substring(0,8);
    out.key = (out.mfg && out.exp) ? `${out.mfg}_${out.exp}_${sn8}` : (sn8 || "ERR_UUID");
    return out;
  }

  async function processAndSave(text) {
    loader.style.display = 'none';
    const gs1 = parseGS1(text);
    statusEl.innerHTML = `<div style="background:#eef; padding:10px; border-radius:10px; border:1px solid #7360f2;"><b>ğŸ“¦ è¾¨è­˜è³‡æ–™ï¼š</b><br>UUID: <span style="color:blue">${gs1.key}</span><br>æ•ˆæœŸ: ${gs1.exp || 'æœªåµæ¸¬'}<br><small>åŸå§‹å­—ä¸²: ${text.substring(0,25)}...</small></div>`;

    if (confirm(`ç¢ºèªå…¥åº« [${gs1.key}] å—ï¼Ÿ`)) {
      loader.style.display = 'block';
      const res = await fetch('/api/stock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_uuid: gs1.key, expiry_date: gs1.exp, product_code: gs1.gtin, from_loc: 'FACTORY', to_loc: 'MAIN', operator: 'HYBRID_MODE' })
      });
      const result = await res.json().catch(() => ({ message: "Server Error (Non-JSON)" }));
      if (res.ok) { alert("âœ… å…¥åº«æˆåŠŸï¼"); location.href = 'index.html'; }
      else { 
          statusEl.innerHTML = `<div style="color:red; background:#fff0f0; padding:10px; border:2px solid red;"><b>âŒ å­˜å…¥å¤±æ•—</b><br>åŸå› ï¼š${result.message || JSON.stringify(result)}</div>`;
          loader.style.display = 'none';
      }
    }
  }
</script>
</body>
</html>