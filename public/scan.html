<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>æ™ºèƒ½è¾¨è­˜å…¥åº« - ZXingå„ªå…ˆ + å…¨åœ–OCRæ—‹è½‰ä¿åº•ï¼ˆGS1-128/UDIï¼‰</title>
<link rel="icon" href="data:,">

<style>
  body { font-family:-apple-system, sans-serif; padding:0; background:transparent; text-align:center; margin:0; }
  .card { background:white; padding:12px; border-radius:12px; box-shadow:none; max-width:none; margin:0; }

  .btn-group { display: flex; gap: 10px; margin-top: 15px; }
  button { flex: 1; padding: 15px; border-radius: 10px; border: none; cursor: pointer; font-size: 16px; font-weight: bold; color: white; transition: 0.3s; }
  .btn-cam { background: #7360f2; }
  .btn-file { background: #2d9cdb; }
  .btn-snap { background: #27ae60; width: 100%; margin-top: 10px; font-size: 18px; }
  .btn-import { background: #27ae60; width: 100%; margin-top: 15px; font-size: 20px; box-shadow: 0 4px 10px rgba(39,174,96,0.3); }
  .btn-back { background: #666; width: auto; font-size: 14px; float: left; padding: 8px 15px; }

  .camera-wrap {
    position: relative;
    width: 100%;
    aspect-ratio: 9/16;
    border-radius: 12px;
    overflow: hidden;
    border: 2px solid #ddd;
    background:#000;
    margin-top: 15px;
    display: none;
  }

  video, #photoPreview { width:100%; height:100%; object-fit: cover; }
  #photoPreview { display: none; }

  .overlay { position:absolute; inset:0; pointer-events:none; }

  .scan-box {
    position:absolute;
    left:50%;
    top:52%;
    transform:translate(-50%,-50%);
    width:92%;
    height:22%;
    border:1px solid rgba(255,255,255,0.28);
    border-radius:12px;
    box-shadow:0 0 0 9999px rgba(0,0,0,0.55);
  }

  .corner { position:absolute; width:20px; height:20px; border:4px solid #00ffb3; }
  .c1 { left:-2px; top:-2px; border-right:none; border-bottom:none; border-top-left-radius:12px; }
  .c2 { right:-2px; top:-2px; border-left:none; border-bottom:none; border-top-right-radius:12px; }
  .c3 { left:-2px; bottom:-2px; border-right:none; border-top:none; border-bottom-left-radius:12px; }
  .c4 { right:-2px; bottom:-2px; border-left:none; border-top:none; border-bottom-right-radius:12px; }
  .scan-line { position:absolute; left:5%; top:10%; width:90%; height:2px; background:linear-gradient(90deg,transparent,#00ffb3,transparent); animation: move 1.8s infinite; }
  @keyframes move { 0%, 100% { top: 10%; } 50% { top: 90%; } }

  .review-form { text-align: left; background: #f9f9ff; padding: 15px; border-radius: 12px; border: 2px solid #7360f2; margin-top: 15px; display: none; animation: fadeIn 0.5s; }
  @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
  .review-form label { font-size: 13px; color: #555; font-weight: bold; display: block; margin-top: 10px; }
  .review-form input, .review-form select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-top: 4px; }

  .loader { display:none; margin:10px auto; width:30px; height:30px; border:3px solid #f3f3f3; border-top:3px solid #7360f2; border-radius:50%; animation:spin 1s linear infinite; }
  @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

  canvas#workCanvas { display:none; }
</style>
</head>
<body>

<div class="card">
  <h3 style="margin:4px 0 10px; text-align:left;">ğŸ“¦ é ˜è‡³æ¥­å‹™å€‰åº«</h3>

  <div class="btn-group" id="modeSelect">
    <button class="btn-cam" id="btnCam">ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿ</button>
    <button class="btn-file" id="btnPick">ğŸ“ ä¸Šå‚³ç…§ç‰‡</button>
  </div>
  <input type="file" id="fileInput" accept="image/*" style="display:none;">

  <div class="camera-wrap" id="displayArea">
    <video id="video" autoplay muted playsinline></video>
    <img id="photoPreview" alt="preview">
    <div class="overlay" id="guidelines">
      <div class="scan-box">
        <div class="corner c1"></div><div class="corner c2"></div>
        <div class="corner c3"></div><div class="corner c4"></div>
        <div class="scan-line"></div>
      </div>
    </div>
  </div>

  <button id="btnSnap" class="btn-snap" style="display:none;">ğŸ“¸ é»æ“Šæ‹ç…§ä¸¦åˆ†æ</button>

  <div class="loader" id="loader"></div>

  <div id="reviewArea" class="review-form">
    <h3 style="margin:0; color:#7360f2; border-bottom:1px solid #ddd; padding-bottom:8px;">ğŸ” è¾¨è­˜çµæœç¢ºèª</h3>

    <label>GTINï¼ˆ(01) å¾Œ 14 ç¢¼ï¼›å°‡å¯«å…¥ item_uuidï¼‰ï¼š</label>
    <input type="text" id="editGtin" placeholder="å°šæœªåµæ¸¬ï¼ˆå¯æ‰‹å‹•è¼¸å…¥ï¼‰">

    <label>æœ‰æ•ˆæ—¥æœŸï¼ˆ(17) 6 ç¢¼ â†’ yyyy-mm-ddï¼‰ï¼š</label>
    <input type="text" id="editExp" placeholder="å°šæœªåµæ¸¬ï¼ˆå¯æ‰‹å‹•è¼¸å…¥ï¼‰">

    <label>LOTï¼ˆ8ç¢¼-3ç¢¼ï¼›ä¸å®Œæ•´ä¹Ÿæœƒå…ˆå¡« rawï¼‰ï¼š</label>
    <input type="text" id="editLot" placeholder="å°šæœªåµæ¸¬ï¼ˆå¯æ‰‹å‹•è¼¸å…¥ï¼‰">

    <label>å…¥åº«æ•¸é‡ (ä»¥ 10 ç‚ºå–®ä½):</label>
    <select id="editQty">
      <option value="10">10</option><option value="20">20</option>
      <option value="30">30</option><option value="40">40</option>
      <option value="50">50</option><option value="100">100</option>
    </select>

    <button class="btn-import" id="btnSubmit">âœ… ç¢ºèªè³‡æ–™ï¼ŒåŒ¯å…¥åº«å­˜</button>
    <button onclick="location.reload()" style="background:#eee; color:#444; width:100%; margin-top:10px; font-size:14px;">ğŸ”„ é‡æ‹/é‡é¸</button>
  </div>

  <div id="status" style="margin-top:10px; font-size:13px; color:#888;"></div>
  <canvas id="workCanvas"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/zxing-wasm@2.2.1/dist/iife/reader/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@7/dist/tesseract.min.js"></script>

<script type="module">
  import { analyzeWorkCanvas } from "./libs/scanEngine.js";

  const video = document.getElementById('video');
  const preview = document.getElementById('photoPreview');
  const loader = document.getElementById('loader');
  const workCanvas = document.getElementById('workCanvas');
  const ctx = workCanvas.getContext('2d', { willReadFrequently: true });

  const btnCam = document.getElementById('btnCam');
  const btnSnap = document.getElementById('btnSnap');
  const btnPick = document.getElementById('btnPick');
  const fileInput = document.getElementById('fileInput');
  const btnSubmit = document.getElementById('btnSubmit');

  let stream = null;

  // auto-track
  let autoTimer = null;
  let autoBusy = false;
  let autoFound = false;

  const AUTO_INTERVAL_MS = 280;

  function setStatus(msg) { document.getElementById('status').innerText = msg; }

  function stopStream() {
    try { if (stream) stream.getTracks().forEach(t => t.stop()); } catch(e) {}
    stream = null;
  }

  function stopAutoTrack() {
    if (autoTimer) clearInterval(autoTimer);
    autoTimer = null;
  }

  function prepareUIForAnalysis() {
    stopAutoTrack();
    video.style.display = 'none';
    preview.style.display = 'block';
    document.getElementById('displayArea').style.display = 'block';
    document.getElementById('modeSelect').style.display = 'none';
    document.getElementById('btnSnap').style.display = 'none';
    document.getElementById('guidelines').style.display = 'none';
  }

  function hasAny(data) {
    return !!(data?.gtin || data?.gtin_raw || data?.exp || data?.exp_raw || data?.lot);
  }

  function mergeData(acc, incoming) {
    const a = acc || { gtin:"", exp:"", lot:"", gtin_raw:"", exp_raw:"" };
    const b = incoming || { gtin:"", exp:"", lot:"", gtin_raw:"", exp_raw:"" };

    const pick = (oldV, newV) => {
      if (!newV) return oldV;
      if (!oldV) return newV;
      if (oldV === newV) return oldV;
      return (newV.length >= oldV.length) ? newV : oldV;
    };

    return {
      gtin: pick(a.gtin, b.gtin),
      exp: pick(a.exp, b.exp),
      lot: pick(a.lot, b.lot),
      gtin_raw: pick(a.gtin_raw, b.gtin_raw),
      exp_raw: pick(a.exp_raw, b.exp_raw),
    };
  }

  function isMeaningfulUpdate(before, after) {
    if (!after) return false;
    if (!before) return hasAny(after);

    const keys = ["gtin","exp","lot","gtin_raw","exp_raw"];
    return keys.some(k => after[k] && after[k] !== before[k]);
  }

  async function runAnalyze({ forceOcr = false } = {}) {
    loader.style.display = "block";
    setStatus("âŒ› è¾¨è­˜ä¸­...");

    const debug = []; // ä¿ç•™ä½†ä¸é¡¯ç¤ºï¼Œé¿å…å½±éŸ¿æ­£å¼ UI
    const result = await analyzeWorkCanvas(workCanvas, {
      forceOcr,
      debug,
      // æ­£å¼ç‰ˆï¼šä¸éœ€è¦ onBigCrop/onFeed callback
    });

    const data = result.data || {};

    // âœ… æ­£å¼å¡«å€¼ï¼ˆå®Œæ•´å„ªå…ˆï¼ŒæŠ“ä¸åˆ°å°± raw çµ¦ä½¿ç”¨è€…è£œï¼‰
    document.getElementById('editGtin').value = data.gtin || data.gtin_raw || "";
    document.getElementById('editExp').value  = data.exp  || data.exp_raw  || "";
    document.getElementById('editLot').value  = data.lot || "";

    loader.style.display = "none";
    document.getElementById('reviewArea').style.display = 'block';

    setStatus(
      hasAny(data)
        ? `âœ… å·²æŠ“åˆ°éƒ¨åˆ†è³‡è¨Šï¼Œè«‹è¤‡æ ¸/è£œé½Šå¾ŒåŒ¯å…¥ã€‚`
        : `âš ï¸ æœªèƒ½è¾¨è­˜åˆ°é—œéµè³‡è¨Šï¼Œè«‹é è¿‘ã€é¿åå…‰ã€æˆ–æ”¹ç”¨ä¸Šå‚³ç…§ç‰‡ã€‚`
    );
  }

  function startAutoTrack() {
    stopAutoTrack();
    autoBusy = false;
    autoFound = false;

    let accData = { gtin:"", exp:"", lot:"", gtin_raw:"", exp_raw:"" };
    let updateCount = 0;
    let noUpdateStreak = 0;

    const MAX_NO_UPDATE = 10;     // ~2.8s
    const MAX_TOTAL_TICKS = 25;   // ~7s
    let ticks = 0;

    autoTimer = setInterval(async () => {
      if (autoBusy || autoFound) return;
      if (!video.videoWidth || !video.videoHeight) return;
      if (document.getElementById('reviewArea').style.display === 'block') return;

      autoBusy = true;
      try {
        ticks++;

        workCanvas.width = video.videoWidth;
        workCanvas.height = video.videoHeight;
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, workCanvas.width, workCanvas.height);
        ctx.drawImage(video, 0, 0, workCanvas.width, workCanvas.height);

        // è¿½è¹¤éšæ®µï¼šåªè·‘ ZXingï¼ˆocrAfterZxingFails=falseï¼‰
        const debug = [];
        const r = await analyzeWorkCanvas(workCanvas, { forceOcr:false, ocrAfterZxingFails:false, debug });
        const incoming = r?.data || {};

        const merged = mergeData(accData, incoming);

        if (isMeaningfulUpdate(accData, merged)) {
          updateCount++;
          noUpdateStreak = 0;
          accData = merged;
          setStatus(`ğŸ” è‡ªå‹•è¿½è¹¤è£œå®Œä¸­ï¼ˆ${updateCount}/3ï¼‰â€¦`);
        } else {
          noUpdateStreak++;
          setStatus(`ğŸ” è‡ªå‹•è¿½è¹¤ä¸­â€¦`);
        }

        // âœ… 3 æ¬¡æœ‰æ•ˆæ›´æ–°å°±çµæŸ
        if (updateCount >= 3) autoFound = true;

        const shouldForceOcrEnd = (noUpdateStreak >= MAX_NO_UPDATE) || (ticks >= MAX_TOTAL_TICKS);

        if (autoFound || shouldForceOcrEnd) {
          stopAutoTrack();

          const base64 = workCanvas.toDataURL('image/jpeg', 0.92);
          preview.src = base64;
          prepareUIForAnalysis();
          stopStream();

          if (shouldForceOcrEnd && updateCount < 3) {
            await runAnalyze({ forceOcr:true });
          } else {
            // è·‘ä¸€æ¬¡æ­£å¼åˆ†æï¼ˆZXing->OCRä¿åº•ï¼‰ï¼Œå†ç”¨ accData è¦†è“‹æˆç´¯ç©æœ€ä½³
            await runAnalyze({ forceOcr:false });

            document.getElementById('editGtin').value =
              accData.gtin || accData.gtin_raw || document.getElementById('editGtin').value;

            document.getElementById('editExp').value =
              accData.exp || accData.exp_raw || document.getElementById('editExp').value;

            document.getElementById('editLot').value =
              accData.lot || document.getElementById('editLot').value;

            setStatus(`âœ… å·²è‡ªå‹•è£œå®Œï¼Œè«‹è¤‡æ ¸å¾ŒåŒ¯å…¥ã€‚`);
          }
        }

      } finally {
        autoBusy = false;
      }
    }, AUTO_INTERVAL_MS);
  }

  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment", width: { ideal: 1920 } }
      });
      video.srcObject = stream;

      document.getElementById('displayArea').style.display = 'block';
      document.getElementById('modeSelect').style.display = 'none';
      btnSnap.style.display = 'block';
      document.getElementById('guidelines').style.display = 'block';
      video.style.display = 'block';
      preview.style.display = 'none';

      setStatus("ğŸ” è‡ªå‹•è¾¨è­˜ä¸­ï¼ˆå¯æŒ‰æ‹ç…§å¼·åˆ¶åˆ†æï¼‰â€¦");
      startAutoTrack();
    } catch(e) {
      alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¢ºèªæ¬Šé™");
    }
  }

  async function takeSnapshot() {
    if (!video.videoWidth || !video.videoHeight) {
      alert("ç›¸æ©Ÿå°šæœªå°±ç·’ï¼Œè«‹ç­‰ç•«é¢å‡ºç¾å¾Œå†æ‹ç…§");
      return;
    }
    stopAutoTrack();

    workCanvas.width = video.videoWidth;
    workCanvas.height = video.videoHeight;
    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, workCanvas.width, workCanvas.height);
    ctx.drawImage(video, 0, 0, workCanvas.width, workCanvas.height);

    const base64 = workCanvas.toDataURL('image/jpeg', 0.92);
    preview.src = base64;
    prepareUIForAnalysis();
    stopStream();

    await runAnalyze({ forceOcr:false });
  }

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  async function drawBase64ToWorkCanvas(base64) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        workCanvas.width = img.width;
        workCanvas.height = img.height;
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, workCanvas.width, workCanvas.height);
        ctx.drawImage(img, 0, 0);
        resolve();
      };
      img.onerror = reject;
      img.src = base64;
    });
  }

  async function handleFileUpload(e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    const base64 = await fileToBase64(file);
    preview.src = base64;

    prepareUIForAnalysis();
    stopStream();

    await drawBase64ToWorkCanvas(base64);
    await runAnalyze({ forceOcr:true });
  }

  async function finalSubmit() {
    const qty = parseInt(document.getElementById('editQty').value, 10);
    const gtin = (document.getElementById('editGtin').value || "").trim();
    const exp  = (document.getElementById('editExp').value || "").trim();
    const lot  = (document.getElementById('editLot').value || "").trim();

    if (!gtin) { alert("â— è«‹è‡³å°‘è£œä¸Š GTINï¼ˆ(01) å¾Œ 14 ç¢¼ï¼‰å†åŒ¯å…¥"); return; }

    const payload = {
      item_uuid: gtin,
      expiry_date: exp,
      product_code: lot,
      quantity: qty,
      from_loc: 'FACTORY',
      to_loc: 'æ¥­å‹™å€‰åº«',
      operator: localStorage.getItem('user_email') || 'æœªçŸ¥ç”¨æˆ¶'
    };

    loader.style.display = 'block';
    const res = await fetch('/api/stock', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      alert("âœ… åŒ¯å…¥æˆåŠŸï¼å·²å­˜å…¥ " + qty + " ä»¶ç‰©æ–™ã€‚");

      // âœ… å›åˆ°ä¸»é ï¼šåˆ‡åˆ°åº«å­˜ç¸½è¡¨
      if (window.parent && window.parent !== window) {
        const btn = window.parent.document.getElementById('btn-list');
        window.parent.go('list.html', btn);          // åˆ‡ iframe
        window.parent.sessionStorage.setItem('lastPage', 'list.html'); // ä¿éšªï¼šåˆ·æ–°ä¹Ÿåœ¨ç¸½è¡¨
      } else {
        // ä¸æ˜¯ iframe æƒ…å¢ƒï¼ˆç›´æ¥é–‹ scan.htmlï¼‰
        location.href = '/';
      }
    }
  }


  btnPick.addEventListener("click", () => fileInput.click());
  btnCam.addEventListener("click", startCamera);
  btnSnap.addEventListener("click", takeSnapshot);
  fileInput.addEventListener("change", handleFileUpload);
  btnSubmit.addEventListener("click", finalSubmit);
</script>

</body>
</html>
