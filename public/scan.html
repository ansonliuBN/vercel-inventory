<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GS1-128 å³æ™‚æƒæ</title>
<style>
body { font-family:-apple-system; background:#f4f4f9; padding:20px; text-align:center }
.card { background:#fff; padding:20px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,.1) }
video { width:100%; border-radius:10px; border:2px solid #7360f2 }
#status { margin-top:12px; font-size:14px; word-break:break-all }
</style>
</head>
<body>

<div class="card">
  <h2>ğŸ“¦ GS1-128 å³æ™‚æƒæ</h2>
  <p style="font-size:13px;color:#888">è«‹æŠŠæ¢ç¢¼ã€Œæ©«è‘—ã€å°æº–é¡é ­</p>
  <video id="video" autoplay muted playsinline></video>
  <div id="status">å•Ÿå‹•ç›¸æ©Ÿä¸­â€¦</div>
</div>

<script type="module">
import { BrowserMultiFormatReader, DecodeHintType, BarcodeFormat }
  from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/+esm";

const status = document.getElementById('status');
const video = document.getElementById('video');

const hints = new Map();
hints.set(DecodeHintType.POSSIBLE_FORMATS, [BarcodeFormat.CODE_128]);

const reader = new BrowserMultiFormatReader(hints);

function parseGS1(raw) {
  raw = raw.replace(/\((\d{2})\)/g,'$1');
  let i=0,o={};
  const r=n=>raw.slice(i,i+=n);
  while(i<raw.length){
    const ai=raw.slice(i,i+2); i+=2;
    if(ai==='01') o.gtin=r(14);
    else if(ai==='11') o.mfg=r(6);
    else if(ai==='17') o.exp=r(6);
    else if(ai==='10'){ o.lot=raw.slice(i); break;}
    else break;
  }
  const s=(o.lot||'').replace(/-.+$/,'').slice(0,8);
  o.key=o.mfg&&o.exp&&s?`${o.mfg}_${o.exp}_${s}`:'';
  return o;
}

reader.decodeFromVideoDevice(
  null,
  video,
  (result, err) => {
    if (result) {
      const raw = result.getText();
      const g = parseGS1(raw);

      if (!g.key) return;

      status.innerHTML =
        `<b style="color:green">âœ… æƒææˆåŠŸ</b><br>
         ${raw}<br>
         KEY: ${g.key}`;

      reader.reset(); // åœæ­¢æƒæ

      fetch('/api/stock',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          item_uuid:g.key,
          product_code:g.gtin,
          expiry_date:g.exp,
          from_loc:'FACTORY',
          to_loc:'MAIN',
          operator:'å³æ™‚æƒæ'
        })
      });

    }
  }
);
</script>

</body>
</html>
