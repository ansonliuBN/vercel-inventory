<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>æ™ºèƒ½è¾¨è­˜å…¥åº« - ZXingå„ªå…ˆ + å…¨åœ–OCRæ—‹è½‰ä¿åº•ï¼ˆGS1-128/UDIï¼‰</title>
<link rel="icon" href="data:,">

<style>
  body { font-family:-apple-system, sans-serif; padding:15px; background:#f4f4f9; text-align:center; margin:0; }
  .card { background:white; padding:15px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }

  .btn-group { display: flex; gap: 10px; margin-top: 15px; }
  button { flex: 1; padding: 15px; border-radius: 10px; border: none; cursor: pointer; font-size: 16px; font-weight: bold; color: white; transition: 0.3s; }
  .btn-cam { background: #7360f2; }
  .btn-file { background: #2d9cdb; }
  .btn-snap { background: #27ae60; width: 100%; margin-top: 10px; font-size: 18px; }
  .btn-import { background: #27ae60; width: 100%; margin-top: 15px; font-size: 20px; box-shadow: 0 4px 10px rgba(39,174,96,0.3); }
  .btn-back { background: #666; width: auto; font-size: 14px; float: left; padding: 8px 15px; }

  .camera-wrap {
    position: relative;
    width: 100%;
    aspect-ratio: 9/16;
    border-radius: 12px;
    overflow: hidden;
    border: 2px solid #ddd;
    background:#000;
    margin-top: 15px;
    display: none;
  }

  video, #photoPreview { width:100%; height:100%; object-fit: cover; }
  #photoPreview { display: none; }

  .overlay { position:absolute; inset:0; pointer-events:none; }

  .scan-box {
    position:absolute;
    left:50%;
    top:52%;
    transform:translate(-50%,-50%);
    width:92%;
    height:22%;
    border:1px solid rgba(255,255,255,0.28);
    border-radius:12px;
    box-shadow:0 0 0 9999px rgba(0,0,0,0.55);
  }

  .corner { position:absolute; width:20px; height:20px; border:4px solid #00ffb3; }
  .c1 { left:-2px; top:-2px; border-right:none; border-bottom:none; border-top-left-radius:12px; }
  .c2 { right:-2px; top:-2px; border-left:none; border-bottom:none; border-top-right-radius:12px; }
  .c3 { left:-2px; bottom:-2px; border-right:none; border-top:none; border-bottom-left-radius:12px; }
  .c4 { right:-2px; bottom:-2px; border-left:none; border-top:none; border-bottom-right-radius:12px; }
  .scan-line { position:absolute; left:5%; top:10%; width:90%; height:2px; background:linear-gradient(90deg,transparent,#00ffb3,transparent); animation: move 1.8s infinite; }
  @keyframes move { 0%, 100% { top: 10%; } 50% { top: 90%; } }

  .review-form { text-align: left; background: #f9f9ff; padding: 15px; border-radius: 12px; border: 2px solid #7360f2; margin-top: 15px; display: none; animation: fadeIn 0.5s; }
  @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
  .review-form label { font-size: 13px; color: #555; font-weight: bold; display: block; margin-top: 10px; }
  .review-form input, .review-form select, .review-form textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-top: 4px; }

  .loader { display:none; margin:10px auto; width:30px; height:30px; border:3px solid #f3f3f3; border-top:3px solid #7360f2; border-radius:50%; animation:spin 1s linear infinite; }
  @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  canvas#workCanvas { display:none; }

  .pill { display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; background:#eef; color:#333; margin-top:10px; }

  .debug-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-top:10px;
  }
  .debug-card{
    background:#fff;
    border:1px solid #ddd;
    border-radius:10px;
    padding:8px;
  }
  .debug-card b{ font-size:12px; color:#555; display:block; margin-bottom:6px; }
  .debug-card img{ width:100%; border-radius:8px; border:1px solid #eee; background: #fff; }
</style>
</head>
<body>

<div class="card">
  <button class="btn-back" onclick="location.href='index.html'">â¬…ï¸ è¿”å›ç¸½è¡¨</button>
  <div style="clear: both;"></div>
  <h2>ğŸ“¦ æ™ºèƒ½å…¥åº«è¤‡æ ¸</h2>

  <div class="btn-group" id="modeSelect">
    <button class="btn-cam" id="btnCam">ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿ</button>
    <button class="btn-file" onclick="document.getElementById('fileInput').click()">ğŸ“ ä¸Šå‚³ç…§ç‰‡</button>
  </div>
  <input type="file" id="fileInput" accept="image/*" style="display:none;">

  <div class="camera-wrap" id="displayArea">
    <video id="video" autoplay muted playsinline></video>
    <img id="photoPreview" alt="preview">
    <div class="overlay" id="guidelines">
      <div class="scan-box">
        <div class="corner c1"></div><div class="corner c2"></div>
        <div class="corner c3"></div><div class="corner c4"></div>
        <div class="scan-line"></div>
      </div>
    </div>
  </div>

  <button id="btnSnap" class="btn-snap" style="display:none;">ğŸ“¸ é»æ“Šæ‹ç…§ä¸¦åˆ†æ</button>

  <div class="loader" id="loader"></div>
  <div id="sourcePill" class="pill" style="display:none;"></div>

  <div id="reviewArea" class="review-form">
    <h3 style="margin:0; color:#7360f2; border-bottom:1px solid #ddd; padding-bottom:8px;">ğŸ” è¾¨è­˜çµæœç¢ºèª</h3>

    <label>åŸå§‹è¾¨è­˜å…¨æ–‡ï¼ˆZXing + OCRï¼‰ï¼š</label>
    <textarea id="rawAll" style="min-height:200px; white-space:pre-wrap;" placeholder="å°šæœªè¾¨è­˜åˆ°ä»»ä½•æ–‡å­—"></textarea>

    <div class="debug-grid">
      <div class="debug-card">
        <b>WORKCANVAS_THUMB</b>
        <img id="imgWorkThumb" alt="work thumb">
      </div>
      <div class="debug-card">
        <b>BIG_ROIï¼ˆé¤µ ZXing çš„å¤§åˆ‡åœ–ï¼‰</b>
        <img id="imgScanCrop" alt="scan crop">
      </div>
      <div class="debug-card">
        <b>ZXING_FEED</b>
        <img id="imgZxingFeed" alt="zxing feed">
      </div>
      <div class="debug-card">
        <b>OCR_FEED_RAW</b>
        <img id="imgOcrRaw" alt="ocr raw">
      </div>
      <div class="debug-card">
        <b>OCR_FEED_ENH</b>
        <img id="imgOcrEnh" alt="ocr enh">
      </div>
    </div>

    <label>GTINï¼ˆ(01) å¾Œ 14 ç¢¼ï¼›å°‡å¯«å…¥ item_uuidï¼‰ï¼š</label>
    <input type="text" id="editGtin" placeholder="å°šæœªåµæ¸¬">

    <label>æœ‰æ•ˆæ—¥æœŸï¼ˆ(17) 6 ç¢¼ â†’ yyyyå¹´mmæœˆddæ—¥ï¼‰ï¼š</label>
    <input type="text" id="editExp" placeholder="å°šæœªåµæ¸¬">

    <label>LOTï¼ˆå„ªå…ˆæŠ“ (21)ï¼ŒæŠ“ä¸åˆ°ç”¨ä½ æŒ‡å®šçš„ patternï¼‰ï¼š</label>
    <input type="text" id="editLot" placeholder="å°šæœªåµæ¸¬">

    <label>å…¥åº«æ•¸é‡ (ä»¥ 10 ç‚ºå–®ä½):</label>
    <select id="editQty">
      <option value="10">10</option><option value="20">20</option>
      <option value="30">30</option><option value="40">40</option>
      <option value="50">50</option><option value="100">100</option>
    </select>

    <button class="btn-import" id="btnSubmit">âœ… ç¢ºèªè³‡æ–™ï¼ŒåŒ¯å…¥åº«å­˜</button>
    <button onclick="location.reload()" style="background:#eee; color:#444; width:100%; margin-top:10px; font-size:14px;">ğŸ”„ é‡æ‹ä¸€å¼µ</button>
  </div>

  <div id="status" style="margin-top:10px; font-size:13px; color:#888;"></div>
  <canvas id="workCanvas"></canvas>
</div>

<!-- ä»ç”¨ä½ åŸæœ¬çš„ CDN -->
<script src="https://cdn.jsdelivr.net/npm/zxing-wasm@2.2.1/dist/iife/reader/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@7/dist/tesseract.min.js"></script>

<script type="module">
  import { analyzeWorkCanvas } from "./libs/scanEngine.js";

  const video = document.getElementById('video');
  const preview = document.getElementById('photoPreview');
  const loader = document.getElementById('loader');
  const workCanvas = document.getElementById('workCanvas');
  const ctx = workCanvas.getContext('2d', { willReadFrequently: true });

  const btnCam = document.getElementById('btnCam');
  const btnSnap = document.getElementById('btnSnap');
  const fileInput = document.getElementById('fileInput');
  const btnSubmit = document.getElementById('btnSubmit');

  let stream = null;

  // auto-track
  let autoTimer = null;
  let autoBusy = false;
  let autoFound = false;
  let zxingFailCount = 0;

  const AUTO_INTERVAL_MS = 280;
  const ZXING_FAIL_THRESHOLD_FOR_OCR = 3;

  function setStatus(msg) { document.getElementById('status').innerText = msg; }
  function showSourcePill(source) {
    const pill = document.getElementById('sourcePill');
    pill.style.display = 'inline-block';
    pill.textContent = `SOURCE: ${source}`;
  }

  function stopStream() {
    try { if (stream) stream.getTracks().forEach(t => t.stop()); } catch(e) {}
    stream = null;
  }

  function stopAutoTrack() {
    if (autoTimer) clearInterval(autoTimer);
    autoTimer = null;
  }

  function prepareUIForAnalysis() {
    stopAutoTrack();
    video.style.display = 'none';
    preview.style.display = 'block';
    document.getElementById('displayArea').style.display = 'block';
    document.getElementById('modeSelect').style.display = 'none';
    document.getElementById('btnSnap').style.display = 'none';
    document.getElementById('guidelines').style.display = 'none';
    document.getElementById('sourcePill').style.display = 'none';
  }

  function makeThumb(canvas, maxW=420, maxH=420) {
    const w = canvas.width, h = canvas.height;
    const s = Math.min(maxW / w, maxH / h, 1);
    const c = document.createElement("canvas");
    c.width = Math.max(1, Math.floor(w * s));
    c.height = Math.max(1, Math.floor(h * s));
    const g = c.getContext("2d");
    g.imageSmoothingEnabled = true;
    g.fillStyle = "#fff";
    g.fillRect(0,0,c.width,c.height);
    g.drawImage(canvas, 0, 0, c.width, c.height);
    return c;
  }
  function canvasToPreviewURL(canvas) { return canvas.toDataURL("image/png"); }

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  async function drawBase64ToWorkCanvas(base64) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        workCanvas.width = img.width;
        workCanvas.height = img.height;
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, workCanvas.width, workCanvas.height);
        ctx.drawImage(img, 0, 0);
        resolve();
      };
      img.onerror = reject;
      img.src = base64;
    });
  }

  async function runAnalyze({ forceOcr = false } = {}) {
    loader.style.display = "block";
    const debug = [];
    debug.push(`WASM_URL: /zxing_reader.wasm`);

    // debug thumb
    document.getElementById('imgWorkThumb').src = canvasToPreviewURL(makeThumb(workCanvas, 420, 420));

    const result = await analyzeWorkCanvas(workCanvas, {
      forceOcr,
      debug,
      onBigCrop: (bigCrop) => {
        document.getElementById('imgScanCrop').src = canvasToPreviewURL(makeThumb(bigCrop, 420, 420));
      },
      onZxingFeed: (feed) => {
        document.getElementById('imgZxingFeed').src = canvasToPreviewURL(makeThumb(feed, 420, 420));
      },
      onOcrFeed: (feedRaw) => {
        document.getElementById('imgOcrRaw').src = canvasToPreviewURL(makeThumb(feedRaw, 420, 420));
      },
      onOcrEnh: (feedEnh) => {
        document.getElementById('imgOcrEnh').src = canvasToPreviewURL(makeThumb(feedEnh, 420, 420));
      }
    });

    const data = result.data || { gtin:"", expYYMMDD:"", expDisplay:"", lot:"" };

    document.getElementById('rawAll').value =
      [
        `=== SOURCE: ${result.source} ===`,
        result.debug_text || "",
        result.raw ? `\n[RAW_TEXT]\n${result.raw}` : ""
      ].filter(Boolean).join("\n");

    showSourcePill(result.source);

    document.getElementById('editGtin').value = data.gtin || "";
    document.getElementById('editExp').value  = data.expDisplay || "";
    document.getElementById('editLot').value  = data.lot || "";

    loader.style.display = "none";
    document.getElementById('reviewArea').style.display = "block";

    const ok = (data.gtin && data.expDisplay);
    setStatus(ok
      ? `è¾¨è­˜å®Œæˆï¼ˆä¾†æºï¼š${result.source}ï¼‰ï¼Œè«‹è¤‡æ ¸è³‡æ–™ã€‚`
      : `âš ï¸ æœªæŠ“åˆ°å®Œæ•´ GTIN/EXPï¼Œå»ºè­°é‡æ‹æˆ–äººå·¥ä¿®æ­£ã€‚ï¼ˆä¾†æºï¼š${result.source}ï¼‰`
    );
  }

  function startAutoTrack() {
    stopAutoTrack();
    autoBusy = false;
    autoFound = false;
    zxingFailCount = 0;

    autoTimer = setInterval(async () => {
      if (autoBusy || autoFound) return;
      if (!video.videoWidth || !video.videoHeight) return;
      if (document.getElementById('reviewArea').style.display === 'block') return;

      autoBusy = true;
      try {
        // grab frame into workCanvas
        workCanvas.width = video.videoWidth;
        workCanvas.height = video.videoHeight;
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, workCanvas.width, workCanvas.height);
        ctx.drawImage(video, 0, 0, workCanvas.width, workCanvas.height);

        // åªè·‘ ZXingï¼šforceOcr=falseï¼Œä½†æˆ‘å€‘åªç”¨çµæœæ˜¯å¦æœ‰ core ä¾†åˆ¤æ–·
        const debug = [];
        const r = await analyzeWorkCanvas(workCanvas, { forceOcr:false, ocrAfterZxingFails:false, debug });

        // æœ‰ core â†’ ç›´æ¥å½ˆè¤‡æ ¸
        if (r?.data?.gtin && r?.data?.expDisplay) {
          autoFound = true;
          stopAutoTrack();

          const base64 = workCanvas.toDataURL('image/jpeg', 0.92);
          preview.src = base64;
          prepareUIForAnalysis();
          stopStream();

          await runAnalyze({ forceOcr:false });
          return;
        }

        zxingFailCount++;
        if (zxingFailCount < ZXING_FAIL_THRESHOLD_FOR_OCR) {
          setStatus(`ğŸ” è‡ªå‹•è¿½è¹¤ä¸­â€¦ï¼ˆZXing å¤±æ•— ${zxingFailCount}/${ZXING_FAIL_THRESHOLD_FOR_OCR}ï¼‰é è¿‘ã€é¿å…åå…‰ã€‚`);
        } else {
          // é€£çºŒ 3 æ¬¡å¤±æ•— â†’ å…¨åœ– OCR ä¿åº• + å½ˆè¤‡æ ¸
          autoFound = true;
          stopAutoTrack();

          const base64 = workCanvas.toDataURL('image/jpeg', 0.92);
          preview.src = base64;
          prepareUIForAnalysis();
          stopStream();

          await runAnalyze({ forceOcr:true });
          return;
        }
      } finally {
        autoBusy = false;
      }
    }, AUTO_INTERVAL_MS);
  }

  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment", width: { ideal: 1920 } }
      });
      video.srcObject = stream;

      document.getElementById('displayArea').style.display = 'block';
      document.getElementById('modeSelect').style.display = 'none';
      btnSnap.style.display = 'block';
      document.getElementById('guidelines').style.display = 'block';
      video.style.display = 'block';
      preview.style.display = 'none';

      setStatus("ğŸ” è‡ªå‹•è¿½è¹¤ä¸­ï¼šå…ˆ ZXingï¼Œé€£çºŒå¤±æ•— 3 æ¬¡â†’OCR ä¿åº•å½ˆè¤‡æ ¸ã€‚ä¹Ÿå¯æŒ‰æ‹ç…§ã€‚");
      startAutoTrack();
    } catch(e) {
      alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¢ºèªæ¬Šé™");
    }
  }

  async function takeSnapshot() {
    if (!video.videoWidth || !video.videoHeight) {
      alert("ç›¸æ©Ÿå°šæœªå°±ç·’ï¼Œè«‹ç­‰ç•«é¢å‡ºç¾å¾Œå†æ‹ç…§");
      return;
    }
    stopAutoTrack();

    workCanvas.width = video.videoWidth;
    workCanvas.height = video.videoHeight;
    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, workCanvas.width, workCanvas.height);
    ctx.drawImage(video, 0, 0, workCanvas.width, workCanvas.height);

    const base64 = workCanvas.toDataURL('image/jpeg', 0.92);
    preview.src = base64;
    prepareUIForAnalysis();
    stopStream();

    await runAnalyze({ forceOcr:false });
  }

  async function handleFileUpload(e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const base64 = await fileToBase64(file);

    preview.src = base64;
    prepareUIForAnalysis();
    stopStream();

    await drawBase64ToWorkCanvas(base64);
    await runAnalyze({ forceOcr:true });
  }

  async function finalSubmit() {
    const qty = parseInt(document.getElementById('editQty').value, 10);
    const gtin = (document.getElementById('editGtin').value || "").trim();
    const expZh = (document.getElementById('editExp').value || "").trim();
    const lot = (document.getElementById('editLot').value || "").trim();

    if (!gtin) { alert("â— GTIN ä¸èƒ½ç©ºç™½"); return; }
    if (!expZh) { alert("â— æœ‰æ•ˆæ—¥æœŸä¸èƒ½ç©ºç™½"); return; }

    const payload = {
      item_uuid: gtin,
      expiry_date: expZh,
      lot: lot,
      quantity: qty,
      from_loc: 'FACTORY',
      to_loc: 'MAIN',
      operator: 'MANUAL_REVIEW'
    };

    loader.style.display = 'block';
    const res = await fetch('/api/stock', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      alert("âœ… åŒ¯å…¥æˆåŠŸï¼å·²å­˜å…¥ " + qty + " ä»¶ç‰©æ–™ã€‚");
      location.href = 'index.html';
    } else {
      const err = await res.json().catch(() => ({message: "é€£ç·šç•°å¸¸"}));
      alert("âŒ å¤±æ•—: " + err.message);
      loader.style.display = 'none';
    }
  }

  // bind
  btnCam.addEventListener("click", startCamera);
  btnSnap.addEventListener("click", takeSnapshot);
  fileInput.addEventListener("change", handleFileUpload);
  btnSubmit.addEventListener("click", finalSubmit);
</script>
</body>
</html>
