<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¥­å‹™ç«¯ - æƒæå…¥åº«</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f4f4f9; color: #333; text-align: center; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        button { background: #7360f2; color: white; border: none; padding: 18px; border-radius: 10px; cursor: pointer; width: 100%; font-size: 18px; font-weight: bold; margin-bottom: 15px; }
        .back-btn { background: #666; margin-top: 10px; }
        #ocrStatus { margin-top: 20px; font-size: 15px; color: #444; word-break: break-all; min-height: 50px; }
        .preview-canvas { width: 100%; border: 2px solid #7360f2; margin-top: 15px; border-radius: 10px; display: none; }
        .loading-spinner { display: none; margin: 10px auto; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #7360f2; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ“· ç”¢å“æ¢ç¢¼è¾¨è­˜</h2>
        <p style="font-size: 14px; color: #888;">è«‹å°æº–æ¢ç¢¼ä¸‹æ–¹çš„ã€Œæ•¸å­—ã€æ‹ç…§</p>
        
        <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none">
        <button onclick="document.getElementById('photoInput').click()">ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿæ‹ç…§</button>
        <button class="back-btn" onclick="location.href='index.html'">â¬…ï¸ å›åˆ°ç¸½è¡¨</button>

        <div class="loading-spinner" id="spinner"></div>
        <canvas id="debugCanvas" class="preview-canvas"></canvas>
        <div id="ocrStatus">æº–å‚™å°±ç·’</div>
    </div>

    <script src='https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js'></script>
    <script>
        const photoInput = document.getElementById('photoInput');
        const ocrStatus = document.getElementById('ocrStatus');
        const spinner = document.getElementById('spinner');

        photoInput.onchange = async function() {
            const file = photoInput.files[0];
            if (!file) return;

            ocrStatus.innerText = "ğŸŒ€ æ­£åœ¨è™•ç†å½±åƒ...";
            spinner.style.display = "block";
            
            try {
                // 1. å½±åƒæš´åŠ›é è™•ç† (é»‘ç™½åŒ– + å¼·å°æ¯”)
                const processedImageData = await preprocessImage(file);
                
                ocrStatus.innerText = "ğŸ” æ­£åœ¨è§£ææ–‡å­— (OCR)...";
                
                // 2. Tesseract è¾¨è­˜
                const result = await Tesseract.recognize(processedImageData, 'eng', {
                    logger: m => {
                        if(m.status === 'recognizing text') {
                            ocrStatus.innerText = `è¾¨è­˜ä¸­: ${Math.round(m.progress * 100)}%`;
                        }
                    }
                });

                // 3. æš´åŠ›ä¿®æ­£å­—ä¸²
                let cleanText = result.data.text
                    .replace(/\s+/g, '')       // åˆªå»ç©ºç™½
                    .replace(/[\[\{]/g, '(')   // æ‹¬è™Ÿä¿®æ­£
                    .replace(/[\]\}]/g, ')')
                    .replace(/O/g, '0')        // 0/O ä¿®æ­£
                    .replace(/[Il|]/g, '1')    // 1/I/l ä¿®æ­£
                    .replace(/S/g, '5')
                    .replace(/B/g, '8');

                console.log("æœ€çµ‚è™•ç†æ–‡å­—:", cleanText);

                // 4. è§£æ GS1-128 å…§å®¹
                const pCode = cleanText.match(/\(01\)(\d{13,14})/)?.[1];
                const eDate = cleanText.match(/\(17\)(\d{6})/)?.[1];
                const uuidMatch = cleanText.match(/\(21\)([A-Za-z0-9-]+)/)?.[1];
                
                const shortUuid = uuidMatch ? uuidMatch.substring(0, 12) : null;

                if (shortUuid) {
                    ocrStatus.innerHTML = `<b style="color:green">âœ… è¾¨è­˜æˆåŠŸ</b><br>UUID: ${shortUuid}<br>æ•ˆæœŸ: ${eDate || 'æœªæŠ“åˆ°'}`;
                    
                    // 5. å­˜å…¥è³‡æ–™åº« (å‘¼å«å¾Œç«¯ API)
                    await fetch('/api/stock', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            item_uuid: shortUuid,
                            product_code: pCode,
                            expiry_date: eDate,
                            from_loc: 'FACTORY',
                            to_loc: 'MAIN',
                            operator: 'OCRå…¥åº«'
                        })
                    });
                    alert(`ç‰©æ–™ ${shortUuid} å·²å­˜å…¥å…¬å¸å€‰ï¼`);
                } else {
                    ocrStatus.innerHTML = `<b style="color:red">âŒ è§£æå¤±æ•—</b><br>æŠ“åˆ°å­—ä¸²: ${cleanText}<br>æç¤ºï¼šè«‹æ‹æ›´è¿‘ã€æ›´æ¸…æ¥šä¸€é»ã€‚`;
                }
            } catch (err) {
                ocrStatus.innerText = "å‡ºéŒ¯äº†: " + err.message;
            } finally {
                spinner.style.display = "none";
            }
        };

        // å½±åƒè™•ç†ï¼šè½‰é»‘ç™½ + è£åˆ‡ä¸­å¤®
        async function preprocessImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.getElementById('debugCanvas');
                        const ctx = canvas.getContext('2d');
                        
                        // åªå–ä¸­å¤® 40% å€åŸŸ
                        const cropHeight = img.height * 0.4;
                        canvas.width = img.width;
                        canvas.height = cropHeight;
                        
                        // å¼·çƒˆå°æ¯”æ¿¾é¡
                        ctx.filter = 'grayscale(100%) contrast(300%) brightness(110%)';
                        ctx.drawImage(img, 0, img.height * 0.3, img.width, cropHeight, 0, 0, img.width, cropHeight);
                        
                        canvas.style.display = 'block';
                        resolve(canvas.toDataURL('image/jpeg', 0.9));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>