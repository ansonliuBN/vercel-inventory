<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>æ¥­å‹™ç«¯ - æƒæå…¥åº«ï¼ˆæŒ‰éˆ•å•Ÿå‹•ï¼‰</title>

<style>
  body { font-family:-apple-system, sans-serif; padding:20px; background:#f4f4f9; color:#333; text-align:center; }
  .card { background:white; padding:20px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
  button { background:#7360f2; color:white; border:none; padding:16px; border-radius:10px; cursor:pointer; width:100%; font-size:16px; font-weight:bold; margin-top:10px; }
  .secondary { background:#444; }
  .back-btn { background:#666; }
  .muted { color:#888; font-size:13px; margin:8px 0 12px; }
  #status { margin-top:12px; font-size:14px; color:#444; word-break:break-all; min-height:56px; }
  .spinner { display:none; margin:10px auto; width:30px; height:30px; border:3px solid #f3f3f3; border-top:3px solid #7360f2; border-radius:50%; animation:spin 1s linear infinite; }
  @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

  .camera-wrap{
    position: relative;
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    border: 2px solid #7360f2;
    background:#000;
    display:none;
  }
  video{ width:100%; height:auto; display:block; }

  .overlay{ position:absolute; inset:0; pointer-events:none; }
  .scan-box{
    position:absolute;
    left:50%; top:50%;
    transform:translate(-50%,-50%);
    width:78%;
    height:42%;
    border:2px solid rgba(255,255,255,0.95);
    border-radius:14px;
    box-shadow:0 0 0 9999px rgba(0,0,0,0.35);
  }
  .corner{ position:absolute; width:22px; height:22px; border:3px solid #00ffb3; }
  .c1{left:-2px; top:-2px; border-right:none; border-bottom:none; border-radius:12px 0 0 0;}
  .c2{right:-2px; top:-2px; border-left:none; border-bottom:none; border-radius:0 12px 0 0;}
  .c3{left:-2px; bottom:-2px; border-right:none; border-top:none; border-radius:0 0 0 12px;}
  .c4{right:-2px; bottom:-2px; border-left:none; border-top:none; border-radius:0 0 12px 0;}
  .scan-line{
    position:absolute;
    left:6%;
    top:12%;
    width:88%;
    height:2px;
    background: linear-gradient(90deg, transparent, #00ffb3, transparent);
    filter: drop-shadow(0 0 4px rgba(0,255,179,0.8));
    animation: scanmove 1.4s ease-in-out infinite;
    opacity:0.95;
  }
  @keyframes scanmove{
    0%{ transform: translateY(0); }
    50%{ transform: translateY(calc(100% + 120px)); }
    100%{ transform: translateY(0); }
  }

  canvas#workCanvas { display:none; }
</style>
</head>

<body>
  <div class="card">
    <h2>ğŸ“· æƒæå…¥åº«ï¼ˆGS1-128 / QR / DataMatrixï¼‰</h2>
    <div class="muted">
      æŒ‰ã€Œé–‹å•Ÿç›¸æ©Ÿã€æ‰æœƒé–‹å§‹ã€‚<br>
      è‹¥æ‰‹æ©Ÿè·³æ¬Šé™ï¼Œè«‹æŒ‰å…è¨±ï¼›ä¸”å¿…é ˆç”¨ https æˆ– localhostã€‚
    </div>

    <button id="btnStart">ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿé–‹å§‹æƒæ</button>
    <button id="btnStop" class="secondary" disabled>â›” åœæ­¢</button>

    <div class="camera-wrap" id="cameraWrap">
      <video id="video" autoplay muted playsinline></video>
      <div class="overlay">
        <div class="scan-box" id="scanBox">
          <div class="corner c1"></div><div class="corner c2"></div>
          <div class="corner c3"></div><div class="corner c4"></div>
          <div class="scan-line"></div>
        </div>
      </div>
    </div>

    <div class="spinner" id="spin"></div>
    <div id="status">å°šæœªå•Ÿå‹•</div>

    <button class="back-btn" onclick="location.href='index.html'">â¬…ï¸ å›åˆ°ç¸½è¡¨</button>

    <canvas id="workCanvas"></canvas>
  </div>

  <!-- âœ… ZXing UMDï¼ˆé¿å… module import å¤±æ•—æ•´é æ›æ‰ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>
  <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>

  <script>
    const video = document.getElementById('video');
    const statusEl = document.getElementById('status');
    const spin = document.getElementById('spin');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const cameraWrap = document.getElementById('cameraWrap');

    const workCanvas = document.getElementById('workCanvas');
    const workCtx = workCanvas.getContext('2d', { willReadFrequently: true });

    let stream = null;
    let scanning = false;
    let controls = null; // ZXing scan controls

    function setStatus(html){ statusEl.innerHTML = html; }
    function setBusy(b){ spin.style.display = b ? 'block' : 'none'; }

    function parseGS1(raw) {
      const s = String(raw || '').replace(/\s+/g, '').replace(/\((\d{2})\)/g, '$1');
      let i = 0;
      const out = {};
      const read = (n) => s.slice(i, i += n);

      while (i < s.length) {
        const ai = s.slice(i, i + 2); i += 2;
        if (ai === '01') out.gtin = read(14);
        else if (ai === '11') out.mfg = read(6);
        else if (ai === '17') out.exp = read(6);
        else if (ai === '21') { out.sn = s.slice(i); break; }
        else if (ai === '10') { out.lot = s.slice(i); break; }
        else break;
      }
      const tail = (out.sn || out.lot || '');
      const serial8 = tail.replace(/-.+$/, '').slice(0, 8).toUpperCase();
      out.key = (out.mfg && out.exp && serial8) ? `${out.mfg}_${out.exp}_${serial8}` : '';
      return out;
    }

    async function postToBackend(rawText, operator){
      const gs1 = parseGS1(rawText);
      const payload = {
        item_uuid: gs1.key || rawText,
        product_code: gs1.gtin || null,
        expiry_date: gs1.exp || null,
        from_loc: 'FACTORY',
        to_loc: 'MAIN',
        operator: operator || 'SCAN'
      };
      await fetch('/api/stock', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      return { gs1, payload };
    }

    async function openCameraOnly(){
      // é¡¯ç¤ºç•«é¢
      cameraWrap.style.display = 'block';

      // âœ… getUserMedia å¿…é ˆåœ¨æŒ‰éˆ•äº‹ä»¶ä¸­å‘¼å«
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
    }

    async function startScan(){
      if (!window.ZXingBrowser) {
        setStatus('<b style="color:red">âŒ ZXing è¼‰å…¥å¤±æ•—</b><br>è«‹ç¢ºèªèƒ½é€£ CDNï¼ˆjsdelivrï¼‰ã€‚');
        return;
      }

      btnStart.disabled = true;
      btnStop.disabled = false;
      setBusy(true);
      setStatus('ğŸ¥ é–‹å•Ÿç›¸æ©Ÿä¸­â€¦');

      try{
        await openCameraOnly();
      } catch(e){
        setBusy(false);
        btnStart.disabled = false;
        btnStop.disabled = true;
        setStatus(`<b style="color:red">âŒ ç›¸æ©Ÿæ‰“ä¸é–‹</b><br>${e.name || ''} ${e.message || e}<br>
          æª¢æŸ¥ï¼šæ˜¯å¦ https/localhostï¼Ÿæ˜¯å¦å…è¨±ç›¸æ©Ÿæ¬Šé™ï¼Ÿ`);
        return;
      }

      setBusy(false);
      setStatus('âœ… ç›¸æ©Ÿå·²å•Ÿå‹•ï¼Œé–‹å§‹æƒæâ€¦');
      scanning = true;

      // âœ… é€™å€‹ API åœ¨ UMD ç‰ˆæœ€ç©©ï¼šdecodeFromVideoDevice
      const { BrowserMultiFormatReader, BarcodeFormat, DecodeHintType } = window.ZXingBrowser;

      const hints = new Map();
      hints.set(DecodeHintType.POSSIBLE_FORMATS, [
        BarcodeFormat.CODE_128,
        BarcodeFormat.QR_CODE,
        BarcodeFormat.DATA_MATRIX
      ]);
      hints.set(DecodeHintType.TRY_HARDER, true);

      const reader = new BrowserMultiFormatReader(hints, 600);

      try{
        controls = await reader.decodeFromVideoDevice(null, video, async (result, err) => {
          if (!scanning) return;

          if (result) {
            const text = result.getText();
            setBusy(true);
            setStatus(`âœ… æƒåˆ°ï¼š<br>${text}<br>æ­£åœ¨å…¥åº«â€¦`);

            try{
              await postToBackend(text, 'LIVE_SCAN');
              stopScan(); // æˆåŠŸå°±åœ
              setBusy(false);
              setStatus(`<b style="color:green">âœ… å…¥åº«æˆåŠŸ</b><br>${text}`);
              alert('âœ… å·²å…¥åº«ï¼');
            } catch(e){
              setBusy(false);
              setStatus(`<b style="color:red">âŒ å…¥åº« API å¤±æ•—</b><br>${String(e?.message||e)}`);
            }
          }
        });
      } catch(e){
        setBusy(false);
        setStatus(`<b style="color:red">âŒ æƒæåˆå§‹åŒ–å¤±æ•—</b><br>${String(e?.message||e)}`);
        stopScan();
      }
    }

    function stopScan(){
      scanning = false;
      btnStart.disabled = false;
      btnStop.disabled = true;

      // åœ ZXing
      try{ if (controls && controls.stop) controls.stop(); } catch(_){}
      controls = null;

      // åœç›¸æ©Ÿ
      try{
        const s = video.srcObject || stream;
        if (s && s.getTracks) s.getTracks().forEach(t => t.stop());
      } catch(_){}
      stream = null;
      video.srcObject = null;

      cameraWrap.style.display = 'none';
      setBusy(false);
      setStatus('â›” å·²åœæ­¢ã€‚');
    }

    // âœ… é€™å…©è¡Œä½ åŸæœ¬æ¼æ‰äº†ï¼šä¸ç¶å®šå°±ä¸€å®šæ²’åæ‡‰
    btnStart.addEventListener('click', startScan);
    btnStop.addEventListener('click', stopScan);
  </script>
</body>
</html>
            }
            alert("æ’¥è£œå®Œæˆï¼");
            location.reload();
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = init;
    </script>