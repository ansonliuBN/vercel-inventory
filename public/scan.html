<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>é«˜ç´šè¾¨è­˜ç³»çµ± - å…¨åŠŸèƒ½ç‰ˆ</title>
<style>
  body { font-family:-apple-system, sans-serif; padding:15px; background:#f4f4f9; color:#333; text-align:center; margin:0; }
  .card { background:white; padding:15px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
  
  /* æŒ‰éˆ•æ¨£å¼ */
  button { background:#7360f2; color:white; border:none; padding:15px; border-radius:10px; cursor:pointer; width:100%; font-size:16px; font-weight:bold; margin-top:10px; }
  .secondary { background:#444; }
  .back-btn { background:#666; margin-top: 15px; }
  
  /* ç›¸æ©Ÿå®¹å™¨èˆ‡æƒææ¡† */
  .camera-wrap { position: relative; width: 100%; aspect-ratio: 4/3; border-radius: 12px; overflow: hidden; border: 2px solid #7360f2; background:#000; display:none; margin-top: 15px; }
  video { width:100%; height:100%; object-fit: cover; }
  
  /* æƒææ¡†å°å¼•ç·š (ä½ è¦æ±‚çš„å››è§’æ¡† + æç¤ºç·š) */
  .overlay { position:absolute; inset:0; pointer-events:none; }
  .scan-box { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:85%; height:40%; border:1px solid rgba(255,255,255,0.3); border-radius:12px; box-shadow:0 0 0 9999px rgba(0,0,0,0.5); }
  .corner { position:absolute; width:20px; height:20px; border:4px solid #00ffb3; }
  .c1 { left:-2px; top:-2px; border-right:none; border-bottom:none; border-top-left-radius:12px; }
  .c2 { right:-2px; top:-2px; border-left:none; border-bottom:none; border-top-right-radius:12px; }
  .c3 { left:-2px; bottom:-2px; border-right:none; border-top:none; border-bottom-left-radius:12px; }
  .c4 { right:-2px; bottom:-2px; border-left:none; border-top:none; border-bottom-right-radius:12px; }
  .scan-line { position:absolute; left:5%; top:10%; width:90%; height:2px; background:linear-gradient(90deg,transparent,#00ffb3,transparent); animation: move 2s infinite; }
  @keyframes move { 0%, 100% { top: 10%; } 50% { top: 90%; } }

  #status { margin-top:12px; font-size:14px; min-height:80px; line-height:1.5; }
  .spinner { display:none; margin:10px auto; width:25px; height:25px; border:3px solid #f3f3f3; border-top:3px solid #7360f2; border-radius:50%; animation:spin 1s linear infinite; }
  @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  canvas#workCanvas { display:none; }
</style>
</head>
<body>

<div class="card">
  <button class="back-btn" onclick="location.href='index.html'" style="width: auto; padding: 8px 20px; float: left; margin-top: 0;">â¬…ï¸ è¿”å›</button>
  <div style="clear: both;"></div>
  
  <h2>ğŸ“¸ æ™ºèƒ½è¾¨è­˜ç³»çµ±</h2>
  <p style="font-size: 13px; color: #666;">æ”¯æ´ GS1-128 / QR / DataMatrix</p>

  <button id="btnStart" onclick="window.__startScan()">ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿé–‹å§‹è¾¨è­˜</button>
  <button id="btnStop" class="secondary" onclick="window.__stopScan()" disabled>â›” åœæ­¢</button>

  <div class="camera-wrap" id="cameraWrap">
    <video id="video" autoplay muted playsinline></video>
    <div class="overlay">
      <div class="scan-box">
        <div class="corner c1"></div><div class="corner c2"></div>
        <div class="corner c3"></div><div class="corner c4"></div>
        <div class="scan-line"></div>
      </div>
    </div>
  </div>

  <div class="spinner" id="spin"></div>
  <div id="status">æº–å‚™å°±ç·’</div>
  
  <canvas id="workCanvas"></canvas>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>

<script>
  const video = document.getElementById('video');
  const statusEl = document.getElementById('status');
  const spin = document.getElementById('spin');
  const cameraWrap = document.getElementById('cameraWrap');
  const workCanvas = document.getElementById('workCanvas');
  const workCtx = workCanvas.getContext('2d', { willReadFrequently: true });

  let stream = null, scanning = false, reader = null, controls = null;
  let lastSeenAt = 0, watchdogTimer = null;

  function setStatus(h){ statusEl.innerHTML = h; }
  function setBusy(b){ spin.style.display = b ? 'block' : 'none'; }

  // --- GS1 è§£æ + çµ±ä¸€ Key (mfg_exp_serial8) ---
  function parseGS1(raw) {
    let s = String(raw || '').replace(/\s+/g, '').replace(/[\[\{]/g, '(').replace(/[\]\}]/g, ')');
    const out = { gtin:'', mfg:'', exp:'', sn:'' };
    const matches = s.matchAll(/\((\d{2})\)([^()]+)/g);
    for (const m of matches) {
      const ai = m[1], val = m[2];
      if (ai === '01') out.gtin = val;
      if (ai === '11') out.mfg = val;
      if (ai === '17') out.exp = val;
      if (ai === '21') out.sn = val;
    }
    // å»ºç«‹çµ±ä¸€ Key: è£½é€ _æ•ˆæœŸ_åºè™Ÿå‰8ç¢¼
    const sn8 = (out.sn || s).replace(/[^A-Za-z0-9]/g, '').substring(0, 8).toUpperCase();
    out.key = (out.mfg && out.exp) ? `${out.mfg}_${out.exp}_${sn8}` : (sn8 || "UNKNOWN");
    return out;
  }

  async function postToBackend(text, method) {
    const gs1 = parseGS1(text);
    await fetch('/api/stock', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        item_uuid: gs1.key,
        product_code: gs1.gtin || null,
        expiry_date: gs1.exp || null,
        from_loc: 'FACTORY',
        to_loc: 'MAIN',
        operator: `AUTO_${method}`
      })
    });
    return gs1;
  }

  function captureROI(rot = 0) {
    const vw = video.videoWidth, vh = video.videoHeight;
    if (!vw || !vh) return false;
    const sw = vw * 0.8, sh = vh * 0.4;
    const sx = (vw - sw) / 2, sy = (vh - sh) / 2;
    const outW = (rot === 90 || rot === 270) ? sh : sw;
    const outH = (rot === 90 || rot === 270) ? sw : sh;
    workCanvas.width = outW; workCanvas.height = outH;
    workCtx.save();
    if (rot !== 0) {
      workCtx.translate(outW/2, outH/2);
      workCtx.rotate(rot * Math.PI / 180);
      workCtx.drawImage(video, sx, sy, sw, sh, -sw/2, -sh/2, sw, sh);
    } else {
      workCtx.drawImage(video, sx, sy, sw, sh, 0, 0, sw, sh);
    }
    workCtx.restore();
    return true;
  }

  async function finish(text, method) {
    scanning = false; clearInterval(watchdogTimer);
    const gs1 = await postToBackend(text, method);
    setStatus(`<b style="color:green">âœ… å…¥åº«æˆåŠŸ</b><br>Key: ${gs1.key}<br>æ–¹å¼: ${method}`);
    alert(`å…¥åº«æˆåŠŸï¼\nKey: ${gs1.key}`);
    location.href = 'index.html';
  }

  window.__startScan = async function() {
    document.getElementById('btnStart').disabled = true;
    document.getElementById('btnStop').disabled = false;
    setStatus('ğŸ¥ å•Ÿå‹•ç›¸æ©Ÿä¸­...');
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1280 } } });
      video.srcObject = stream;
      cameraWrap.style.display = 'block';
      scanning = true; lastSeenAt = Date.now();

      const ZX = window.ZXingBrowser || window.ZXing;
      const hints = new Map();
      hints.set(ZX.DecodeHintType.TRY_HARDER, true);
      hints.set(ZX.DecodeHintType.POSSIBLE_FORMATS, [
        ZX.BarcodeFormat.CODE_128,
        ZX.BarcodeFormat.QR_CODE,
        ZX.BarcodeFormat.DATA_MATRIX
      ]);
      
      reader = new ZX.BrowserMultiFormatReader(hints);
      controls = await reader.decodeFromVideoDevice(null, video, (res) => {
        if (res && scanning) finish(res.getText(), 'ZXING');
      });

      // è‡ªå‹•ç›£æ§ï¼š4ç§’æ—‹è½‰è§£ç¢¼ï¼Œ10ç§’ OCR
      watchdogTimer = setInterval(async () => {
        if (!scanning) return;
        const idle = Date.now() - lastSeenAt;
        if (idle > 4000) {
          for (let r of [90, 270]) {
            captureROI(r);
            try {
              const rs = await reader.decodeFromCanvas(workCanvas);
              if (rs && scanning) finish(rs.getText(), 'ROTATE');
            } catch(e){}
          }
        }
        if (idle > 10000) {
          captureROI(0);
          setStatus('ğŸ§  è‡ªå‹•åˆ‡æ› OCR è¾¨è­˜ä¸­...');
          const res = await Tesseract.recognize(workCanvas.toDataURL(), 'eng');
          const txt = res.data.text.replace(/\s+/g, '');
          if (txt.length > 5) finish(txt, 'OCR');
          lastSeenAt = Date.now();
        }
      }, 2000);

    } catch (e) {
      setStatus('âŒ éŒ¯èª¤: ' + e.message);
      window.__stopScan();
    }
  };

  window.__stopScan = function() {
    scanning = false; clearInterval(watchdogTimer);
    if (controls) controls.stop();
    if (stream) stream.getTracks().forEach(t => t.stop());
    video.srcObject = null;
    cameraWrap.style.display = 'none';
    document.getElementById('btnStart').disabled = false;
    document.getElementById('btnStop').disabled = true;
    setStatus('å·²åœæ­¢');
  };
</script>
</body>
</html>