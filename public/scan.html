<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ™ºèƒ½è¾¨è­˜ç³»çµ± - é›™æ¨¡å¼ç‰ˆ</title>
<style>
  body { font-family:-apple-system, sans-serif; padding:15px; background:#f4f4f9; color:#333; text-align:center; margin:0; }
  .card { background:white; padding:15px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
  
  /* æŒ‰éˆ•æ¨£å¼ */
  .btn-group { display: flex; gap: 10px; margin-top: 15px; }
  button { flex: 1; padding: 15px; border-radius: 10px; border: none; cursor: pointer; font-size: 16px; font-weight: bold; color: white; }
  .btn-cam { background: #7360f2; }
  .btn-file { background: #2d9cdb; }
  .btn-snap { background: #27ae60; width: 100%; margin-top: 10px; }
  .btn-retry { background: #666; margin-top: 10px; width: 100%; }
  .back-btn { background: transparent; color: #666; font-size: 14px; margin-bottom: 10px; }

  /* é¡¯ç¤ºå€åŸŸ */
  .camera-wrap { position: relative; width: 100%; aspect-ratio: 4/3; border-radius: 12px; overflow: hidden; border: 2px solid #ddd; background:#000; margin-top: 15px; display: none; }
  video, #photoPreview { width:100%; height:100%; object-fit: cover; }
  #photoPreview { display: none; background: #eee; }

  /* å°å¼•æ¡† */
  .overlay { position:absolute; inset:0; pointer-events:none; }
  .scan-box { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:85%; height:40%; border:1px solid rgba(255,255,255,0.3); border-radius:12px; box-shadow:0 0 0 9999px rgba(0,0,0,0.5); }
  .corner { position:absolute; width:20px; height:20px; border:4px solid #00ffb3; }
  .c1 { left:-2px; top:-2px; border-right:none; border-bottom:none; border-top-left-radius:12px; }
  .c2 { right:-2px; top:-2px; border-left:none; border-bottom:none; border-top-right-radius:12px; }
  .c3 { left:-2px; bottom:-2px; border-right:none; border-top:none; border-bottom-left-radius:12px; }
  .c4 { right:-2px; bottom:-2px; border-left:none; border-top:none; border-bottom-right-radius:12px; }

  #status { margin-top:12px; font-size:14px; min-height:80px; line-height:1.5; text-align: left; }
  .loader { display:none; margin:10px auto; width:30px; height:30px; border:3px solid #f3f3f3; border-top:3px solid #7360f2; border-radius:50%; animation:spin 1s linear infinite; }
  @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  canvas#workCanvas { display:none; }
</style>
</head>
<body>

<div class="card">
  <button class="back-btn" onclick="location.href='index.html'">â¬…ï¸ è¿”å›ç¸½è¡¨</button>
  
  <h2>æ™ºèƒ½è¾¨è­˜å…¥åº«</h2>
  
  <div class="btn-group" id="modeSelect">
    <button class="btn-cam" onclick="startCamera()">ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿ</button>
    <button class="btn-file" onclick="document.getElementById('fileInput').click()">ğŸ“ ä¸Šå‚³æª”æ¡ˆ</button>
  </div>
  <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">

  <div class="camera-wrap" id="displayArea">
    <video id="video" autoplay muted playsinline></video>
    <img id="photoPreview" alt="Preview">
    <div class="overlay" id="guidelines">
      <div class="scan-box">
        <div class="corner c1"></div><div class="corner c2"></div>
        <div class="corner c3"></div><div class="corner c4"></div>
      </div>
    </div>
  </div>

  <div class="loader" id="loader"></div>
  <div id="status">è«‹é¸æ“‡è¾¨è­˜æ¨¡å¼</div>

  <button id="btnSnap" class="btn-snap" onclick="takeSnapshot()" style="display:none;">ç«‹å³æ‹ç…§è¾¨è­˜</button>
  <button id="btnRetry" class="btn-retry" onclick="resetAll()" style="display:none;">é‡æ–°é¸æ“‡</button>

  <canvas id="workCanvas"></canvas>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>

<script>
  const video = document.getElementById('video');
  const preview = document.getElementById('photoPreview');
  const statusEl = document.getElementById('status');
  const loader = document.getElementById('loader');
  const workCanvas = document.getElementById('workCanvas');
  const ctx = workCanvas.getContext('2d');

  let stream = null;

  // 1. ç›¸æ©Ÿæ¨¡å¼å•Ÿå‹•
  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1920 } } });
      video.srcObject = stream;
      video.style.display = 'block';
      preview.style.display = 'none';
      document.getElementById('displayArea').style.display = 'block';
      document.getElementById('modeSelect').style.display = 'none';
      document.getElementById('btnSnap').style.display = 'block';
      document.getElementById('guidelines').style.display = 'block';
      statusEl.innerText = "è«‹å°æº–æ¢ç¢¼å¾Œæ‹ç…§";
    } catch (e) {
      alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + e.message);
    }
  }

  // 2. æª”æ¡ˆæ¨¡å¼è™•ç†
  function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            // ç¹ªè£½åˆ°ç•«å¸ƒä»¥ä¾¿åˆ†æ
            workCanvas.width = img.width;
            workCanvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            // é¡¯ç¤ºé è¦½
            preview.src = e.target.result;
            video.style.display = 'none';
            preview.style.display = 'block';
            document.getElementById('displayArea').style.display = 'block';
            document.getElementById('modeSelect').style.display = 'none';
            document.getElementById('btnRetry').style.display = 'block';
            document.getElementById('guidelines').style.display = 'none';
            
            triggerAnalysis(e.target.result);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  // 3. æ‹ç…§å‹•ä½œ
  function takeSnapshot() {
    workCanvas.width = video.videoWidth;
    workCanvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, workCanvas.width, workCanvas.height);
    
    const dataUrl = workCanvas.toDataURL('image/jpeg', 0.9);
    preview.src = dataUrl;
    
    video.style.display = 'none';
    preview.style.display = 'block';
    document.getElementById('btnSnap').style.display = 'none';
    document.getElementById('btnRetry').style.display = 'block';
    document.getElementById('guidelines').style.display = 'none';
    
    triggerAnalysis(dataUrl);
  }

  // 4. æ ¸å¿ƒè¾¨è­˜å¼•æ“
  async function triggerAnalysis(imgData) {
    loader.style.display = 'block';
    statusEl.innerHTML = "âŒ› æ­£åœ¨é€²è¡Œæ·±åº¦åˆ†æ (ZXing + OCR)...";

    try {
      const ZX = window.ZXingBrowser || window.ZXing;
      const reader = new ZX.BrowserMultiFormatReader();
      let foundText = "";

      // A. æ¢ç¢¼è¾¨è­˜ (å«å¤šè§’åº¦æ—‹è½‰)
      for (let rot of [0, 90, 270]) {
        if (rot !== 0) rotateCanvas(rot);
        try {
          const res = await reader.decodeFromCanvas(workCanvas);
          if (res) { foundText = res.getText(); break; }
        } catch(e) {}
      }

      // B. OCR è£œå„Ÿ
      if (!foundText) {
        statusEl.innerHTML = "ğŸ§­ æ¢ç¢¼æœªåµæ¸¬ï¼Œåˆ‡æ› OCR æ–‡å­—è¾¨è­˜...";
        const ocrRes = await Tesseract.recognize(imgData, 'eng');
        foundText = ocrRes.data.text.replace(/\s+/g, '');
      }

      if (foundText) {
        processAndSave(foundText);
      } else {
        statusEl.innerHTML = "âŒ ç„¡æ³•è¾¨è­˜å…§å®¹ï¼Œè«‹ä¸Šå‚³æ›´æ¸…æ™°çš„ç…§ç‰‡ã€‚";
        loader.style.display = 'none';
      }
    } catch (err) {
      statusEl.innerText = "éŒ¯èª¤: " + err.message;
      loader.style.display = 'none';
    }
  }

  async function processAndSave(text) {
    loader.style.display = 'none';
    const gs1 = parseGS1(text);
    
    statusEl.innerHTML = `
      <div style="background:#eef; padding:10px; border-radius:10px;">
        <b>è¾¨è­˜ UUID:</b> <span style="color:blue">${gs1.key}</span><br>
        <b>æ•ˆæœŸ:</b> ${gs1.exp || 'ç„¡'}<br>
        <small>åŸå§‹å­—ä¸²: ${text.substring(0, 30)}</small>
      </div>
    `;

    if (confirm(`ç¢ºèªå…¥åº« [${gs1.key}] å—ï¼Ÿ`)) {
      loader.style.display = 'block';
      try {
        const res = await fetch('/api/stock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            item_uuid: gs1.key,
            expiry_date: gs1.exp,
            from_loc: 'FACTORY',
            to_loc: 'MAIN',
            operator: 'HYBRID_MODE'
          })
        });

        // è™•ç† Vercel å ±éŒ¯æ–‡å­—å•é¡Œ
        const result = await res.json().catch(() => ({ message: "Server å›å‚³æ ¼å¼éŒ¯èª¤ (é JSON)" }));

        if (res.ok) {
          alert("âœ… å…¥åº«æˆåŠŸï¼");
          location.href = 'index.html';
        } else {
          alert("âŒ å­˜å…¥å¤±æ•—: " + (result.message || "æœªçŸ¥åŸå› "));
          loader.style.display = 'none';
        }
      } catch (e) {
        alert("ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Vercel Logs");
        loader.style.display = 'none';
      }
    }
  }

  function rotateCanvas(deg) {
    const tempW = workCanvas.width, tempH = workCanvas.height;
    const tempCanvas = document.createElement('canvas');
    const tCtx = tempCanvas.getContext('2d');
    tempCanvas.width = tempH; tempCanvas.height = tempW;
    tCtx.translate(tempH/2, tempW/2);
    tCtx.rotate(deg * Math.PI / 180);
    tCtx.drawImage(preview, -tempW/2, -tempH/2, tempW, tempH);
    workCanvas.width = tempCanvas.width;
    workCanvas.height = tempCanvas.height;
    ctx.drawImage(tempCanvas, 0, 0);
  }

  function parseGS1(s) {
    let gs1 = { key: s.substring(0, 12), exp: null };
    const expM = s.match(/\(17\)(\d{6})/) || s.match(/17(\d{6})/);
    if (expM) gs1.exp = expM[1];
    // çµ±ä¸€æ ¼å¼ï¼šè£½é€ _æ•ˆæœŸ_åºè™Ÿ (é€™è£¡ç°¡åŒ–ç‚ºåºè™Ÿï¼Œä½ å¯ä»¥æŒ‰éœ€èª¿æ•´ key é‚è¼¯)
    return gs1;
  }

  function resetAll() {
    if (stream) stream.getTracks().forEach(t => t.stop());
    location.reload();
  }
</script>
</body>
</html>