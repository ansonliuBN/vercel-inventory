<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ¥­å‹™ç«¯ - æƒæå…¥åº«</title>

<style>
body { font-family: -apple-system, sans-serif; padding:20px; background:#f4f4f9; text-align:center }
.card { background:white; padding:20px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,.1) }
button { background:#7360f2; color:white; border:none; padding:18px; border-radius:10px; width:100%; font-size:18px; font-weight:bold; margin-bottom:12px }
.back-btn { background:#666 }
#status { margin-top:15px; font-size:14px; min-height:50px; word-break:break-all }
canvas { width:100%; border:2px solid #7360f2; margin-top:10px; border-radius:10px; display:none }
.spinner { display:none; margin:10px auto; width:30px; height:30px; border:3px solid #eee; border-top:3px solid #7360f2; border-radius:50%; animation:spin 1s linear infinite }
@keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
</style>
</head>

<body>

<div class="card">
  <h2>ğŸ“· GS1-128 æ¢ç¢¼æƒæ</h2>
  <p style="font-size:13px;color:#888">è«‹ç›´æ¥å°æº–ã€Œæ¢ç¢¼ã€æ‹ç…§ï¼ˆä¸ç”¨åˆ»æ„æ‹æ•¸å­—ï¼‰</p>

  <input type="file" id="photo" accept="image/*" capture="environment" hidden>
  <button onclick="photo.click()">ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿ</button>
  <button class="back-btn" onclick="location.href='index.html'">â¬…ï¸ å›ç¸½è¡¨</button>

  <div class="spinner" id="spin"></div>
  <canvas id="preview"></canvas>
  <div id="status">æº–å‚™å°±ç·’</div>
</div>

<!-- ZXingï¼ˆæ¢ç¢¼è§£ç¢¼ï¼Œä¸»åŠ›ï¼‰ -->
<script type="module">
import { BrowserMultiFormatReader, DecodeHintType, BarcodeFormat }
  from "https://cdn.jsdelivr.net/npm/@zxing/library@0.21.3/+esm";

const photo = document.getElementById('photo');
const status = document.getElementById('status');
const spin = document.getElementById('spin');
const canvas = document.getElementById('preview');

const hints = new Map();
hints.set(DecodeHintType.POSSIBLE_FORMATS, [BarcodeFormat.CODE_128]);
hints.set(DecodeHintType.TRY_HARDER, true);

const reader = new BrowserMultiFormatReader(hints, 800);

/* GS1 raw parserï¼ˆæ”¯æ´ 01 / 11 / 17 / 10ï¼‰ */
function parseGS1(raw) {
  raw = raw.replace(/\((\d{2})\)/g, '$1');
  let i = 0, o = {};
  const read = n => raw.slice(i, i+=n);

  while (i < raw.length) {
    const ai = raw.slice(i, i+2); i+=2;
    if (ai==='01') o.gtin = read(14);
    else if (ai==='11') o.mfg = read(6);
    else if (ai==='17') o.exp = read(6);
    else if (ai==='10') { o.lot = raw.slice(i); break; }
    else break;
  }

  const serial8 = (o.lot||'').replace(/-.+$/,'').slice(0,8);
  o.key = (o.mfg && o.exp && serial8) ? `${o.mfg}_${o.exp}_${serial8}` : '';
  return o;
}

function fileToURL(file){
  return new Promise(r=>{
    const fr=new FileReader();
    fr.onload=()=>r(fr.result);
    fr.readAsDataURL(file);
  });
}

photo.onchange = async () => {
  const file = photo.files[0];
  if(!file) return;

  spin.style.display='block';
  status.innerText='ğŸ” æ­£åœ¨è§£ç¢¼ GS1-128 æ¢ç¢¼...';

  try{
    const url = await fileToURL(file);
    const result = await reader.decodeFromImageUrl(url);
    const raw = result.getText();   // â­ çœŸæ­£çš„ GS1 raw

    const gs1 = parseGS1(raw);

    if(!gs1.key) throw 'è§£æå¤±æ•—';

    status.innerHTML =
      `<b style="color:green">âœ… æˆåŠŸ</b><br>
       Raw: ${raw}<br>
       GTIN: ${gs1.gtin}<br>
       MFG: ${gs1.mfg}<br>
       EXP: ${gs1.exp}<br>
       LOT: ${gs1.lot}<br>
       KEY: ${gs1.key}`;

    // ğŸ‘‰ ç›´æ¥é€å¾Œç«¯
    await fetch('/api/stock',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        item_uuid: gs1.key,
        product_code: gs1.gtin,
        expiry_date: gs1.exp,
        from_loc:'FACTORY',
        to_loc:'MAIN',
        operator:'GS1æƒæ'
      })
    });

    alert(`âœ… å·²å…¥åº«ï¼š${gs1.key}`);

  }catch(e){
    status.innerHTML = `<b style="color:red">âŒ æ¢ç¢¼è§£ç¢¼å¤±æ•—</b><br>è«‹æ‹è¿‘ä¸€é»ã€é¿å…åå…‰`;
  }finally{
    spin.style.display='none';
    photo.value='';
  }
};
</script>

</body>
</html>
