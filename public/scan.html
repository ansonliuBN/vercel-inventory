<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ™ºèƒ½è¾¨è­˜å…¥åº« - æœ€çµ‚æ——è‰¦ç‰ˆ</title>
<style>
  body { font-family:-apple-system, sans-serif; padding:15px; background:#f4f4f9; text-align:center; margin:0; }
  .card { background:white; padding:15px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }

  /* æŒ‰éˆ•æ¨£å¼ */
  .btn-group { display: flex; gap: 10px; margin-top: 15px; }
  button { flex: 1; padding: 15px; border-radius: 10px; border: none; cursor: pointer; font-size: 16px; font-weight: bold; color: white; transition: 0.3s; }
  .btn-cam { background: #7360f2; }
  .btn-file { background: #2d9cdb; }
  .btn-snap { background: #27ae60; width: 100%; margin-top: 10px; font-size: 18px; }
  .btn-import { background: #27ae60; width: 100%; margin-top: 15px; font-size: 20px; box-shadow: 0 4px 10px rgba(39,174,96,0.3); }
  .btn-back { background: #666; width: auto; font-size: 14px; float: left; padding: 8px 15px; }

  /* é¡¯ç¤ºå€åŸŸèˆ‡å°å¼•æ¡† */
  .camera-wrap { position: relative; width: 100%; aspect-ratio: 4/3; border-radius: 12px; overflow: hidden; border: 2px solid #ddd; background:#000; margin-top: 15px; display: none; }
  video, #photoPreview { width:100%; height:100%; object-fit: cover; }
  #photoPreview { display: none; }

  .overlay { position:absolute; inset:0; pointer-events:none; }
  .scan-box { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:85%; height:40%; border:1px solid rgba(255,255,255,0.3); border-radius:12px; box-shadow:0 0 0 9999px rgba(0,0,0,0.5); }
  .corner { position:absolute; width:20px; height:20px; border:4px solid #00ffb3; }
  .c1 { left:-2px; top:-2px; border-right:none; border-bottom:none; border-top-left-radius:12px; }
  .c2 { right:-2px; top:-2px; border-left:none; border-bottom:none; border-top-right-radius:12px; }
  .c3 { left:-2px; bottom:-2px; border-right:none; border-top:none; border-bottom-left-radius:12px; }
  .c4 { right:-2px; bottom:-2px; border-left:none; border-top:none; border-bottom-right-radius:12px; }
  .scan-line { position:absolute; left:5%; top:10%; width:90%; height:2px; background:linear-gradient(90deg,transparent,#00ffb3,transparent); animation: move 2s infinite; }
  @keyframes move { 0%, 100% { top: 10%; } 50% { top: 90%; } }

  /* è¤‡æ ¸è¡¨å–® */
  .review-form { text-align: left; background: #f9f9ff; padding: 15px; border-radius: 12px; border: 2px solid #7360f2; margin-top: 15px; display: none; animation: fadeIn 0.5s; }
  @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
  .review-form label { font-size: 13px; color: #555; font-weight: bold; display: block; margin-top: 10px; }
  .review-form input, .review-form select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-top: 4px; }

  .loader { display:none; margin:10px auto; width:30px; height:30px; border:3px solid #f3f3f3; border-top:3px solid #7360f2; border-radius:50%; animation:spin 1s linear infinite; }
  @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  canvas#workCanvas { display:none; }
</style>
</head>
<body>

<div class="card">
  <button class="btn-back" onclick="location.href='index.html'">â¬…ï¸ è¿”å›ç¸½è¡¨</button>
  <div style="clear: both;"></div>
  <h2>ğŸ“¦ æ™ºèƒ½å…¥åº«è¤‡æ ¸</h2>

  <div class="btn-group" id="modeSelect">
    <button class="btn-cam" onclick="startCamera()">ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿ</button>
    <button class="btn-file" onclick="document.getElementById('fileInput').click()">ğŸ“ ä¸Šå‚³ç…§ç‰‡</button>
  </div>
  <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFileUpload(event)">

  <div class="camera-wrap" id="displayArea">
    <video id="video" autoplay muted playsinline></video>
    <img id="photoPreview" alt="preview">
    <div class="overlay" id="guidelines">
      <div class="scan-box">
        <div class="corner c1"></div><div class="corner c2"></div>
        <div class="corner c3"></div><div class="corner c4"></div>
        <div class="scan-line"></div>
      </div>
    </div>
  </div>

  <button id="btnSnap" class="btn-snap" onclick="takeSnapshot()" style="display:none;">ğŸ“¸ é»æ“Šæ‹ç…§ä¸¦åˆ†æ</button>

  <div class="loader" id="loader"></div>

  <div id="reviewArea" class="review-form">
    <h3 style="margin:0; color:#7360f2; border-bottom:1px solid #ddd; padding-bottom:8px;">ğŸ” è¾¨è­˜çµæœç¢ºèª</h3>

    <label>å‹è™Ÿ (GTIN/æ–™è™Ÿ):</label>
    <input type="text" id="editGtin" placeholder="å°šæœªåµæ¸¬">

    <label>æ‰¹è™Ÿ (Lot/SN/UUID):</label>
    <input type="text" id="editLot" placeholder="å°šæœªåµæ¸¬">

    <label>æœ‰æ•ˆæ—¥æœŸ (æ ¼å¼: YYMMDD):</label>
    <input type="text" id="editExp" placeholder="å°šæœªåµæ¸¬">

    <label>å…¥åº«æ•¸é‡ (ä»¥ 10 ç‚ºå–®ä½):</label>
    <select id="editQty">
      <option value="10">10</option><option value="20">20</option>
      <option value="30">30</option><option value="40">40</option>
      <option value="50">50</option><option value="100">100</option>
    </select>

    <button class="btn-import" onclick="finalSubmit()">âœ… ç¢ºèªè³‡æ–™ï¼ŒåŒ¯å…¥åº«å­˜</button>
    <button onclick="location.reload()" style="background:#eee; color:#444; width:100%; margin-top:10px; font-size:14px;">ğŸ”„ é‡æ‹ä¸€å¼µ</button>
  </div>

  <div id="status" style="margin-top:10px; font-size:13px; color:#888;"></div>
  <canvas id="workCanvas"></canvas>
</div>

<!-- Libraries -->
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
<script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>

<script>
  const video = document.getElementById('video');
  const preview = document.getElementById('photoPreview');
  const loader = document.getElementById('loader');
  const workCanvas = document.getElementById('workCanvas');
  const ctx = workCanvas.getContext('2d');
  let stream = null;

  // ---------- Helpers: crop / preprocess ----------
  function getScanBoxRect() {
    const cw = workCanvas.width;
    const ch = workCanvas.height;

    // âœ… åšæˆã€Œæ›´æ‰ã€çš„æ¢ç¢¼æƒæå¸¶ï¼Œé™ä½å¹²æ“¾
    const boxW = cw * 0.90;
    const boxH = ch * 0.22;

    const x = Math.max(0, Math.floor((cw - boxW) / 2));
    const y = Math.max(0, Math.floor((ch - boxH) / 2));

    return { x, y, w: Math.floor(boxW), h: Math.floor(boxH) };
  }

  function getScanRectsWithOffsets() {
    const base = getScanBoxRect();
    const offsets = [-0.18, -0.10, -0.05, 0, 0.05, 0.10, 0.18]; // ä¸Šä¸‹å¤šæƒå¹¾æ¬¡æ›´ç©©
    return offsets.map(k => ({
      x: base.x,
      y: Math.max(0, Math.floor(base.y + k * base.h)),
      w: base.w,
      h: base.h
    }));
  }

  function cropCanvasToDataURL(rect, scale = 1.0, quality = 0.95) {
    const crop = document.createElement("canvas");
    crop.width = Math.max(1, Math.floor(rect.w * scale));
    crop.height = Math.max(1, Math.floor(rect.h * scale));
    const cctx = crop.getContext("2d");

    cctx.drawImage(
      workCanvas,
      rect.x, rect.y, rect.w, rect.h,
      0, 0, crop.width, crop.height
    );

    return crop.toDataURL("image/jpeg", quality);
  }

  // åŸºæœ¬ç°éš + å°æ¯”æ‹‰é«˜ï¼ˆå¾ˆä¾¿å®œä½†å° 1D æ¢ç¢¼å¸¸æœ‰å¹«åŠ©ï¼‰
  function enhanceCanvasImageData(dataUrl) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        const c = document.createElement('canvas');
        c.width = img.width;
        c.height = img.height;
        const cctx = c.getContext('2d');
        cctx.drawImage(img, 0, 0);

        const id = cctx.getImageData(0, 0, c.width, c.height);
        const d = id.data;

        // ç°éš + ç°¡å–®å°æ¯”
        // å…¬å¼ï¼šnew = (old - 128) * contrast + 128
        const contrast = 1.35;
        for (let i = 0; i < d.length; i += 4) {
          const r = d[i], g = d[i+1], b = d[i+2];
          let y = 0.299*r + 0.587*g + 0.114*b;
          y = (y - 128) * contrast + 128;
          y = Math.max(0, Math.min(255, y));
          d[i] = d[i+1] = d[i+2] = y;
        }
        cctx.putImageData(id, 0, 0);
        resolve(c.toDataURL("image/jpeg", 0.95));
      };
      img.src = dataUrl;
    });
  }

  // ---------- GS1 parsing / validation ----------
  function normalizeText(raw) {
    return (raw || "")
      .replace(/\s+/g, '')
      .replace(/[Il|]/g, '1')
      .replace(/O/g, '0');
  }

  function parseGS1(raw) {
    const s = normalizeText(raw);
    const out = { gtin: '', exp: '', lot: '' };

    const m01 = s.match(/\(01\)(\d{14})/) || s.match(/01(\d{14})/);
    if (m01) out.gtin = m01[1];

    const m17 = s.match(/\(17\)(\d{6})/) || s.match(/17(\d{6})/);
    if (m17) out.exp = m17[1];

    // Lot (10) å¯èƒ½åˆ°ä¸‹ä¸€å€‹ AI å‰çµæŸï¼Œé€™è£¡ç”¨è¼ƒä¿å®ˆæŠ“æ³•
    const m10 = s.match(/\(10\)([A-Z0-9\-]{2,})/) || s.match(/10([A-Z0-9\-]{2,})/);
    if (m10) out.lot = m10[1];

    return out;
  }

  function looksLikeGS1(text) {
    const s = normalizeText(text);

    // å¿…é ˆæœ‰ GTIN 14 ç¢¼
    const has01 = /\(01\)\d{14}/.test(s) || /01\d{14}/.test(s);
    if (!has01) return false;

    // è‡³å°‘è¦æœ‰ exp æˆ– lot å…¶ä¸­ä¹‹ä¸€
    const has17 = /\(17\)\d{6}/.test(s) || /17\d{6}/.test(s);
    const has10 = /\(10\)[A-Z0-9\-]{2,}/.test(s) || /10[A-Z0-9\-]{2,}/.test(s);

    return has17 || has10;
  }

  // ---------- Quagga ----------
  function quaggaDecodeFromDataURL(dataUrl) {
    return new Promise((resolve) => {
      Quagga.decodeSingle(
        {
          src: dataUrl,
          numOfWorkers: 0,
          inputStream: { size: 1600 },
          locator: { patchSize: "medium", halfSample: false },
          decoder: { readers: ["code_128_reader"] },
          locate: true
        },
        (result) => {
          if (result && result.codeResult && result.codeResult.code) {
            resolve(result.codeResult.code);
          } else {
            resolve("");
          }
        }
      );
    });
  }

  async function decodeBarcodeRobust() {
    const rects = getScanRectsWithOffsets();
    const scales = [1.0, 1.6, 2.2, 2.8]; // å¤šä¸€å€‹å€ç‡ï¼Œæ•‘å°æ¢ç¢¼
    const qualities = [0.92, 0.98];      // JPEG å£“ç¸®ä¹Ÿæœƒå½±éŸ¿ç´°ç·š

    for (const rect of rects) {
      for (const scale of scales) {
        for (const q of qualities) {
          const cropped = cropCanvasToDataURL(rect, scale, q);

          // åŸåœ–è©¦ä¸€æ¬¡
          let cand = await quaggaDecodeFromDataURL(cropped);
          if (cand && looksLikeGS1(cand)) return cand;

          // å¢å¼·å¾Œå†è©¦ä¸€æ¬¡ï¼ˆæœ‰æ™‚å€™åå…‰/ç°éšæœƒæ•‘å›ä¾†ï¼‰
          const enhanced = await enhanceCanvasImageData(cropped);
          cand = await quaggaDecodeFromDataURL(enhanced);
          if (cand && looksLikeGS1(cand)) return cand;
        }
      }
    }
    return "";
  }

  // ---------- UI / camera ----------
  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment", width: { ideal: 1920 } }
      });
      video.srcObject = stream;
      document.getElementById('displayArea').style.display = 'block';
      document.getElementById('modeSelect').style.display = 'none';
      document.getElementById('btnSnap').style.display = 'block';
      document.getElementById('status').innerText = "è«‹å°‡æ¢ç¢¼æ”¾å…¥æ¡†å…§å¾Œæ‹ç…§ï¼ˆé¿å…åå…‰ã€ç›¡é‡é è¿‘ï¼‰";
    } catch(e) {
      alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¢ºèªæ¬Šé™");
    }
  }

  function handleFileUpload(e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        workCanvas.width = img.width;
        workCanvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        preview.src = ev.target.result;
        prepareUIForAnalysis();
        triggerAnalysis(ev.target.result);
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  }

  function takeSnapshot() {
    workCanvas.width = video.videoWidth;
    workCanvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, workCanvas.width, workCanvas.height);

    const dataUrl = workCanvas.toDataURL('image/jpeg', 0.92);
    preview.src = dataUrl;

    prepareUIForAnalysis();
    triggerAnalysis(dataUrl);
  }

  function prepareUIForAnalysis() {
    video.style.display = 'none';
    preview.style.display = 'block';
    document.getElementById('displayArea').style.display = 'block';
    document.getElementById('modeSelect').style.display = 'none';
    document.getElementById('btnSnap').style.display = 'none';
    document.getElementById('guidelines').style.display = 'none';
  }

  // ---------- Main pipeline ----------
  async function triggerAnalysis(imgData) {
    loader.style.display = 'block';
    document.getElementById('status').innerText = "âŒ› æ­£åœ¨è¾¨è­˜æ¢ç¢¼ï¼ˆå„ªå…ˆï¼‰...";

    try {
      // 1) æ¢ç¢¼å„ªå…ˆ
      let foundText = await decodeBarcodeRobust();

      // 2) OCR fallbackï¼ˆåª OCR ä¸­é–“æƒæå¸¶ + æ”¾å¤§ + å¢å¼·ï¼‰
      if (!foundText) {
        document.getElementById('status').innerText = "ğŸ§­ æ¢ç¢¼è®€å–å›°é›£ï¼Œå˜—è©¦è¾¨è­˜æ–‡å­—...";
        const rect = getScanBoxRect();
        const cropped = cropCanvasToDataURL(rect, 2.8, 0.98);
        const enhanced = await enhanceCanvasImageData(cropped);

        const ocr = await Tesseract.recognize(enhanced, 'eng');
        foundText = ocr.data.text || "";
      }

      const gs1 = parseGS1(foundText);

      document.getElementById('editGtin').value = gs1.gtin;
      document.getElementById('editLot').value = gs1.lot || normalizeText(foundText).replace(/[^A-Za-z0-9]/g, '').substring(0,12);
      document.getElementById('editExp').value = gs1.exp;

      loader.style.display = 'none';
      document.getElementById('reviewArea').style.display = 'block';
      document.getElementById('status').innerText = gs1.gtin ? "è¾¨è­˜å®Œæˆï¼Œè«‹è¤‡æ ¸è³‡æ–™ã€‚" : "âš ï¸ æ²’æŠ“åˆ°å®Œæ•´ GS1ï¼Œè«‹äººå·¥è¤‡æ ¸æˆ–é‡æ‹ã€‚";
    } catch (err) {
      alert("è¾¨è­˜ç™¼ç”ŸéŒ¯èª¤: " + err.message);
      location.reload();
    }
  }

  // ---------- Submit (unchanged backend) ----------
  async function finalSubmit() {
    const qty = parseInt(document.getElementById('editQty').value, 10);

    const payload = {
      item_uuid: document.getElementById('editLot').value,
      product_code: document.getElementById('editGtin').value,
      expiry_date: document.getElementById('editExp').value,
      quantity: qty,
      from_loc: 'FACTORY',
      to_loc: 'MAIN',
      operator: 'MANUAL_REVIEW'
    };

    loader.style.display = 'block';

    const res = await fetch('/api/stock', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      alert("âœ… åŒ¯å…¥æˆåŠŸï¼å·²å­˜å…¥ " + qty + " ä»¶ç‰©æ–™ã€‚");
      location.href = 'index.html';
    } else {
      const err = await res.json().catch(() => ({message: "é€£ç·šç•°å¸¸"}));
      alert("âŒ å¤±æ•—: " + err.message);
      loader.style.display = 'none';
    }
  }
</script>
</body>
</html>
