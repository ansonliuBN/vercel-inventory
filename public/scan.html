<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ™ºèƒ½å…¥åº« - æ‰‹å‹•è¤‡æ ¸ç‰ˆ</title>
<style>
  body { font-family:-apple-system, sans-serif; padding:15px; background:#f4f4f9; text-align:center; margin:0; }
  .card { background:white; padding:15px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
  .btn-group { display: flex; gap: 10px; margin-top: 15px; }
  button { flex: 1; padding: 15px; border-radius: 10px; border: none; cursor: pointer; font-size: 16px; font-weight: bold; color: white; }
  .btn-cam { background: #7360f2; }
  .btn-file { background: #2d9cdb; }
  .btn-import { background: #27ae60; width: 100%; margin-top: 20px; font-size: 20px; }
  .camera-wrap { position: relative; width: 100%; aspect-ratio: 4/3; border-radius: 12px; overflow: hidden; border: 2px solid #ddd; background:#000; margin-top: 15px; display: none; }
  video, #photoPreview { width:100%; height:100%; object-fit: cover; }
  #photoPreview { display: none; }
  
  /* ç·¨è¼¯è¡¨å–®æ¨£å¼ */
  .review-form { text-align: left; background: #f9f9ff; padding: 15px; border-radius: 12px; border: 1px solid #7360f2; margin-top: 15px; display: none; }
  .review-form label { font-size: 14px; color: #666; font-weight: bold; display: block; margin-top: 10px; }
  .review-form input, .review-form select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-top: 5px; }
  
  .loader { display:none; margin:10px auto; width:30px; height:30px; border:3px solid #f3f3f3; border-top:3px solid #7360f2; border-radius:50%; animation:spin 1s linear infinite; }
  @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  canvas#workCanvas { display:none; }
</style>
</head>
<body>

<div class="card">
  <button onclick="location.href='index.html'" style="color:#666; background:none; float:left;">â¬…ï¸ è¿”å›</button>
  <div style="clear:both;"></div>
  <h2>ğŸ“¦ å…¥åº«è¤‡æ ¸ç³»çµ±</h2>
  
  <div class="btn-group" id="modeSelect">
    <button class="btn-cam" onclick="startCamera()">ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿ</button>
    <button class="btn-file" onclick="document.getElementById('fileInput').click()">ğŸ“ ä¸Šå‚³ç…§ç‰‡</button>
  </div>
  <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFileUpload(event)">

  <div class="camera-wrap" id="displayArea">
    <video id="video" autoplay muted playsinline></video>
    <img id="photoPreview">
  </div>

  <button id="btnSnap" class="btn-cam" onclick="takeSnapshot()" style="display:none; width:100%; margin-top:10px;">ğŸ“¸ æ‹ç…§è¾¨è­˜</button>

  <div class="loader" id="loader"></div>

  <div id="reviewArea" class="review-form">
    <h3 style="margin:0; color:#7360f2;">ğŸ” è«‹ç¢ºèªè³‡æ–™</h3>
    
    <label>å‹è™Ÿ (æ–™è™Ÿ/GTIN):</label>
    <input type="text" id="editGtin">
    
    <label>æ‰¹è™Ÿ (åºè™Ÿ/Lot):</label>
    <input type="text" id="editLot">
    
    <label>éæœŸæ™‚é–“ (YYMMDD):</label>
    <input type="text" id="editExp">
    
    <label>å…¥åº«æ•¸é‡ (ä»¥ 10 ç‚ºå–®ä½):</label>
    <select id="editQty">
      <option value="10">10</option>
      <option value="20">20</option>
      <option value="30">30</option>
      <option value="40">40</option>
      <option value="50">50</option>
      <option value="100">100</option>
    </select>
    
    <button class="btn-import" onclick="finalSubmit()">âœ… ç¢ºèªåŒ¯å…¥è³‡æ–™åº«</button>
    <button onclick="location.reload()" style="background:#eee; color:#666; width:100%; margin-top:10px;">ğŸ”„ é‡æ‹/å–æ¶ˆ</button>
  </div>

  <div id="status" style="margin-top:10px; color:#666;"></div>
  <canvas id="workCanvas"></canvas>
</div>

<script src="https://unpkg.com/@zxing/library@0.19.1"></script>
<script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>

<script>
  const video = document.getElementById('video');
  const preview = document.getElementById('photoPreview');
  const loader = document.getElementById('loader');
  const workCanvas = document.getElementById('workCanvas');
  const ctx = workCanvas.getContext('2d');
  let stream = null;

  // --- ç›¸æ©Ÿèˆ‡æª”æ¡ˆè™•ç† ---
  async function startCamera() {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    document.getElementById('displayArea').style.display = 'block';
    document.getElementById('modeSelect').style.display = 'none';
    document.getElementById('btnSnap').style.display = 'block';
  }

  function handleFileUpload(e) {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
            workCanvas.width = img.width; workCanvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            preview.src = ev.target.result;
            showPreview();
            triggerAnalysis(ev.target.result);
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  }

  function takeSnapshot() {
    workCanvas.width = video.videoWidth; workCanvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, workCanvas.width, workCanvas.height);
    const dataUrl = workCanvas.toDataURL('image/jpeg');
    preview.src = dataUrl;
    showPreview();
    triggerAnalysis(dataUrl);
  }

  function showPreview() {
    video.style.display = 'none'; preview.style.display = 'block';
    document.getElementById('displayArea').style.display = 'block';
    document.getElementById('modeSelect').style.display = 'none';
    document.getElementById('btnSnap').style.display = 'none';
  }

  // --- è¾¨è­˜èˆ‡è¡¨å–®é¡¯ç¤º ---
  async function triggerAnalysis(imgData) {
    loader.style.display = 'block';
    try {
      const reader = new ZXing.BrowserMultiFormatReader();
      let raw = "";
      try {
        const res = await reader.decodeFromCanvas(workCanvas);
        raw = res.getText();
      } catch(e) {
        const ocr = await Tesseract.recognize(imgData, 'eng');
        raw = ocr.data.text;
      }
      
      const gs1 = parseGS1(raw);
      
      // å¡«å…¥è¡¨å–®ä¾›æª¢æŸ¥
      document.getElementById('editGtin').value = gs1.gtin;
      document.getElementById('editLot').value = gs1.lot || gs1.raw.substring(0,12);
      document.getElementById('editExp').value = gs1.exp;
      
      loader.style.display = 'none';
      document.getElementById('reviewArea').style.display = 'block';
    } catch(err) {
      alert("è¾¨è­˜å¤±æ•—ï¼Œè«‹é‡è©¦");
      location.reload();
    }
  }

  function parseGS1(raw) {
    let s = raw.replace(/\s+/g, '');
    const out = { raw: s, gtin: '', exp: '', lot: '' };
    const m01 = s.match(/\(01\)(\d+)/); if(m01) out.gtin = m01[1];
    const m17 = s.match(/\(17\)(\d+)/); if(m17) out.exp = m17[1];
    const m10 = s.match(/\(10\)([A-Z0-9-]+)/); if(m10) out.lot = m10[1];
    return out;
  }

  // --- æœ€çµ‚åŒ¯å…¥ ---
  async function finalSubmit() {
    const payload = {
      item_uuid: document.getElementById('editLot').value,
      product_code: document.getElementById('editGtin').value,
      expiry_date: document.getElementById('editExp').value,
      quantity: parseInt(document.getElementById('editQty').value),
      from_loc: 'FACTORY',
      to_loc: 'MAIN',
      operator: 'MANUAL_REVIEW'
    };

    loader.style.display = 'block';
    const res = await fetch('/api/stock', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      alert("âœ… åŒ¯å…¥æˆåŠŸï¼å…± " + payload.quantity + " ä»¶");
      location.href = 'index.html';
    } else {
      const err = await res.json();
      alert("âŒ å¤±æ•—: " + (err.message || "è³‡æ–™åº«æ‹’çµ•å¯«å…¥"));
      loader.style.display = 'none';
    }
  }
</script>
</body>
</html>