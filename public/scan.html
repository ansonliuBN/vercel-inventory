<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ™ºèƒ½æ‹ç…§è¾¨è­˜ç³»çµ± - ç©©å®šç‰ˆ</title>
<style>
  body { font-family:-apple-system, sans-serif; padding:15px; background:#f4f4f9; color:#333; text-align:center; margin:0; }
  .card { background:white; padding:15px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
  button { background:#7360f2; color:white; border:none; padding:15px; border-radius:10px; cursor:pointer; width:100%; font-size:18px; font-weight:bold; margin-top:10px; }
  .snap-btn { background:#27ae60; } /* æ‹ç…§æŒ‰éˆ•ç¶ è‰² */
  .secondary { background:#444; }
  .back-btn { background:#666; margin-top: 15px; }
  
  /* å®¹å™¨èˆ‡é¡¯ç¤º */
  .camera-wrap { position: relative; width: 100%; aspect-ratio: 4/3; border-radius: 12px; overflow: hidden; border: 2px solid #7360f2; background:#000; margin-top: 15px; }
  video, #photoPreview { width:100%; height:100%; object-fit: cover; }
  #photoPreview { display: none; } /* æ‹å®Œå¾Œé¡¯ç¤ºé€™å¼µåœ– */

  /* å°å¼•æ¡† */
  .overlay { position:absolute; inset:0; pointer-events:none; }
  .scan-box { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:85%; height:40%; border:1px solid rgba(255,255,255,0.3); border-radius:12px; box-shadow:0 0 0 9999px rgba(0,0,0,0.5); }
  .corner { position:absolute; width:20px; height:20px; border:4px solid #00ffb3; }
  .c1 { left:-2px; top:-2px; border-right:none; border-bottom:none; border-top-left-radius:12px; }
  .c2 { right:-2px; top:-2px; border-left:none; border-bottom:none; border-top-right-radius:12px; }
  .c3 { left:-2px; bottom:-2px; border-right:none; border-top:none; border-bottom-left-radius:12px; }
  .c4 { right:-2px; bottom:-2px; border-left:none; border-top:none; border-bottom-right-radius:12px; }

  #status { margin-top:12px; font-size:14px; min-height:80px; line-height:1.5; color: #555; }
  .spinner { display:none; margin:10px auto; width:30px; height:30px; border:3px solid #f3f3f3; border-top:3px solid #7360f2; border-radius:50%; animation:spin 1s linear infinite; }
  @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  canvas#workCanvas { display:none; }
</style>
</head>
<body>

<div class="card">
  <button class="back-btn" onclick="location.href='index.html'" style="width: auto; padding: 8px 20px; float: left; margin-top: 0;">â¬…ï¸ è¿”å›</button>
  <div style="clear: both;"></div>
  
  <h2>ğŸ“¸ æ‹ç…§è¾¨è­˜å…¥åº«</h2>
  
  <div class="camera-wrap" id="cameraWrap">
    <video id="video" autoplay muted playsinline></video>
    <img id="photoPreview" alt="Captured photo">
    <div class="overlay" id="guidelines">
      <div class="scan-box">
        <div class="corner c1"></div><div class="corner c2"></div>
        <div class="corner c3"></div><div class="corner c4"></div>
      </div>
    </div>
  </div>

  <div class="spinner" id="loader"></div>
  <div id="status">æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...</div>

  <button id="btnSnap" class="snap-btn" onclick="takeSnapshot()" style="display:none;">ğŸ“¸ é»æ“Šæ‹ç…§è¾¨è­˜</button>
  <button id="btnRetry" class="secondary" onclick="resetUI()" style="display:none;">ğŸ”„ é‡æ‹ä¸€å¼µ</button>

  <canvas id="workCanvas"></canvas>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>

<script>
  const video = document.getElementById('video');
  const preview = document.getElementById('photoPreview');
  const statusEl = document.getElementById('status');
  const loader = document.getElementById('loader');
  const workCanvas = document.getElementById('workCanvas');
  const ctx = workCanvas.getContext('2d', { willReadFrequently: true });

  let stream = null;

  // --- å•Ÿå‹•ç›¸æ©Ÿ ---
  async function initCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1920 } } });
      video.srcObject = stream;
      document.getElementById('btnSnap').style.display = 'block';
      statusEl.innerText = "è«‹å°‡æ¢ç¢¼æ”¾å…¥æ¡†å…§å¾Œæ‹ç…§";
    } catch (e) {
      statusEl.innerHTML = `<b style="color:red">ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—</b><br>${e.message}`;
    }
  }

  // --- æ‹ç…§ä¸¦è§¸ç™¼å¾Œå°åˆ†æ ---
  async function takeSnapshot() {
    // 1. å®šæ ¼ç•«é¢
    workCanvas.width = video.videoWidth;
    workCanvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, workCanvas.width, workCanvas.height);
    
    const dataUrl = workCanvas.toDataURL('image/jpeg', 0.9);
    preview.src = dataUrl;
    
    // 2. åˆ‡æ› UI
    video.style.display = 'none';
    preview.style.display = 'block';
    document.getElementById('guidelines').style.display = 'none';
    document.getElementById('btnSnap').style.display = 'none';
    document.getElementById('btnRetry').style.display = 'block';
    
    loader.style.display = 'block';
    statusEl.innerHTML = "âŒ› æ­£åœ¨é€²è¡Œæ·±åº¦åˆ†æ (ZXing + OCR)...";

    // 3. åŸ·è¡Œåˆ†æ
    analyzeImage(dataUrl);
  }

  async function analyzeImage(imgData) {
    try {
      const ZX = window.ZXingBrowser || window.ZXing;
      const reader = new ZX.BrowserMultiFormatReader();
      let resultText = "";

      // A. å˜—è©¦æ¢ç¢¼ (å¤šè§’åº¦æš´åŠ›ç ´è§£)
      const rotations = [0, 90, 270];
      for (let rot of rotations) {
        if (rot !== 0) {
            rotateCanvas(rot);
        }
        try {
          const res = await reader.decodeFromCanvas(workCanvas);
          if (res) { resultText = res.getText(); break; }
        } catch(e) {}
      }

      // B. å¦‚æœæ¢ç¢¼æ²’ä¸­ï¼Œè·‘ OCR
      if (!resultText) {
        statusEl.innerHTML = "ğŸ§­ æ¢ç¢¼è¼ƒé›£è®€å–ï¼Œåˆ‡æ›è‡³ OCR æ–‡å­—è¾¨è­˜...";
        const ocrRes = await Tesseract.recognize(imgData, 'eng');
        resultText = ocrRes.data.text.replace(/\s+/g, '');
      }

      if (resultText) {
        handleFinalData(resultText);
      } else {
        statusEl.innerHTML = "âŒ ç„¡æ³•è¾¨è­˜å…§å®¹ï¼Œè«‹ç¢ºä¿å…‰ç·šå……è¶³ä¸¦é‡æ‹ã€‚";
        loader.style.display = 'none';
      }
    } catch (err) {
      statusEl.innerText = "å‡ºéŒ¯äº†: " + err.message;
      loader.style.display = 'none';
    }
  }

  function handleFinalData(rawText) {
    loader.style.display = 'none';
    const gs1 = parseGS1(rawText);
    
    const info = `
      <div style="text-align:left; background:#eef2ff; padding:10px; border-radius:10px; margin-top:10px;">
        <b>è¾¨è­˜ UUID:</b> <span style="color:blue">${gs1.key}</span><br>
        <b>æ•ˆæœŸ:</b> ${gs1.exp || 'ç„¡'}<br>
        <small>åŸå§‹ç¢¼: ${rawText.substring(0, 30)}...</small>
      </div>
    `;
    statusEl.innerHTML = info;

    if (confirm(`ç¢ºèªå…¥åº« [${gs1.key}] å—ï¼Ÿ`)) {
      saveToDB(gs1);
    }
  }

  async function saveToDB(gs1) {
    loader.style.display = 'block';
    const res = await fetch('/api/stock', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        item_uuid: gs1.key,
        product_code: gs1.gtin,
        expiry_date: gs1.exp,
        from_loc: 'FACTORY',
        to_loc: 'MAIN',
        operator: 'SNAP_MODE'
      })
    });
    if (res.ok) {
      alert("âœ… å…¥åº«æˆåŠŸï¼");
      location.href = 'index.html';
    } else {
      alert("âŒ å­˜å…¥å¤±æ•—");
      loader.style.display = 'none';
    }
  }

  function rotateCanvas(deg) {
    const tempW = workCanvas.width;
    const tempH = workCanvas.height;
    const tempCanvas = document.createElement('canvas');
    const tCtx = tempCanvas.getContext('2d');
    tempCanvas.width = tempH; tempCanvas.height = tempW;
    tCtx.translate(tempH/2, tempW/2);
    tCtx.rotate(deg * Math.PI / 180);
    tCtx.drawImage(preview, -tempW/2, -tempH/2);
    workCanvas.width = tempCanvas.width;
    workCanvas.height = tempCanvas.height;
    ctx.drawImage(tempCanvas, 0, 0);
  }

  function resetUI() {
    video.style.display = 'block';
    preview.style.display = 'none';
    document.getElementById('guidelines').style.display = 'block';
    document.getElementById('btnSnap').style.display = 'block';
    document.getElementById('btnRetry').style.display = 'none';
    statusEl.innerText = "è«‹å°æº–æ¢ç¢¼å¾Œæ‹ç…§";
    loader.style.display = 'none';
  }

  function parseGS1(raw) {
    let s = String(raw || '').replace(/\s+/g, '').replace(/[\[\{]/g, '(').replace(/[\]\}]/g, ')');
    const out = { gtin:'', mfg:'', exp:'', sn:'' };
    const matches = s.matchAll(/\((\d{2})\)([^()]+)/g);
    for (const m of matches) {
      const ai = m[1], val = m[2];
      if (ai === '01') out.gtin = val;
      if (ai === '11') out.mfg = val;
      if (ai === '17') out.exp = val;
      if (ai === '21') out.sn = val;
    }
    const sn8 = (out.sn || s).replace(/[^A-Za-z0-9]/g, '').substring(0, 8).toUpperCase();
    out.key = (out.mfg && out.exp) ? `${out.mfg}_${out.exp}_${sn8}` : (sn8 || "UNKNOWN");
    return out;
  }

  initCamera();
</script>
</body>
</html>