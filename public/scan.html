<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ™ºèƒ½è¾¨è­˜ç³»çµ± - è¨ºæ–·ä¿®æ­£ç‰ˆ</title>
<style>
  body { font-family:-apple-system, sans-serif; padding:15px; background:#f4f4f9; color:#333; text-align:center; margin:0; }
  .card { background:white; padding:15px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
  button { background:#7360f2; color:white; border:none; padding:15px; border-radius:10px; cursor:pointer; width:100%; font-size:16px; font-weight:bold; margin-top:10px; }
  .secondary { background:#444; }
  .back-btn { background:#666; margin-top: 15px; }
  .camera-wrap { position: relative; width: 100%; aspect-ratio: 4/3; border-radius: 12px; overflow: hidden; border: 2px solid #7360f2; background:#000; display:none; margin-top: 15px; }
  video { width:100%; height:100%; object-fit: cover; }
  .overlay { position:absolute; inset:0; pointer-events:none; }
  .scan-box { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:85%; height:40%; border:1px solid rgba(255,255,255,0.3); border-radius:12px; box-shadow:0 0 0 9999px rgba(0,0,0,0.5); }
  .corner { position:absolute; width:20px; height:20px; border:4px solid #00ffb3; }
  .c1 { left:-2px; top:-2px; border-right:none; border-bottom:none; border-top-left-radius:12px; }
  .c2 { right:-2px; top:-2px; border-left:none; border-bottom:none; border-top-right-radius:12px; }
  .c3 { left:-2px; bottom:-2px; border-right:none; border-top:none; border-bottom-left-radius:12px; }
  .c4 { right:-2px; bottom:-2px; border-left:none; border-top:none; border-bottom-right-radius:12px; }
  #status { margin-top:12px; font-size:14px; min-height:80px; line-height:1.5; color: #555; }
  canvas#workCanvas { display:none; }
</style>
</head>
<body>

<div class="card">
  <button class="back-btn" onclick="location.href='index.html'" style="width: auto; padding: 8px 20px; float: left; margin-top: 0;">â¬…ï¸ è¿”å›</button>
  <div style="clear: both;"></div>
  
  <h2>ğŸ“¸ æ™ºèƒ½è¾¨è­˜ç³»çµ±</h2>
  <button id="btnStart" onclick="window.__startScan()">ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿ</button>
  <button id="btnStop" class="secondary" onclick="window.__stopScan()" disabled>â›” åœæ­¢</button>

  <div class="camera-wrap" id="cameraWrap">
    <video id="video" autoplay muted playsinline></video>
    <div class="overlay"><div class="scan-box"><div class="corner c1"></div><div class="corner c2"></div><div class="corner c3"></div><div class="corner c4"></div></div></div>
  </div>

  <div id="status">âœ… ç³»çµ±å°±ç·’ï¼Œè«‹æŒ‰é–‹å•Ÿç›¸æ©Ÿ</div>
  <canvas id="workCanvas"></canvas>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>

<script>
  const video = document.getElementById('video');
  const statusEl = document.getElementById('status');
  const cameraWrap = document.getElementById('cameraWrap');
  const workCanvas = document.getElementById('workCanvas');
  const workCtx = workCanvas.getContext('2d', { willReadFrequently: true });

  let stream = null, scanning = false, reader = null, controls = null, watchdogTimer = null;

  function setStatus(h){ statusEl.innerHTML = h; }

  // --- GS1 è§£æ ---
  function parseGS1(raw) {
    let s = String(raw || '').replace(/\s+/g, '').replace(/[\[\{]/g, '(').replace(/[\]\}]/g, ')');
    const out = { gtin:'', mfg:'', exp:'', sn:'' };
    const matches = s.matchAll(/\((\d{2})\)([^()]+)/g);
    for (const m of matches) {
      const ai = m[1], val = m[2];
      if (ai === '01') out.gtin = val;
      if (ai === '11') out.mfg = val;
      if (ai === '17') out.exp = val;
      if (ai === '21') out.sn = val;
    }
    const sn8 = (out.sn || s).replace(/[^A-Za-z0-9]/g, '').substring(0, 8).toUpperCase();
    out.key = (out.mfg && out.exp) ? `${out.mfg}_${out.exp}_${sn8}` : (sn8 || "UNKNOWN");
    return out;
  }

  async function finish(text, method) {
    scanning = false; clearInterval(watchdogTimer);
    try {
        const gs1 = parseGS1(text);
        setStatus(`ğŸš€ æ­£åœ¨å…¥åº«... ${gs1.key}`);
        await fetch('/api/stock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ item_uuid: gs1.key, product_code: gs1.gtin, expiry_date: gs1.exp, from_loc: 'FACTORY', to_loc: 'MAIN', operator: `AUTO_${method}` })
        });
        alert(`âœ… å…¥åº«æˆåŠŸï¼\nKey: ${gs1.key}`);
        location.href = 'index.html';
    } catch(e) {
        alert("API å¯«å…¥å¤±æ•—: " + e.message);
        window.__stopScan();
    }
  }

  window.__startScan = async function() {
    setStatus('âŒ› æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...');
    try {
      // 1. å…ˆç¢ºèªå¥—ä»¶æœ‰æ²’æœ‰è®€åˆ°
      const ZX = window.ZXingBrowser || window.ZXing;
      if (!ZX) throw new Error("ZXing å¥—ä»¶è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");

      // 2. å•Ÿå‹•é¡é ­ (æ‹¿æ‰ ideal å¯¬åº¦é™åˆ¶ï¼Œå¢åŠ ç›¸å®¹æ€§)
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
      cameraWrap.style.display = 'block';
      
      document.getElementById('btnStart').disabled = true;
      document.getElementById('btnStop').disabled = false;
      scanning = true;
      let lastSeenAt = Date.now();

      // 3. åˆå§‹åŒ–æƒæå™¨
      const hints = new Map();
      hints.set(ZX.DecodeHintType.TRY_HARDER, true);
      
      reader = new ZX.BrowserMultiFormatReader(hints);
      setStatus('ğŸ” æƒæå™¨å•Ÿå‹•ä¸­ï¼Œè«‹å°æº–æ¢ç¢¼...');

      controls = await reader.decodeFromVideoDevice(null, video, (res) => {
        if (res && scanning) finish(res.getText(), 'ZXING');
      });

      // 4. èƒŒæ™¯è¼”åŠ©é‚è¼¯
      watchdogTimer = setInterval(async () => {
        if (!scanning) return;
        const idle = Date.now() - lastSeenAt;
        if (idle > 5000) { // å»¶é•·åˆ° 5 ç§’æ‰è·‘æ—‹è½‰
          setStatus('ğŸ§­ å˜—è©¦æ—‹è½‰è§£ç¢¼ä¸­...');
          // æ—‹è½‰é‚è¼¯ç•¥...
        }
      }, 3000);

    } catch (e) {
      // âš ï¸ é€™è£¡æœƒå‘Šè¨´ä½ ç‚ºä»€éº¼é¡¯ç¤ºã€Œå·²åœæ­¢ã€
      console.error(e);
      alert("âŒ å•Ÿå‹•å¤±æ•—ï¼š\n" + e.message + "\n\nè«‹ç¢ºèªï¼š\n1. æ˜¯å¦ç‚º HTTPS ç’°å¢ƒ\n2. æ˜¯å¦å…è¨±ç›¸æ©Ÿæ¬Šé™");
      window.__stopScan();
    }
  };

  window.__stopScan = function() {
    scanning = false; 
    clearInterval(watchdogTimer);
    if (controls) controls.stop();
    if (stream) stream.getTracks().forEach(t => t.stop());
    video.srcObject = null;
    cameraWrap.style.display = 'none';
    document.getElementById('btnStart').disabled = false;
    document.getElementById('btnStop').disabled = true;
    setStatus('â›” å·²åœæ­¢ã€‚');
  };
</script>
</body>
</html>