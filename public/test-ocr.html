<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>TEST-OCR - Full Image OCR + Rotate + Regex (GS1-128 AI)</title>
<link rel="icon" href="data:,">
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:#f4f4f9; margin:0; padding:16px; }
  .card { max-width: 820px; margin: 0 auto; background:#fff; border-radius:14px; box-shadow:0 4px 16px rgba(0,0,0,.08); padding:16px; }
  h2 { margin: 0 0 10px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .row > * { flex:1; }
  .btn { background:#7360f2; color:#fff; border:none; border-radius:10px; padding:12px 14px; font-weight:700; cursor:pointer; }
  .btn:disabled { opacity:.5; cursor:not-allowed; }
  .btn2 { background:#2d9cdb; }
  .btn3 { background:#27ae60; }
  input[type=file] { width:100%; }
  .status { margin-top:10px; font-size:13px; color:#555; }
  .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef; color:#333; font-size:12px; margin-top:8px; }
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
  .box { border:1px solid #e6e6ef; border-radius:12px; padding:12px; background:#fafafe; }
  label { font-size:12px; font-weight:700; color:#444; display:block; margin-bottom:6px; }
  textarea, input { width:100%; border:1px solid #ddd; border-radius:10px; padding:10px; box-sizing:border-box; font-size:14px; background:#fff; }
  textarea { min-height: 160px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .imgwrap { margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; }
  .imgcard { flex: 1; min-width: 240px; border:1px solid #eee; border-radius:12px; padding:10px; background:#fff; }
  .imgcard b { display:block; font-size:12px; color:#666; margin-bottom:6px; }
  img { width:100%; border-radius:10px; border:1px solid #eee; background:#fff; }
  .loader { display:none; width:28px; height:28px; border:3px solid #eee; border-top:3px solid #7360f2; border-radius:50%; animation:spin 1s linear infinite; margin-left:8px; }
  @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
  .small { font-size:12px; color:#777; margin-top:6px; line-height:1.4; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
</style>
</head>
<body>
  <div class="card">
    <h2>ğŸ§ª TEST-OCRï¼šå…¨åœ– OCR + æ—‹è½‰ + Regexï¼ˆGS1 AIï¼‰</h2>

    <div class="row">
      <div>
        <input type="file" id="fileInput" accept="image/*">
        <div class="small">å»ºè­°ï¼šç›´æ¥ä¸Šå‚³ä½ æ‰‹æ©Ÿæ‹çš„åŸåœ–ï¼ˆä¸è¦æˆªåœ–å£“ç¸®ï¼‰ã€‚</div>
      </div>
      <button class="btn btn2" id="btnLoadDemo">è¼‰å…¥ç¤ºä¾‹ï¼ˆå¯ç•¥ï¼‰</button>
      <button class="btn btn3" id="btnRun" disabled>é–‹å§‹ OCR æ¸¬è©¦</button>
      <div class="loader" id="loader"></div>
    </div>

    <div class="status" id="status">ç‹€æ…‹ï¼šç­‰å¾…åœ–ç‰‡</div>
    <div class="pill" id="pill" style="display:none;"></div>

    <div class="imgwrap">
      <div class="imgcard">
        <b>åŸåœ–é è¦½</b>
        <img id="imgPreview" alt="preview">
      </div>
      <div class="imgcard">
        <b>ç›®å‰ OCR é¤µå…¥ï¼ˆæ—‹è½‰å¾Œï¼‰</b>
        <img id="imgFeed" alt="feed">
      </div>
    </div>

    <div class="grid">
      <div class="box">
        <label>æŠ½å–çµæœï¼ˆRegex è§£æï¼‰</label>
        <div class="row" style="gap:10px;">
          <div>
            <label>GTIN (01)</label>
            <input id="outGtin" placeholder=""/>
          </div>
          <div>
            <label>EXP (17) YYMMDD</label>
            <input id="outExp" placeholder=""/>
          </div>
        </div>
        <div class="row" style="gap:10px; margin-top:8px;">
          <div>
            <label>LOT (10) / SERIAL (21)</label>
            <input id="outLot" placeholder=""/>
          </div>
          <div>
            <label>å‘½ä¸­è§’åº¦ / ä¾†æº</label>
            <input id="outAngle" placeholder=""/>
          </div>
        </div>
        <div class="small mono" id="outHint"></div>
      </div>

      <div class="box">
        <label>æ¯å€‹è§’åº¦çš„ OCR æ¦‚è¦ï¼ˆlogï¼‰</label>
        <textarea id="log" placeholder="log..."></textarea>
      </div>
    </div>

    <div class="box" style="margin-top:12px;">
      <label>RAW OCR æ–‡å­—ï¼ˆå‘½ä¸­é‚£ä¸€æ¬¡ï¼‰</label>
      <textarea id="rawText" placeholder="æœƒé¡¯ç¤ºå‘½ä¸­è§’åº¦çš„ OCR åŸæ–‡ï¼ˆå·²åšåŸºæœ¬ normalizeï¼‰ã€‚"></textarea>
      <div class="small">
        ä½ è¦ç¢ºèªçš„å°±æ˜¯ï¼šé€™è£¡åˆ°åº•æœ‰æ²’æœ‰å‡ºç¾ <span class="mono">(01)...(17)...(21)/(10)</span>ï¼Œä»¥åŠæ‹¬è™Ÿ/æ•¸å­—æœ‰æ²’æœ‰è¢«è®€å£ã€‚
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@7/dist/tesseract.min.js"></script>
<script>
  const fileInput = document.getElementById('fileInput');
  const btnRun = document.getElementById('btnRun');
  const btnLoadDemo = document.getElementById('btnLoadDemo');
  const imgPreview = document.getElementById('imgPreview');
  const imgFeed = document.getElementById('imgFeed');
  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('log');
  const rawEl = document.getElementById('rawText');
  const pill = document.getElementById('pill');
  const loader = document.getElementById('loader');

  const outGtin = document.getElementById('outGtin');
  const outExp = document.getElementById('outExp');
  const outLot = document.getElementById('outLot');
  const outAngle = document.getElementById('outAngle');
  const outHint = document.getElementById('outHint');

  let baseImageDataUrl = "";
  let worker = null;

  function setStatus(msg){ statusEl.textContent = "ç‹€æ…‹ï¼š" + msg; }
  function setLoading(on){
    loader.style.display = on ? "inline-block" : "none";
    btnRun.disabled = on || !baseImageDataUrl;
    fileInput.disabled = on;
    btnLoadDemo.disabled = on;
  }

  function appendLog(line){
    logEl.value += (logEl.value ? "\n" : "") + line;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function resetOutputs(){
    logEl.value = "";
    rawEl.value = "";
    outGtin.value = "";
    outExp.value = "";
    outLot.value = "";
    outAngle.value = "";
    outHint.textContent = "";
    pill.style.display = "none";
    pill.textContent = "";
    imgFeed.src = "";
  }

  function fileToDataUrl(file){
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  // normalizeï¼šä¿ç•™æ‹¬è™Ÿï¼Œåš OCR å¸¸è¦‹éŒ¯èª¤ä¿®æ­£
  function normalizeTextKeepParens(raw){
    return (raw || "")
      .replace(/\u00A0/g, " ")
      .replace(/[ \t\r]+/g, " ")
      .replace(/\n+/g, "\n")
      .replace(/[Il|]/g, "1")
      .replace(/O/g, "0");
  }

  // compactï¼šæ‹¿ä¾†åš regex æŠ“ AIï¼ˆå»æ‰ç©ºç™½æ›è¡Œï¼‰
  function compact(raw){
    return normalizeTextKeepParens(raw).replace(/\s+/g, "");
  }

  // GS1 æ ¸å¿ƒåˆ¤æ–·
  function hasGS1Core(s){
    const t = compact(s);
    const has01 = /(?:\(?01\)?)(\d{14})/.test(t);
    const has17 = /(?:\(?17\)?)(\d{6})/.test(t);
    return has01 && has17;
  }

  // æŠ½å–ï¼š01/17 å¿…è¦ï¼›lotå„ªå…ˆ 21ï¼Œå…¶æ¬¡ 10
  function extractGS1(s){
    const t = compact(s);

    const m01 = t.match(/\(01\)(\d{14})/) || t.match(/01(\d{14})/);
    const m17 = t.match(/\(17\)(\d{6})/)  || t.match(/17(\d{6})/);

    // å¯è®Šé•·åº¦ï¼šæŠ“åˆ°ä¸‹ä¸€å€‹ AI å°±åœï¼ˆ01/11/17/10/21ï¼‰
    const stop = "(?:\\(?01\\)?|\\(?11\\)?|\\(?17\\)?|\\(?10\\)?|\\(?21\\)?|$)";
    const re21 = new RegExp("\\(21\\)([A-Z0-9\\-]{1,40})(?=" + stop + ")", "i");
    const re10 = new RegExp("\\(10\\)([A-Z0-9\\-]{1,40})(?=" + stop + ")", "i");

    const m21 = t.match(re21) || t.match(/21([A-Z0-9\-]{1,40})(?=(?:\(?01\)?|\(?11\)?|\(?17\)?|\(?10\)?|\(?21\)?|$))/i);
    const m10 = t.match(re10) || t.match(/10([A-Z0-9\-]{1,40})(?=(?:\(?01\)?|\(?11\)?|\(?17\)?|\(?10\)?|\(?21\)?|$))/i);

    return {
      gtin: m01 ? m01[1] : "",
      exp:  m17 ? m17[1] : "",
      lot:  (m21 && m21[1]) ? m21[1] : ((m10 && m10[1]) ? m10[1] : "")
    };
  }

  // Canvas helpers
  async function loadImageToCanvas(dataUrl){
    const img = new Image();
    img.crossOrigin = "anonymous";
    await new Promise((res, rej) => {
      img.onload = res;
      img.onerror = rej;
      img.src = dataUrl;
    });
    const c = document.createElement("canvas");
    c.width = img.naturalWidth || img.width;
    c.height = img.naturalHeight || img.height;
    const g = c.getContext("2d", { willReadFrequently:true });

    // white bg
    g.fillStyle = "#fff";
    g.fillRect(0,0,c.width,c.height);
    g.drawImage(img, 0, 0);
    return c;
  }

  function rotateCanvas(src, deg){
    const rad = deg * Math.PI / 180;
    const c = document.createElement("canvas");
    const g = c.getContext("2d", { willReadFrequently:true });

    if (deg % 180 !== 0){ c.width = src.height; c.height = src.width; }
    else { c.width = src.width; c.height = src.height; }

    g.fillStyle = "#fff";
    g.fillRect(0,0,c.width,c.height);

    g.translate(c.width/2, c.height/2);
    g.rotate(rad);
    g.drawImage(src, -src.width/2, -src.height/2);
    return c;
  }

  // ä½ å¯ä»¥è¦–éœ€è¦åŠ é€Ÿï¼šæŠŠå…¨åœ–ç¸®åˆ° maxSideï¼ˆä¾‹å¦‚ 1600ï¼‰å† OCR
  function downscaleIfNeeded(src, maxSide = 2200){
    const w = src.width, h = src.height;
    const max = Math.max(w,h);
    if (max <= maxSide) return src;

    const scale = maxSide / max;
    const c = document.createElement("canvas");
    c.width = Math.max(1, Math.floor(w * scale));
    c.height = Math.max(1, Math.floor(h * scale));
    const g = c.getContext("2d", { willReadFrequently:true });

    g.fillStyle = "#fff";
    g.fillRect(0,0,c.width,c.height);
    g.imageSmoothingEnabled = true;
    g.drawImage(src, 0, 0, c.width, c.height);
    return c;
  }

  function canvasToDataUrlPng(c){ return c.toDataURL("image/png"); }

  async function ensureWorker(){
    if (!window.Tesseract || typeof window.Tesseract.createWorker !== "function"){
      throw new Error("Tesseract.js v7 æœªè¼‰å…¥æˆåŠŸ");
    }
    if (worker) return worker;

    setStatus("åˆå§‹åŒ– OCR worker...");
    worker = await Tesseract.createWorker("eng"); // è‹±æ•¸ç¬¦è™Ÿè¶³å¤ 
    return worker;
  }

  async function runOcrOnCanvas(canvas, angle){
    const w = await ensureWorker();

    // é‡å° GS1 AIï¼šåªå…è¨±å¸¸è¦‹å­—å…ƒï¼Œé™ä½äº‚ç¢¼
    const opts = {
      tessedit_char_whitelist: "0123456789()ABCDEFGHIJKLMNOPQRSTUVWXYZ-",
      tessedit_pageseg_mode: "6" // å¤šå€/å¤šè¡Œé©ç”¨
    };

    const feedUrl = canvasToDataUrlPng(canvas);
    imgFeed.src = feedUrl;

    setStatus(`OCR ä¸­... è§’åº¦ ${angle}Â°`);
    const ret = await w.recognize(feedUrl, opts);

    const raw = ret?.data?.text || "";
    const norm = normalizeTextKeepParens(raw);

    return { norm, confidence: ret?.data?.confidence ?? null };
  }

  async function runFullOcrRotateRegex(){
    resetOutputs();
    setLoading(true);

    try{
      const angles = [0, 90, 180, 270];

      // load base image
      setStatus("è¼‰å…¥åœ–ç‰‡åˆ° canvas...");
      const baseCanvas = await loadImageToCanvas(baseImageDataUrl);

      // å¯é¸ï¼šç¸®åœ–åŠ é€Ÿï¼ˆä½ ä¹Ÿå¯ä»¥æŠŠé€™è¡Œé—œæ‰ï¼‰
      const baseForOcr = downscaleIfNeeded(baseCanvas, 2200);

      // show source pill
      pill.style.display = "inline-block";
      pill.textContent = "MODE: Full Image OCR + Rotate + Regex";

      let bestHit = null;

      for (const deg of angles){
        const rotated = (deg === 0) ? baseForOcr : rotateCanvas(baseForOcr, deg);
        appendLog(`--- ROTATE ${deg}Â° ---`);

        const { norm, confidence } = await runOcrOnCanvas(rotated, deg);
        const comp = compact(norm);

        appendLog(`[CONF] ${confidence}`);
        appendLog(`[LEN ] raw=${norm.length}, compact=${comp.length}`);

        const hit01 = /(?:\(?01\)?)(\d{14})/.test(comp);
        const hit17 = /(?:\(?17\)?)(\d{6})/.test(comp);
        const hit21 = /(?:\(?21\)?)/.test(comp);
        const hit10 = /(?:\(?10\)?)/.test(comp);

        appendLog(`[HIT ] 01=${hit01} 17=${hit17} 21=${hit21} 10=${hit10}`);

        // ä½ è¦çœ‹çš„ raw ç‰‡æ®µï¼ˆé¿å…çˆ†å¤ªé•·ï¼Œä½ ä¹Ÿå¯ç›´æ¥æ”¾å…¨éƒ¨ï¼‰
        appendLog(`[TXT ] ${comp.slice(0, 240)}${comp.length > 240 ? "..." : ""}`);

        if (hit01 && hit17){
          const data = extractGS1(norm);
          bestHit = { deg, norm, confidence, data };
          appendLog(`[PASS] âœ… GS1 core found @ ${deg}Â°`);
          break; // æ‰¾åˆ°å°±åœï¼ˆä½ è¦å…¨è·‘ä¹Ÿå¯æŠŠ break æ‹¿æ‰ï¼‰
        }
      }

      if (bestHit){
        const { deg, confidence, data, norm } = bestHit;

        outGtin.value = data.gtin || "";
        outExp.value = data.exp || "";
        outLot.value = data.lot || "";
        outAngle.value = `${deg}Â° (conf=${confidence})`;

        rawEl.value = norm;

        outHint.textContent =
          (data.gtin && data.exp)
          ? `âœ… æˆåŠŸï¼šæ‰¾åˆ° (01) + (17)ã€‚lot/serial ä»¥ (21) å„ªå…ˆï¼Œæ²’æœ‰æ‰ç”¨ (10)ã€‚`
          : `âš ï¸ æ‰¾åˆ° core ä½†æ¬„ä½ä¸å®Œæ•´ï¼Œè«‹æª¢æŸ¥ RAW OCR æ–‡å­—æ˜¯å¦æ‹¬è™Ÿ/æ•¸å­—è¢«è®€å£ã€‚`;

        setStatus(`å®Œæˆ âœ… å‘½ä¸­è§’åº¦ ${deg}Â°`);
      } else {
        outHint.textContent = "âŒ å…¨éƒ¨è§’åº¦éƒ½æ²’æ‰¾åˆ° (01) + (17)ã€‚é€šå¸¸æ˜¯å­—å¤ªå°ã€åå…‰ã€å°ç„¦ç³Šã€æˆ–åœ–ç‰‡è¢«å£“ç¸®å¤ªåš´é‡ã€‚";
        setStatus("å®Œæˆ âŒ æœªå‘½ä¸­");
      }
    } catch(e){
      console.error(e);
      setStatus("éŒ¯èª¤ï¼š" + (e?.message || e));
    } finally {
      setLoading(false);
    }
  }

  // UI events
  fileInput.addEventListener("change", async (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;

    resetOutputs();
    setStatus("è®€å–åœ–ç‰‡...");
    baseImageDataUrl = await fileToDataUrl(f);
    imgPreview.src = baseImageDataUrl;
    btnRun.disabled = false;
    setStatus("å·²è¼‰å…¥åœ–ç‰‡ï¼ŒæŒ‰ã€Œé–‹å§‹ OCR æ¸¬è©¦ã€");
  });

  btnRun.addEventListener("click", runFullOcrRotateRegex);

  // optional: demo loader (no external URL by default)
  btnLoadDemo.addEventListener("click", () => {
    alert("ç¤ºä¾‹æœªå…§å»ºï¼ˆé¿å…è·¨ç¶²åŸŸï¼‰ã€‚ä½ ç›´æ¥ä¸Šå‚³æ‰‹æ©Ÿæ‹çš„æ¨™ç±¤ç…§ç‰‡æœ€æº–ã€‚");
  });
</script>
</body>
</html>
