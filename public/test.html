<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Sharp + Tesseract Debug æ¸¬è©¦å·¥å…· (è‡ªå‹•ç¸®åœ–ç‰ˆ)</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f2f5; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .debug-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
        .debug-card { border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: #fafafa; }
        .debug-card img { width: 100%; border-radius: 4px; background: #eee; min-height: 100px; }
        .result-box { margin-top: 20px; padding: 15px; background: #eef; border-radius: 8px; border: 2px solid #7360f2; }
        #status { font-weight: bold; color: #7360f2; margin: 10px 0; }
        .log-box { text-align: left; font-size: 12px; background: #333; color: #0f0; padding: 10px; border-radius: 5px; margin-top: 10px; max-height: 100px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ” Sharp + Tesseract è‡ªå‹•ç¸®åœ–æ¸¬è©¦</h2>
    
    <input type="file" id="fileInput" accept="image/*" onchange="processAndUpload()">
    <div id="status">æº–å‚™å°±ç·’</div>
    <div id="log" class="log-box">ç­‰å¾…æ“ä½œ...</div>

    <div class="result-box">
        è¾¨è­˜æ–‡å­—çµæœï¼š<span id="ocrText" style="font-size: 1.4rem;">å°šæœªé–‹å§‹</span>
    </div>

    <div class="debug-grid">
        <div class="debug-card"><b>1. åŸºæœ¬å¢å¼·</b><img id="imgBase"></div>
        <div class="debug-card"><b>2. äºŒå€¼åŒ–</b><img id="imgThreshold"></div>
        <div class="debug-card"><b>3. éŠ³åŒ–</b><img id="imgSharp"></div>
    </div>
</div>

<script>
    const log = (msg) => {
        const box = document.getElementById('log');
        box.innerHTML += `> ${msg}<br>`;
        box.scrollTop = box.scrollHeight;
        console.log(msg);
    };

    async function processAndUpload() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;

        const status = document.getElementById('status');
        status.innerText = "ğŸ”„ æ­£åœ¨å£“ç¸®åœ–ç‰‡...";
        log(`åŸå§‹æª”æ¡ˆå¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`);

        // 1. ä½¿ç”¨ Canvas è‡ªå‹•å£“ç¸®åœ–ç‰‡
        const compressedBase64 = await compressImage(file, 1000); // ç¸®æ¸›å¯¬åº¦åˆ° 1000px
        log(`å£“ç¸®å®Œæˆï¼Œæº–å‚™å‚³é€è‡³ API...`);

        status.innerText = "ğŸ“¡ æ­£åœ¨å‚³é€è‡³ API ä¸¦é€²è¡Œ OCR...";
        
        try {
            const res = await fetch('/api/test-ocr', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: compressedBase64 })
            });

            if (!res.ok) throw new Error(`API éŒ¯èª¤: ${res.status}`);

            const data = await res.json();
            log(`API å›å‚³æˆåŠŸï¼`);

            document.getElementById('ocrText').innerText = data.rawText || "(ç©ºç™½)";
            document.getElementById('imgBase').src = "data:image/jpeg;base64," + data.debugImages.base;
            document.getElementById('imgThreshold').src = "data:image/jpeg;base64," + data.debugImages.threshold;
            document.getElementById('imgSharp').src = "data:image/jpeg;base64," + data.debugImages.sharp;
            
            status.innerText = "âœ… è¾¨è­˜å®Œæˆ";
        } catch (err) {
            log(`âŒ å‡ºéŒ¯äº†: ${err.message}`);
            status.innerText = "âŒ è™•ç†å¤±æ•—";
        }
    }

    // --- æ ¸å¿ƒç¸®åœ– Function ---
    function compressImage(file, maxWidth) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // è¨ˆç®—æ¯”ä¾‹
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;

                    // ç¹ªè£½ç¸®åœ–
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // è½‰ç‚ºè¼ƒå°çš„ Base64 (å“è³ª 0.7)
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            };
        });
    }
</script>

</body>
</html>