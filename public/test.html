<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Sharp + Tesseract æœ¬åœ°è¾¨è­˜æ¸¬è©¦</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f2f5; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .debug-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
        .debug-card { border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: #fafafa; }
        .debug-card img { width: 100%; border-radius: 4px; background: #eee; min-height: 100px; }
        .result-box { margin-top: 20px; padding: 15px; background: #eef; border-radius: 8px; border: 2px solid #7360f2; }
        #status { font-weight: bold; color: #7360f2; margin: 10px 0; }
        .log-box { text-align: left; font-size: 11px; background: #333; color: #0f0; padding: 10px; border-radius: 5px; margin-top: 10px; height: 120px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ” Sharp (å¾Œç«¯) + Tesseract (å‰ç«¯) æ¸¬è©¦</h2>
    
    <input type="file" id="fileInput" accept="image/*" onchange="processAndUpload()">
    <div id="status">æº–å‚™å°±ç·’</div>
    <div id="log" class="log-box">ç­‰å¾…æ“ä½œ...</div>

    <div class="result-box">
        è¾¨è­˜çµæœï¼š<span id="ocrText" style="font-size: 1.4rem; color: #d63384;">å°šæœªè¾¨è­˜</span>
    </div>

    <div class="debug-grid">
        <div class="debug-card"><b>1. åŸå§‹ç¸®åœ–</b><img id="imgBase"></div>
        <div class="debug-card"><b>2. äºŒå€¼åŒ– (OCRç”¨)</b><img id="imgThreshold"></div>
        <div class="debug-card"><b>3. éŠ³åŒ–ç‰ˆæœ¬</b><img id="imgSharp"></div>
    </div>
</div>

<script>
    const log = (msg) => {
        const box = document.getElementById('log');
        box.innerHTML += `> ${new Date().toLocaleTimeString()} ${msg}<br>`;
        box.scrollTop = box.scrollHeight;
    };

    async function processAndUpload() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;

        const status = document.getElementById('status');
        const ocrTextElem = document.getElementById('ocrText');
        
        status.innerText = "ğŸ”„ å½±åƒè™•ç†ä¸­...";
        log("é–‹å§‹å£“ç¸®ä¸¦å‚³é€è‡³ Sharp API...");

        try {
            // 1. å£“ç¸®åœ–ç‰‡
            const compressedBase64 = await compressImage(file, 1000);
            
            // 2. è«‹æ±‚å¾Œç«¯ Sharp è™•ç†
            const res = await fetch('/api/test-ocr', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: compressedBase64 })
            });
            
            if (!res.ok) throw new Error("API æ²’åæ‡‰ï¼Œè«‹ç¢ºèªå¾Œç«¯ Sharp æ˜¯å¦æ­£å¸¸");
            
            const data = await res.json();
            log("API å›å‚³æˆåŠŸï¼Œå½±åƒå·²å¼·åŒ–");

            const threshImgUrl = "data:image/jpeg;base64," + data.debugImages.threshold;
            document.getElementById('imgBase').src = "data:image/jpeg;base64," + data.debugImages.base;
            document.getElementById('imgThreshold').src = threshImgUrl;
            document.getElementById('imgSharp').src = "data:image/jpeg;base64," + data.debugImages.sharp;

            // 3. å‰ç«¯ Tesseract è¾¨è­˜
            status.innerText = "ğŸ§  æœ¬åœ°è¾¨è­˜ä¸­...";
            log("æ­£åœ¨åŠ è¼‰èªè¨€åŒ…: " + window.location.origin + "/tessdata");

            const worker = await Tesseract.createWorker('eng', 1, {
                langPath: window.location.origin + '/tessdata',
                logger: m => {
                    if(m.status === 'recognizing text') {
                        log(`è¾¨è­˜é€²åº¦: ${(m.progress * 100).toFixed(0)}%`);
                    }
                }
            });

            await worker.setParameters({
                tessedit_char_whitelist: '0123456789()ABCDEFGHIJKLMNOPQRSTUVWXYZ-',
                tessedit_pageseg_mode: '7',
            });

            log("åŸ·è¡Œ OCR...");
            const { data: { text } } = await worker.recognize(threshImgUrl);
            
            ocrTextElem.innerText = text.replace(/\s+/g, '') || "æœªåµæ¸¬åˆ°æ–‡å­—";
            status.innerText = "âœ… è¾¨è­˜å®Œæˆ";
            log("è¾¨è­˜æˆåŠŸï¼çµæœå·²é¡¯ç¤º");
            
            await worker.terminate();

        } catch (err) {
            console.error(err);
            log("âŒ éŒ¯èª¤: " + err.message);
            status.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤";
        }
    }

    function compressImage(file, maxWidth) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
            };
        });
    }
</script>

</body>
</html>