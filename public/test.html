<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Sharp + Tesseract Debug æ¸¬è©¦å·¥å…· (è‡ªå‹•ç¸®åœ–ç‰ˆ)</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f2f5; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .debug-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
        .debug-card { border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: #fafafa; }
        .debug-card img { width: 100%; border-radius: 4px; background: #eee; min-height: 100px; }
        .result-box { margin-top: 20px; padding: 15px; background: #eef; border-radius: 8px; border: 2px solid #7360f2; }
        #status { font-weight: bold; color: #7360f2; margin: 10px 0; }
        .log-box { text-align: left; font-size: 12px; background: #333; color: #0f0; padding: 10px; border-radius: 5px; margin-top: 10px; max-height: 100px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ” Sharp + Tesseract è‡ªå‹•ç¸®åœ–æ¸¬è©¦</h2>
    
    <input type="file" id="fileInput" accept="image/*" onchange="processAndUpload()">
    <div id="status">æº–å‚™å°±ç·’</div>
    <div id="log" class="log-box">ç­‰å¾…æ“ä½œ...</div>

    <div class="result-box">
        è¾¨è­˜æ–‡å­—çµæœï¼š<span id="ocrText" style="font-size: 1.4rem;">å°šæœªé–‹å§‹</span>
    </div>

    <div class="debug-grid">
        <div class="debug-card"><b>1. åŸºæœ¬å¢å¼·</b><img id="imgBase"></div>
        <div class="debug-card"><b>2. äºŒå€¼åŒ–</b><img id="imgThreshold"></div>
        <div class="debug-card"><b>3. éŠ³åŒ–</b><img id="imgSharp"></div>
    </div>
</div>

<script>
    const log = (msg) => {
        const box = document.getElementById('log');
        box.innerHTML += `> ${msg}<br>`;
        box.scrollTop = box.scrollHeight;
        console.log(msg);
    };

    // é¦–å…ˆç¢ºä¿ä½ æœ‰å¼•å…¥ Tesseract.js (ç”¨ CDN å³å¯)
// <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    async function processAndUpload() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;

        const status = document.getElementById('status');
        const ocrTextElem = document.getElementById('ocrText');
        status.innerText = "ğŸ”„ æ­£åœ¨è™•ç†å½±åƒ...";
        
        // 1. å…ˆå£“ç¸®ä¸¦å‚³çµ¦ API è®“ Sharp è™•ç† (é€™æ­¥ä½ å·²ç¶“é€šäº†)
        const compressedBase64 = await compressImage(file, 1000);
        
        try {
            const res = await fetch('/api/test-ocr', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: compressedBase64 })
            });
            const data = await res.json();
            
            // é¡¯ç¤º Sharp è™•ç†å¾Œçš„ Debug åœ–
            const baseImgUrl = "data:image/jpeg;base64," + data.debugImages.base;
            const threshImgUrl = "data:image/jpeg;base64," + data.debugImages.threshold;
            document.getElementById('imgBase').src = baseImgUrl;
            document.getElementById('imgThreshold').src = threshImgUrl;
            document.getElementById('imgSharp').src = "data:image/jpeg;base64," + data.debugImages.sharp;

            // 2. åœ¨å‰ç«¯å•Ÿå‹• Tesseract è¾¨è­˜ (ä½¿ç”¨é è¼‰èªè¨€åŒ…)
            status.innerText = "ğŸ§  ç€è¦½å™¨æ­£åœ¨æœ¬åœ°è¾¨è­˜ (ä½¿ç”¨é è¼‰èªè¨€åŒ…)...";
            
            const worker = await Tesseract.createWorker('eng', 1, {
                // é‡é»ï¼šæŒ‡å‘ä½ è‡ªå·±çš„èªè¨€åŒ…è·¯å¾‘
                langPath: window.location.origin + '/tessdata', 
                logger: m => console.log(m)
            });

            await worker.setParameters({
                tessedit_char_whitelist: '0123456789()ABCDEFGHIJKLMNOPQRSTUVWXYZ-',
                tessedit_pageseg_mode: '7',
            });

            // æ‹¿ Sharp è™•ç†å¾Œæœ€ä¹¾æ·¨çš„é‚£å¼µåœ– (Threshold) ä¾†è¾¨è­˜
            const { data: { text } } = await worker.recognize(threshImgUrl);
            
            ocrTextElem.innerText = text.replace(/\s+/g, '');
            status.innerText = "âœ… è¾¨è­˜å®Œæˆ";
            
            await worker.terminate();

        } catch (err) {
            console.error(err);
            status.innerText = "âŒ å¤±æ•—: " + err.message;
        }
    }

    // --- æ ¸å¿ƒç¸®åœ– Function ---
    function compressImage(file, maxWidth) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // è¨ˆç®—æ¯”ä¾‹
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;

                    // ç¹ªè£½ç¸®åœ–
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // è½‰ç‚ºè¼ƒå°çš„ Base64 (å“è³ª 0.7)
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            };
        });
    }
</script>

</body>
</html>