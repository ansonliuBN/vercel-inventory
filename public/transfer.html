<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #f8f9fa; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .loc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .loc-item { background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; }
        select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
        .item-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; gap: 10px; }
        .btn-submit { width: 100%; padding: 16px; background: #007bff; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="card">
        <h3>ğŸšš ç‰©æ–™æ’¥è£œç™¼è²¨</h3>
        
        <div class="loc-grid">
            <div class="loc-item" style="border-left: 5px solid #007bff;">
                <label>ğŸ“¤ <b>ä¾†æºä½ç½®</b> (é è¨­è‡ªå‹•å®šä½)</label>
                <select id="from-loc" onchange="loadFromInventory()"></select>
                <small id="gps-status" style="color: #28a745; font-size: 11px;">å®šä½ä¸­...</small>
            </div>

            <div class="loc-item" style="border-left: 5px solid #28a745;">
                <label>ğŸ“¥ <b>æ’¥è£œç›®æ¨™</b> (è«‹æ‰‹å‹•é¸æ“‡)</label>
                <select id="to-loc">
                    <option value="">-- è«‹é¸æ“‡æ”¶è²¨é†«é™¢ --</option>
                </select>
            </div>
        </div>

        <div id="inventory-list">è«‹é¸æ“‡ä¾†æºä½ç½®ä»¥è®€å–æ¸…å–®...</div>
        
        <button class="btn-submit" onclick="submitTransfer()">ç¢ºèªæ’¥è£œç™¼è²¨</button>
    </div>

<script>
    const fromSel = document.getElementById('from-loc');
    const toSel = document.getElementById('to-loc');

    async function init() {
        const { data: locs } = await _supabase.from('locations').select('*');
        
        // å¡«å…¥æ‰€æœ‰ä¸‹æ‹‰é¸å–®
        locs.forEach(l => {
            fromSel.add(new Option(l.name, l.name));
            toSel.add(new Option(l.name, l.name));
        });

        // 1. ä¾†æºä½ç½®ä½¿ç”¨å…±ç”¨å®šä½åŠŸèƒ½
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const nearest = await window.findNearestLocation(pos.coords.latitude, pos.coords.longitude);
            if (nearest) {
                fromSel.value = nearest.name;
                document.getElementById('gps-status').innerText = "ğŸ“ å·²è‡ªå‹•å®šä½æœ€è¿‘ä½ç½®";
                loadFromInventory();
            }
        }, () => {
            document.getElementById('gps-status').innerText = "âš ï¸ å®šä½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸æ“‡ä¾†æº";
        });
    }

    // 2. è®€å–è©²ä¾†æºåœ°é»ç›®å‰çš„åº«å­˜
    // ä¿®æ”¹ transfer.html è£¡çš„æ¸²æŸ“é‚è¼¯
    async function loadFromInventory() {
        const loc = fromSel.value;
        const { data } = await _supabase.from('inventory_summary').select('*').eq('location', loc);
        
        document.getElementById('inventory-list').innerHTML = data.map(i => `
            <div class="item-row">
                <input type="checkbox" name="move" value="${i.item_uuid}" data-code="${i.product_code}" data-exp="${i.expiry_date || ''}" style="zoom:1.5">
                <div style="flex:1;">
                    <b>${i.friendly_name || i.product_code}</b><br>
                    <small>ç”¢å“: ${i.friendly_name || i.product_code} | åœ¨åº«: ${i.total_stock}</small>
                </div>
                æ•¸é‡: <input type="number" 
                            id="qty-${i.item_uuid}" 
                            value="1" 
                            min="1" 
                            max="${i.total_stock}" 
                            oninput="if(value > ${i.total_stock}) value = ${i.total_stock}; if(value < 1) value = 1;"
                            style="width:60px; padding:5px; border:1px solid #ccc; border-radius:4px;">
            </div>
        `).join('') || "æ­¤åœ°é»ç›®å‰æ²’è²¨";
    }

    // 3. æäº¤æ’¥è£œ
    async function submitTransfer() {
        const checked = document.querySelectorAll('input[name="move"]:checked');
        const source = fromSel.value;
        const target = toSel.value;

        if (!target || source === target) return alert("è«‹é¸æ“‡æ­£ç¢ºçš„æ’¥è£œç›®æ¨™(ä¸”ä¸èƒ½èˆ‡ä¾†æºç›¸åŒ)");
        if (checked.length === 0) return alert("è«‹å‹¾é¸è¦æ’¥è£œçš„ç‰©æ–™");

        for (let el of checked) {
            const uuid = el.value;
            const inputField = document.getElementById('qty-' + uuid);
            const qty = document.getElementById('qty-' + uuid).value;
            const maxQty = parseInt(inputField.max);
            // ğŸ’¡ é—œéµï¼šå¾ checkbox èº«ä¸ŠæŠ“å›åŸæœ¬çš„è³ª
            const originalCode = el.dataset.code; 
            const originalExp = el.dataset.exp;

            if (qty > maxQty) {
                alert(`ã€éŒ¯èª¤ã€‘${uuid} çš„æ’¥è£œæ•¸é‡ (${qty}) è¶…éäº†åœ¨åº«æ•¸é‡ (${maxQty})ï¼`);
                inputField.value = maxQty; // å¹«ä»–æ”¹å›æ­£ç¢ºçš„
                return; // çµ‚æ­¢ç™¼é€
            }
            
            if (qty < 1 || isNaN(qty)) {
                alert(`ã€éŒ¯èª¤ã€‘${uuid} çš„æ•¸é‡ä¸æ­£ç¢ºï¼`);
                return;
            }

            // é€šéæª¢æŸ¥æ‰é–‹å§‹ç™¼é€ API
            if (!confirm(`ç¢ºå®šè¦å¾ ${source} æ’¥è£œ ${checked.length} é …ç‰©æ–™åˆ° ${target} å—ï¼Ÿ`)) return;
            
            await fetch('/api/stock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    item_uuid: uuid,
                    from_loc: source,
                    to_loc: target,
                    quantity: parseInt(qty),
                    operator: localStorage.getItem('user_email'),
                    product_code: originalCode, // å¾æ¨™ç±¤æŠ“å›ä»£ç¢¼
                    expiry_date: originalExp    // å¾æ¨™ç±¤æŠ“å›æ•ˆæœŸ
                })
            });
        }
        alert("æ’¥è£œå®Œæˆï¼");
        location.reload();
    }

    init();
</script>
</body>
</html>