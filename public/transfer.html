<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‰åº«æ’¥è£œ - ç™¼è²¨</title>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #fdfdfd; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .item-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        button { width: 100%; padding: 15px; background: #f2994a; color: white; border: none; border-radius: 5px; font-size: 16px; margin-top: 15px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #statusMsg { margin-top: 15px; padding: 10px; border-radius: 5px; display: none; font-size: 14px; }
        .error-box { background: #fff0f0; border: 1px solid #ff4d4f; color: #ff4d4f; display: block !important; }
        .loading { color: #f2994a; font-weight: bold; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸšš å€‰åº«æ’¥è£œ (å…¬å¸å€‰ç™¼è²¨)</h2>
        <label>ç›®æ¨™åœ°é»ï¼š</label>
        <select id="targetLoc" style="width:100%; padding:10px; margin:10px 0;"></select>

        <div id="stockList">
            <h3>ğŸ“¦ ç¸½å€‰å¾…ç™¼æ¸…å–® (æ•ˆæœŸå„ªå…ˆ)</h3>
            <div id="itemsContainer">è¼‰å…¥ä¸­...</div>
        </div>

        <div id="statusMsg"></div>

        <button id="submitBtn" onclick="submitTransfer()">ç¢ºèªæ’¥è£œé€å‡º</button>
        <button class="back-btn" onclick="location.href='index.html'" style="background:#666;">â¬…ï¸ è¿”å›ç¸½è¡¨</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // é€™è£¡è¦å¡«å…¥ä½ çš„ Supabase è³‡è¨Š (æˆ–å¾ index å¼•å…¥)
        const supabase = window.supabase.createClient('ä½ çš„URL', 'ä½ çš„KEY');

        async function init() {
            try {
                // 1. æŠ“åœ°é»
                const { data: locs, error: lErr } = await supabase.from('locations').select('name');
                if(lErr) throw lErr;

                const select = document.getElementById('targetLoc');
                locs.filter(l => l.name !== 'å…¬å¸ç¸½å€‰').forEach(l => {
                    select.add(new Option(l.name, l.name));
                });

                // 2. æŠ“ç¸½å€‰åœ¨åº«ç‰©æ–™
                const { data: items, error: iErr } = await supabase.from('inventory_summary')
                    .select('*').eq('location', 'å…¬å¸ç¸½å€‰').gt('current_stock', 0)
                    .order('expiry_date', { ascending: true });
                if(iErr) throw iErr;

                document.getElementById('itemsContainer').innerHTML = items.map(i => `
                    <div class="item-row">
                        <input type="checkbox" name="item" value="${i.item_uuid}" data-exp="${i.expiry_date}" data-pcode="${i.product_code}" style="zoom:1.3">
                        <div style="margin-left:10px;">
                            <b>${i.item_uuid.substring(0,12)}</b><br>
                            <small>æ•ˆæœŸ: ${i.expiry_date || 'ç„¡'} | å‰©: ${i.current_stock}</small>
                        </div>
                    </div>
                `).join('') || "ç¸½å€‰ç›®å‰ç„¡è²¨";
            } catch (err) {
                showError("åˆå§‹åŒ–å¤±æ•—: " + err.message);
            }
        }
        
        async function submitTransfer() {
            const target = document.getElementById('targetLoc').value;
            const checked = document.querySelectorAll('input[name="item"]:checked');
            const btn = document.getElementById('submitBtn');
            const status = document.getElementById('statusMsg');

            if(checked.length === 0) return alert("è«‹å‹¾é¸ç‰©æ–™");

            // UI é–å®š
            btn.disabled = true;
            status.innerHTML = "<span class='loading'>ğŸš€ æ’¥è£œè™•ç†ä¸­...</span>";
            status.className = "";
            status.style.display = "block";

            try {
                for(let el of checked) {
                    const res = await fetch('/api/stock', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            item_uuid: el.value,
                            from_loc: 'å…¬å¸ç¸½å€‰',
                            to_loc: target,
                            operator: 'æ¥­å‹™æ’¥è£œ',
                            expiry_date: el.getAttribute('data-exp'), // å¸¶å…¥æ•ˆæœŸ
                            product_code: el.getAttribute('data-pcode') // å¸¶å…¥ä»£ç¢¼
                        })
                    });

                    const result = await res.json();
                    if(!res.ok) {
                        throw new Error(`[${el.value.substring(0,6)}] å¤±æ•—: ${result.message || JSON.stringify(result)}`);
                    }
                }
                alert("âœ… æ’¥è£œæˆåŠŸï¼");
                location.href = 'index.html';
            } catch (err) {
                showError("æ’¥è£œä¸­æ–·ï¼åŸå› ï¼š" + err.message);
                btn.disabled = false;
            }
        }

        function showError(msg) {
            const status = document.getElementById('statusMsg');
            status.innerHTML = `<b>âŒ ç™¼ç”ŸéŒ¯èª¤</b><br><small>${msg}</small>`;
            status.className = "error-box";
            status.style.display = "block";
        }

        init();
    </script>
</body>
</html>