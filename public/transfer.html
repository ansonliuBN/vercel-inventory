<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‰åº«æ’¥è£œ - ç™¼è²¨</title>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #fdfdfd; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .item-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        button { width: 100%; padding: 15px; background: #f2994a; color: white; border: none; border-radius: 5px; font-size: 16px; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸšš å€‰åº«æ’¥è£œ (å…¬å¸å€‰ç™¼è²¨)</h2>
        <label>ç›®æ¨™åœ°é»ï¼š</label>
        <select id="targetLoc" style="width:100%; padding:10px; margin:10px 0;"></select>

        <div id="stockList">
            <h3>ğŸ“¦ ç¸½å€‰å¾…ç™¼æ¸…å–® (æ•ˆæœŸå„ªå…ˆ)</h3>
            <div id="itemsContainer">è¼‰å…¥ä¸­...</div>
        </div>
        <button onclick="submitTransfer()">ç¢ºèªæ’¥è£œé€å‡º</button>
    </div>

    <script>
        // åˆå§‹åŒ–ï¼šæŠ“åœ°é»èˆ‡å…¬å¸å€‰åº«å­˜
        async function init() {
            // 1. æŠ“åœ°é» (æ’é™¤ç¸½å€‰)
            const { data: locs } = await supabase.from('locations').select('name');
            const select = document.getElementById('targetLoc');
            locs.filter(l => l.name !== 'å…¬å¸ç¸½å€‰').forEach(l => {
                select.add(new Option(l.name, l.name));
            });

            // 2. æŠ“ç¸½å€‰åœ¨åº«ç‰©æ–™ (æŒ‰æ•ˆæœŸæ’åº)
            const { data: items } = await supabase.from('inventory_summary')
                .select('*').eq('location', 'å…¬å¸ç¸½å€‰').gt('current_stock', 0)
                .order('expiry_date', { ascending: true });

            document.getElementById('itemsContainer').innerHTML = items.map(i => `
                <div class="item-row">
                    <input type="checkbox" name="item" value="${i.item_uuid}" style="zoom:1.3">
                    <div style="margin-left:10px;">
                        <b>${i.item_uuid.substring(0,12)}</b><br>
                        <small>æ•ˆæœŸ: ${i.expiry_date} | å‰©: ${i.current_stock}</small>
                    </div>
                </div>
            `).join('') || "ç¸½å€‰ç›®å‰ç„¡è²¨";
        }
        
        // é€™è£¡å°±æ˜¯ä½ èªªçš„ã€Œé€å‡ºã€é‚è¼¯
        async function submitTransfer() {
            const target = document.getElementById('targetLoc').value;
            const checked = document.querySelectorAll('input[name="item"]:checked');
            if(checked.length === 0) return alert("è«‹å‹¾é¸ç‰©æ–™");

            for(let el of checked) {
                await fetch('/api/stock', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        item_uuid: el.value,
                        from_loc: 'å…¬å¸ç¸½å€‰',
                        to_loc: target,
                        operator: 'æ¥­å‹™æ’¥è£œ'
                    })
                });
            }
            alert("æ’¥è£œæˆåŠŸï¼");
            location.href = 'index.html';
        }
        init();
    </script>
</body>
</html>