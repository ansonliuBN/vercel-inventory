<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .item-box { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .btn-transfer { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <h3>ğŸšš æ’¥è£œç™¼è²¨ (å¾ æ¥­å‹™å€‰åº«)</h3>
    <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:20px;">
        <label>ğŸ¯ æ’¥è£œç›®çš„åœ°ï¼š</label>
        <select id="to-loc" style="width:100%; padding:10px;"></select>
    </div>

    <div id="warehouse-list">è®€å–æ¥­å‹™å€‰åº«åº«å­˜ä¸­...</div>
    <button class="btn-transfer" onclick="doTransfer()">ç¢ºèªæ’¥è£œ</button>

<script>
    async function init() {
        const { data: locs } = await _supabase.from('locations').select('*');
        const sel = document.getElementById('to-loc');
        locs.forEach(l => sel.add(new Option(l.name, l.name)));

        // åŒæ­¥å®šä½ç›®çš„åœ°
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const nearest = await window.findNearestLocation(pos.coords.latitude, pos.coords.longitude);
            if (nearest) sel.value = nearest.name;
        });

        loadList();
    }

    async function loadList() {
        const { data } = await _supabase.from('inventory_summary').select('*').eq('location', 'æ¥­å‹™å€‰åº«');
        document.getElementById('warehouse-list').innerHTML = data.map(i => `
            <div class="item-box">
                <input type="checkbox" name="move" value="${i.item_uuid}" style="zoom:1.3">
                <div style="flex:1; margin-left:10px;">
                    <b>${i.item_uuid}</b><br><small>åœ¨åº«: ${i.current_stock}</small>
                </div>
                æ•¸é‡: <input type="number" id="qty-${i.item_uuid}" value="1" style="width:40px;">
            </div>
        `).join('') || "æ¥­å‹™å€‰åº«ç›®å‰æ²’è²¨";
    }

    async function doTransfer() {
        const checked = document.querySelectorAll('input[name="move"]:checked');
        const target = document.getElementById('to-loc').value;
        if(checked.length === 0) return alert("è«‹å‹¾é¸ç‰©æ–™");

        for(let el of checked) {
            const qty = document.getElementById('qty-' + el.value).value;
            await fetch('/api/stock', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    item_uuid: el.value, from_loc: 'æ¥­å‹™å€‰åº«', to_loc: target,
                    quantity: parseInt(qty), operator: localStorage.getItem('user_email')
                })
            });
        }
        alert("æ’¥è£œæˆåŠŸï¼");
        location.reload();
    }
    init();
</script>
</body>
</html>