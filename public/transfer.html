<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 15px; background: #f8f9fa; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .loc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .loc-item { background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; }
        select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
        .item-row { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; gap: 10px; }
        .btn-submit { width: 100%; padding: 16px; background: #007bff; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        #inventory-list { max-height: 500px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="card">
        <h3>ğŸšš ç‰©æ–™æ’¥è£œç™¼è²¨ (åºè™Ÿè¿½è¹¤)</h3>
        
        <div class="loc-grid">
            <div class="loc-item" style="border-left: 5px solid #007bff;">
                <label>ğŸ“¤ <b>ä¾†æºä½ç½®</b></label>
                <select id="from-loc" onchange="loadFromInventory()"></select>
            </div>
            <div class="loc-item" style="border-left: 5px solid #28a745;">
                <label>ğŸ“¥ <b>æ’¥è£œç›®æ¨™</b></label>
                <select id="to-loc"></select>
            </div>
        </div>

        <div id="inventory-list">è«‹é¸æ“‡ä¾†æºä½ç½®...</div>
        
        <button class="btn-submit" onclick="submitTransfer()">ç¢ºèªæ’¥è£œç™¼è²¨</button>
    </div>

<script>
    async function init() {
        const { data: locs } = await _supabase.from('locations').select('*');
        const fromSel = document.getElementById('from-loc');
        const toSel = document.getElementById('to-loc');
        
        locs.forEach(l => {
            fromSel.add(new Option(l.name, l.name));
            toSel.add(new Option(l.name, l.name));
        });

        // è‡ªå‹•å®šä½ä¾†æº
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const nearest = await window.findNearestLocation(pos.coords.latitude, pos.coords.longitude);
            if (nearest) {
                fromSel.value = nearest.name;
                loadFromInventory();
            }
        });
    }

    async function loadFromInventory() {
        const loc = document.getElementById('from-loc').value;
        const listDiv = document.getElementById('inventory-list');
        listDiv.innerHTML = "è®€å–ä¸­...";

        // ğŸ’¡ é—œéµï¼šå°æ‡‰ SQL è¦–åœ–ä¸­çš„ current_stock
        const { data, error } = await _supabase.from('inventory_summary').select('*').eq('location', loc);
        
        if (!data || data.length === 0) {
            listDiv.innerHTML = `<p style="color:#999; text-align:center; padding:20px;">æ­¤åœ°é»ç›®å‰ç„¡åœ¨åº«ç‰©æ–™</p>`;
            return;
        }

        listDiv.innerHTML = data.map(i => `
            <div class="item-row">
                <input type="checkbox" name="move" value="${i.item_uuid}" 
                       data-code="${i.product_code || ''}" 
                       data-exp="${i.expiry_date || ''}" 
                       style="zoom:1.5">
                <div style="flex:1;">
                    <b>${i.friendly_name || i.product_code}</b><br>
                    <small style="color:#666;">SN: ${i.item_uuid} | æ•ˆæœŸ: ${i.expiry_date || '-'}</small><br>
                    <small style="color:#007bff;">ç›®å‰åœ¨åº«: ${i.current_stock}</small> </div>
                æ•¸é‡: <input type="number" id="qty-${i.item_uuid}" value="1" min="1" max="${i.current_stock}" 
                            oninput="if(value > ${i.current_stock}) value = ${i.current_stock}; if(value < 1) value = 1;"
                            style="width:50px; padding:5px; border-radius:4px; border:1px solid #ddd;">
            </div>
        `).join('');
    }

    async function submitTransfer() {
        const checked = document.querySelectorAll('input[name="move"]:checked');
        const source = document.getElementById('from-loc').value;
        const target = document.getElementById('to-loc').value;

        if (checked.length === 0) return alert("è«‹å‹¾é¸ç‰©æ–™");
        if (!target || source === target) return alert("è«‹é¸æ“‡æ­£ç¢ºçš„ç›®æ¨™åœ°é»");

        if (!confirm(`ç¢ºå®šæ’¥è£œé€™ ${checked.length} é …ç‰©æ–™å—ï¼Ÿ`)) return;

        for (let el of checked) {
            const uuid = el.value;
            const qty = document.getElementById('qty-' + uuid).value;
            
            // ğŸ’¡ æŠ“å– checkbox èº«ä¸Šå¸¶è‘—çš„ã€Œè³ªã€
            const product_code = el.dataset.code;
            const expiry_date = el.dataset.exp;

            await fetch('/api/stock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    item_uuid: uuid,
                    from_loc: source,
                    to_loc: target,
                    quantity: parseInt(qty),
                    product_code,
                    expiry_date,
                    operator: localStorage.getItem('user_email')
                })
            });
        }
        alert("æ’¥è£œå®Œæˆï¼");
        location.reload();
    }
    init();
</script>
</body>
</html>