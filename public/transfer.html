<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #fff; }
        .card { border: 1px solid #ddd; padding: 20px; border-radius: 12px; }
        .item-card { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; gap: 10px; }
        .btn-go { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="card">
        <h3>ğŸšš æ’¥è£œç™¼è²¨ (å¾ æ¥­å‹™å€‰åº« å‡ºè²¨)</h3>
        
        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
            <label>ğŸ“ ç›®æ¨™æ’¥è£œåœ°é»ï¼š</label>
            <select id="to-loc" style="width:100%; padding:8px;"></select>
        </div>

        <div id="warehouse-list">è¼‰å…¥æ¥­å‹™å€‰åº«ç‰©æ–™ä¸­...</div>
        
        <button class="btn-go" onclick="submitTransfer()">ç¢ºèªæ’¥è£œ</button>
    </div>

<script>
    async function init() {
        const { data: locs } = await _supabase.from('locations').select('*');
        const sel = document.getElementById('to-loc');
        locs.forEach(l => sel.add(new Option(l.name, l.name)));

        // å®šä½ç›®å‰é†«é™¢
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const nearest = locs.map(l => ({ ...l, d: Math.pow(l.lat-pos.coords.latitude,2)+Math.pow(l.lng-pos.coords.longitude,2) })).sort((a,b)=>a.d-b.d)[0];
            if(nearest) sel.value = nearest.name;
        });

        loadWarehouse();
    }

    async function loadWarehouse() {
        // åªæŠ“ æ¥­å‹™å€‰åº« çš„æ±è¥¿
        const { data } = await _supabase.from('inventory_summary').select('*').eq('location', 'æ¥­å‹™å€‰åº«').gt('current_stock', 0);
        
        document.getElementById('warehouse-list').innerHTML = data.map(i => `
            <div class="item-card">
                <input type="checkbox" name="move" value="${i.item_uuid}" data-code="${i.product_code}" style="zoom:1.5">
                <div style="flex:1;">
                    <b>${i.item_uuid}</b><br>
                    <small>åœ¨åº«ï¼š${i.current_stock} | æ•ˆæœŸï¼š${i.expiry_date}</small>
                </div>
                <input type="number" name="qty-${i.item_uuid}" value="1" min="1" max="${i.current_stock}" style="width:50px;">
            </div>
        `).join('') || "æ¥­å‹™å€‰åº«ç›®å‰æ²’è²¨";
    }

    async function submitTransfer() {
        const checked = document.querySelectorAll('input[name="move"]:checked');
        const target = document.getElementById('to-loc').value;
        if(checked.length === 0) return alert("è«‹å‹¾é¸è¦æ’¥è£œçš„ç‰©æ–™");

        for(let el of checked) {
            const uuid = el.value;
            const qty = document.getElementsByName('qty-'+uuid)[0].value;
            
            await fetch('/api/stock', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    item_uuid: uuid,
                    from_loc: 'æ¥­å‹™å€‰åº«',
                    to_loc: target,
                    quantity: parseInt(qty),
                    operator: localStorage.getItem('user_email')
                })
            });
        }
        alert("æ’¥è£œå®Œæˆï¼"); location.reload();
    }
    init();
</script>
</body>
</html>